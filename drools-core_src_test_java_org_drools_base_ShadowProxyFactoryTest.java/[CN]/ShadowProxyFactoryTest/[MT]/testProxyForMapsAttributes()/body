{
  try {
    Person bob=new Person("bob",30);
    Address addr1=new Address("street 1","111","11-1111-1111");
    Address addr2=new Address("street 2","222","22-2222-2222");
    Address addr3=new Address("street 3","333","33-3333-3333");
    Address addr4=new Address("street 4","444","44-4444-4444");
    Map addresses=new HashMap();
    addresses.put("home",addr1);
    addresses.put("business",addr2);
    bob.setAddresses(addresses);
    final Class proxy=ShadowProxyFactory.getProxy(bob.getClass());
    final Person bobProxy=(Person)proxy.getConstructor(new Class[]{bob.getClass()}).newInstance(new Object[]{bob});
    ((ShadowProxy)bobProxy).setShadowedObject(bob);
    Assert.assertEquals(bob.getAddresses().get("business"),bobProxy.getAddresses().get("business"));
    Assert.assertSame(bob,((ShadowProxy)bobProxy).getShadowedObject());
    Assert.assertEquals(bobProxy,bob);
    bob.getAddresses().remove("business");
    bob.getAddresses().put("parents",addr3);
    bob.getAddresses().put("home",addr4);
    Assert.assertTrue(bobProxy.getAddresses().containsKey("business"));
    Assert.assertFalse(bobProxy.getAddresses().containsKey("parents"));
    Assert.assertEquals(addr1,bobProxy.getAddresses().get("home"));
    ((ShadowProxy)bobProxy).updateProxy();
    Assert.assertFalse(bobProxy.getAddresses().containsKey("business"));
    Assert.assertTrue(bobProxy.getAddresses().containsKey("parents"));
    Assert.assertEquals(addr4,bobProxy.getAddresses().get("home"));
    Assert.assertEquals(bobProxy,bob);
  }
 catch (  final Exception e) {
    e.printStackTrace();
    fail("Error: " + e.getMessage());
  }
}
