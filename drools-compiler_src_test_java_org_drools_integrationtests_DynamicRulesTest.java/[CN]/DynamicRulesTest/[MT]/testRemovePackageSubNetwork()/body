{
  KnowledgeBase kbase=loadKnowledgeBase("test_DynamicRulesWithSubnetwork.drl");
  String packageName=kbase.getKnowledgePackages().iterator().next().getName();
  StatefulKnowledgeSession workingMemory=createKnowledgeSession(kbase);
  List<?> results=new ArrayList<Object>();
  workingMemory.setGlobal("results",results);
  Order order=new Order();
  OrderItem item1=new OrderItem(order,1,"Adventure Guide Brazil",OrderItem.TYPE_BOOK,24);
  OrderItem item2=new OrderItem(order,2,"Prehistoric Britain",OrderItem.TYPE_BOOK,15);
  OrderItem item3=new OrderItem(order,3,"Holiday Music",OrderItem.TYPE_CD,9);
  OrderItem item4=new OrderItem(order,4,"Very Best of Mick Jagger",OrderItem.TYPE_CD,11);
  OrderItem item5=new OrderItem(order,5,"The Master and Margarita",OrderItem.TYPE_BOOK,29);
  order.addItem(item1);
  order.addItem(item2);
  order.addItem(item3);
  order.addItem(item4);
  order.addItem(item5);
  workingMemory.insert(order);
  workingMemory.fireAllRules();
  assertEquals(1,results.size());
  assertEquals(3,((List)results.get(0)).size());
  results.clear();
  KnowledgeBase ruleBaseWM=workingMemory.getKnowledgeBase();
  ruleBaseWM.removeKnowledgePackage(packageName);
  Collection<KnowledgePackage> kpkgs=loadKnowledgePackages("test_DynamicRulesWithSubnetwork.drl");
  ruleBaseWM.addKnowledgePackages(SerializationHelper.serializeObject(kpkgs));
  workingMemory.fireAllRules();
  results=(List)workingMemory.getGlobal("results");
  assertEquals(1,results.size());
  assertEquals(3,((List)results.get(0)).size());
  results.clear();
  ruleBaseWM.removeKnowledgePackage(packageName);
  ruleBaseWM.addKnowledgePackages(SerializationHelper.serializeObject(kpkgs));
  workingMemory.fireAllRules();
  assertEquals(1,results.size());
  assertEquals(3,((List)results.get(0)).size());
  results.clear();
  ruleBaseWM.removeKnowledgePackage(packageName);
  ruleBaseWM.addKnowledgePackages(SerializationHelper.serializeObject(kpkgs));
  workingMemory.fireAllRules();
  assertEquals(1,results.size());
  assertEquals(3,((List)results.get(0)).size());
  results.clear();
}
