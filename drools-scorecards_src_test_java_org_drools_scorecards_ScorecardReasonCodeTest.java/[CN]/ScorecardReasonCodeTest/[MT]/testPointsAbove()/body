{
  ScorecardCompiler scorecardCompiler=new ScorecardCompiler(INTERNAL_DECLARED_TYPES);
  scorecardCompiler.compileFromExcel(PMMLDocumentTest.class.getResourceAsStream("/scoremodel_reasoncodes.xls"),"scorecards_pointsAbove");
  assertEquals(0,scorecardCompiler.getScorecardParseErrors().size());
  String drl=scorecardCompiler.getDRL();
  assertNotNull(drl);
  KnowledgeBuilder kbuilder=KnowledgeBuilderFactory.newKnowledgeBuilder();
  kbuilder.add(ResourceFactory.newByteArrayResource(drl.getBytes()),ResourceType.DRL);
  for (  KnowledgeBuilderError error : kbuilder.getErrors()) {
    System.out.println(error.getMessage());
  }
  assertFalse(kbuilder.hasErrors());
  KnowledgeBase kbase=KnowledgeBaseFactory.newKnowledgeBase();
  kbase.addKnowledgePackages(kbuilder.getKnowledgePackages());
  StatefulKnowledgeSession session=kbase.newStatefulKnowledgeSession();
  FactType scorecardType=kbase.getFactType("org.drools.scorecards.example","SampleScore");
  DroolsScorecard scorecard=(DroolsScorecard)scorecardType.newInstance();
  scorecardType.set(scorecard,"age",10);
  session.insert(scorecard);
  session.fireAllRules();
  session.dispose();
  assertEquals(29.0,scorecard.getCalculatedScore(),0.0);
  assertEquals(2,scorecard.getReasonCodes().size());
  assertEquals(0,scorecard.getReasonCodes().indexOf("VL002"));
  assertEquals(-1,scorecard.getReasonCodes().indexOf("AGE02"));
  assertEquals(1,scorecard.getReasonCodes().lastIndexOf("VL002"));
  session=kbase.newStatefulKnowledgeSession();
  scorecard=(DroolsScorecard)scorecardType.newInstance();
  scorecardType.set(scorecard,"age",0);
  scorecardType.set(scorecard,"occupation","SKYDIVER");
  session.insert(scorecard);
  session.fireAllRules();
  session.dispose();
  assertTrue(-1 == scorecard.getCalculatedScore());
  assertEquals(3,scorecard.getReasonCodes().size());
  assertEquals(0,scorecard.getReasonCodes().indexOf("OCC01"));
  assertTrue("VL002".equalsIgnoreCase(scorecard.getReasonCodes().get(1)));
  assertTrue("VL002".equalsIgnoreCase(scorecard.getReasonCodes().get(2)));
  assertEquals(-1,scorecard.getReasonCodes().indexOf("AGE01"));
  session=kbase.newStatefulKnowledgeSession();
  scorecard=(DroolsScorecard)scorecardType.newInstance();
  scorecardType.set(scorecard,"age",20);
  scorecardType.set(scorecard,"occupation","TEACHER");
  scorecardType.set(scorecard,"residenceState","AP");
  scorecardType.set(scorecard,"validLicense",true);
  session.insert(scorecard);
  session.fireAllRules();
  session.dispose();
  assertEquals(41.0,scorecard.getCalculatedScore(),0.0);
  assertEquals(4,scorecard.getReasonCodes().size());
  assertEquals(-1,scorecard.getReasonCodes().indexOf("OCC02"));
  assertEquals(-1,scorecard.getReasonCodes().indexOf("AGE03"));
  assertEquals(-1,scorecard.getReasonCodes().indexOf("VL001"));
  assertEquals("RS001",scorecard.getReasonCodes().get(0));
  assertEquals("RS001",scorecard.getReasonCodes().get(1));
  assertEquals("RS001",scorecard.getReasonCodes().get(2));
  assertEquals("RS001",scorecard.getReasonCodes().get(3));
}
