{
  StringTokenizer st=new StringTokenizer(source,"\r\n");
  while (st.hasMoreTokens()) {
    lineNumber++;
    String raw=st.nextToken();
    String line=raw.trim();
    if (matchesKeyword("when",line)) {
      lhs();
      appendLine(raw);
    }
 else     if (matchesKeyword("then",line)) {
      rhs();
      appendLine(raw);
    }
 else     if (matchesKeyword("end",line)) {
      endRule();
      appendLine(raw);
      output.append("\n");
    }
 else     if (matchesKeyword("query",line)) {
      query();
      appendLine(raw);
    }
 else {
      consume(raw);
    }
  }
  return output.toString();
}
