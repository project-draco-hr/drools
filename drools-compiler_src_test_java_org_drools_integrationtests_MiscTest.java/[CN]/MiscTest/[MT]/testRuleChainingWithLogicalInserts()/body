{
  KnowledgeBuilder kbuilder=KnowledgeBuilderFactory.newKnowledgeBuilder();
  kbuilder.add(ResourceFactory.newClassPathResource("test_RuleChaining.drl",getClass()),ResourceType.DRL);
  KnowledgeBuilderErrors errors=kbuilder.getErrors();
  if (errors.size() > 0) {
    for (    KnowledgeBuilderError error : errors) {
      logger.warn(error.toString());
    }
    throw new IllegalArgumentException("Could not parse knowledge.");
  }
  assertFalse(kbuilder.hasErrors());
  KnowledgeBase kbase=KnowledgeBaseFactory.newKnowledgeBase();
  kbase.addKnowledgePackages(kbuilder.getKnowledgePackages());
  StatefulKnowledgeSession ksession=createKnowledgeSession(kbase);
  org.drools.event.rule.WorkingMemoryEventListener wml=Mockito.mock(org.drools.event.rule.WorkingMemoryEventListener.class);
  org.drools.event.rule.AgendaEventListener ael=Mockito.mock(org.drools.event.rule.AgendaEventListener.class);
  ksession.addEventListener(wml);
  ksession.addEventListener(ael);
  int fired=ksession.fireAllRules();
  assertEquals(3,fired);
  ArgumentCaptor<org.drools.event.rule.AfterActivationFiredEvent> actvs=ArgumentCaptor.forClass(org.drools.event.rule.AfterActivationFiredEvent.class);
  verify(ael,times(3)).afterActivationFired(actvs.capture());
  List<org.drools.event.rule.AfterActivationFiredEvent> values=actvs.getAllValues();
  assertThat(values.get(0).getActivation().getRule().getName(),is("init"));
  assertThat(values.get(1).getActivation().getRule().getName(),is("r1"));
  assertThat(values.get(2).getActivation().getRule().getName(),is("r2"));
  verify(ael,never()).activationCancelled(any(org.drools.event.rule.ActivationCancelledEvent.class));
  verify(wml,times(2)).objectInserted(any(org.drools.event.rule.ObjectInsertedEvent.class));
  verify(wml,never()).objectRetracted(any(org.drools.event.rule.ObjectRetractedEvent.class));
}
