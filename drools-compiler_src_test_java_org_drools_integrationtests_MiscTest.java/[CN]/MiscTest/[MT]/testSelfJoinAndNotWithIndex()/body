{
  String drl="";
  drl+="package org.test\n";
  drl+="import org.kie.Person\n";
  drl+="global java.util.List list\n";
  drl+="rule test1\n";
  drl+="when\n";
  drl+="   $p1 : Person( )\n";
  drl+="     not Person( name == $p1.name, age < $p1.age )\n";
  drl+="   $p2 : Person( name == $p1.name, likes != $p1.likes, age > $p1.age)\n";
  drl+="     not Person( name == $p1.name, likes == $p2.likes, age < $p2.age )\n";
  drl+="then\n";
  drl+="    System.out.println( $p1 + \":\" + $p2 );\n";
  drl+="    list.add( $p1 );\n";
  drl+="    list.add( $p2 );\n";
  drl+="end\n";
  KnowledgeBase kbase=SerializationHelper.serializeObject(loadKnowledgeBaseFromString(drl));
  StatefulKnowledgeSession ksession=createKnowledgeSession(kbase);
  List list=new ArrayList();
  ksession.setGlobal("list",list);
  Person p0=new Person("yoda",0);
  p0.setLikes("cheddar");
  org.kie.runtime.rule.FactHandle fh0=ksession.insert(p0);
  Person p1=new Person("darth",15);
  p1.setLikes("cheddar");
  org.kie.runtime.rule.FactHandle fh1=ksession.insert(p1);
  Person p2=new Person("darth",25);
  p2.setLikes("cheddar");
  org.kie.runtime.rule.FactHandle fh2=ksession.insert(p2);
  Person p3=new Person("darth",30);
  p3.setLikes("brie");
  org.kie.runtime.rule.FactHandle fh3=ksession.insert(p3);
  ksession.fireAllRules();
  assertEquals(2,list.size());
  assertSame(p1,list.get(0));
  assertSame(p3,list.get(1));
  p1.setName("yoda");
  ksession.update(fh1,p1);
  ksession.fireAllRules();
  assertEquals(4,list.size());
  assertSame(p2,list.get(2));
  assertSame(p3,list.get(3));
}
