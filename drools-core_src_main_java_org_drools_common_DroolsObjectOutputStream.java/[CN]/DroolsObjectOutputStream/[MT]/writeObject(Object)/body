{
  if (object == null) {
    dataOutput.writeByte(RT_NULL);
  }
 else {
    Class clazz=object.getClass();
    if (clazz == EMPTY_SET_CLASS) {
      dataOutput.writeByte(RT_EMPTY_SET);
    }
 else     if (clazz == EMPTY_LIST_CLASS) {
      dataOutput.writeByte(RT_EMPTY_LIST);
    }
 else     if (clazz == EMPTY_MAP_CLASS) {
      dataOutput.writeByte(RT_EMPTY_MAP);
    }
 else {
      if (clazz == String.class)       object=((String)object).intern();
      int handle=registerObject(object);
      if (handle < 0) {
        handle=-handle;
        if (Externalizable.class.isAssignableFrom(clazz)) {
          dataOutput.writeByte(RT_EXTERNALIZABLE);
          dataOutput.writeInt(handle);
          writeObject(clazz);
          ((Externalizable)object).writeExternal(this);
        }
 else         if (Map.class.isAssignableFrom(clazz)) {
          Map map=(Map)object;
          dataOutput.writeByte(RT_MAP);
          dataOutput.writeInt(handle);
          writeObject(clazz);
          dataOutput.writeInt(map.size());
          for (          Object obj : map.entrySet()) {
            Map.Entry entry=(Map.Entry)obj;
            writeObject(entry.getKey());
            writeObject(entry.getValue());
          }
        }
 else         if (clazz.isArray()) {
          dataOutput.writeByte(RT_ARRAY);
          dataOutput.writeInt(handle);
          writeObject(clazz);
          Class componentType=clazz.getComponentType();
          if (componentType.isPrimitive()) {
            writePrimitiveArray(object,componentType);
          }
 else {
            Object[] array=(Object[])object;
            int length=array.length;
            dataOutput.writeInt(length);
            for (int i=0; i < length; ++i) {
              writeObject(array[i]);
            }
          }
        }
 else         if (Collection.class.isAssignableFrom(clazz)) {
          Collection collection=(Collection)object;
          dataOutput.writeByte(RT_COLLECTION);
          dataOutput.writeInt(handle);
          writeObject(clazz);
          dataOutput.writeInt(collection.size());
          for (          Object obj : collection) {
            writeObject(obj);
          }
        }
 else         if (String.class.isAssignableFrom(clazz)) {
          writeString((String)object,handle);
        }
 else         if (clazz == Class.class) {
          writeClass((Class)object,handle);
        }
 else         if (AtomicReferenceArray.class.isAssignableFrom(clazz)) {
          AtomicReferenceArray array=(AtomicReferenceArray)object;
          dataOutput.writeByte(RT_ATOMICREFERENCEARRAY);
          dataOutput.writeInt(handle);
          dataOutput.writeInt(array.length());
          for (int i=0; i < array.length(); i++)           writeObject(array.get(i));
        }
 else         if (Serializable.class.isAssignableFrom(clazz)) {
          dataOutput.writeByte(RT_SERIALIZABLE);
          dataOutput.writeInt(handle);
          dataOutput.writeObject(object);
        }
 else {
          throw new NotSerializableException("Unsupported class: " + clazz);
        }
      }
 else {
        dataOutput.writeByte(RT_REFERENCE);
        dataOutput.writeInt(handle);
      }
    }
  }
  dataOutput.flush();
}
