{
  EntityManager externalCmdScopedEntityManager=(EntityManager)this.env.get(EnvironmentName.CMD_SCOPED_ENTITY_MANAGER);
  EntityManager internalCmdScopedEntityManager=getInternalCommandScopedEntityManager();
  EntityManager cmdScopedEntityManager;
  boolean openInternalCSEM=internalCmdScopedEntityManager != null && internalCmdScopedEntityManager.isOpen();
  if (openInternalCSEM || (externalCmdScopedEntityManager != null && externalCmdScopedEntityManager.isOpen())) {
    if (internalCmdScopedEntityManager != null) {
      cmdScopedEntityManager=internalCmdScopedEntityManager;
    }
 else {
      internalCmdScopedEntityManagerFlag=false;
      cmdScopedEntityManager=externalCmdScopedEntityManager;
      setInternalCommandScopedEntityManager(externalCmdScopedEntityManager);
    }
  }
 else {
    internalCmdScopedEntityManagerFlag=true;
    internalCmdScopedEntityManager=this.emf.createEntityManager();
    setInternalCommandScopedEntityManager(internalCmdScopedEntityManager);
    internalCmdScopedEntityManager.setFlushMode(FlushModeType.COMMIT);
    cmdScopedEntityManager=internalCmdScopedEntityManager;
  }
  cmdScopedEntityManager.joinTransaction();
  appScopedEntityManager.joinTransaction();
}
