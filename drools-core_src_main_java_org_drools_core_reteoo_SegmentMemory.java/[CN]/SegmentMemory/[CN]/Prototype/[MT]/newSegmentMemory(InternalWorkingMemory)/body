{
  SegmentMemory smem=new SegmentMemory(rootNode);
  smem.tipNode=tipNode;
  smem.linkedNodeMask=new AtomicBitwiseLong(linkedNodeMask);
  smem.allLinkedMaskTest=allLinkedMaskTest;
  smem.segmentPosMaskBit=segmentPosMaskBit;
  smem.pos=pos;
  int i=0;
  for (  NetworkNode node : getNodesInSegment(smem)) {
    Memory mem=wm.getNodeMemory((MemoryFactory)node);
    mem.setSegmentMemory(smem);
    smem.getNodeMemories().add(mem);
    MemoryPrototype proto=memories.get(i++);
    if (proto != null) {
      proto.populateMemory(wm,mem);
    }
  }
  if (hasQueue && smem.getStreamQueue() == null) {
    StreamTupleEntryQueue queue=SegmentUtilities.initAndGetTupleQueue(smem.getTipNode(),wm);
    smem.setStreamQueue(queue);
  }
  if (hasSyncStagedLeftTuple) {
    smem.setStagedTuples(new SynchronizedLeftTupleSets());
  }
  return smem;
}
