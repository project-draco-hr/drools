{
  String drl="declare Integer @role(event) end\n" + "declare Long @role(event) end\n" + "global java.util.List list\n"+ "\n"+ "rule R1 when\n"+ " $long : Long()\n"+ " $i : Integer( this > $long )\n"+ "then\n"+ " list.add($i);\n"+ "end\n"+ "\n"+ "rule R2 when\n"+ " $i : Integer( this > 3 )\n"+ "then\n"+ " retract( $i );\n"+ "end";
  KnowledgeBuilder kbuilder=KnowledgeBuilderFactory.newKnowledgeBuilder();
  kbuilder.add(ResourceFactory.newByteArrayResource(drl.getBytes()),ResourceType.DRL);
  if (kbuilder.hasErrors()) {
    fail(kbuilder.getErrors().toString());
  }
  KieBaseConfiguration baseConfig=KnowledgeBaseFactory.newKnowledgeBaseConfiguration();
  baseConfig.setOption(EventProcessingOption.STREAM);
  KnowledgeBase kbase=KnowledgeBaseFactory.newKnowledgeBase(baseConfig);
  kbase.addKnowledgePackages(kbuilder.getKnowledgePackages());
  KieSession ksession=kbase.newKieSession();
  List<Integer> list=new ArrayList<Integer>();
  ksession.setGlobal("list",list);
  for (int i=0; i < 10; i++) {
    ksession.insert(new Integer(i));
    ksession.fireAllRules();
  }
  ((DefaultAgenda)ksession.getAgenda()).getGarbageCollector().forceGcUnlinkedRules();
  Rete rete=((KnowledgeBaseImpl)kbase).getRete();
  JoinNode joinNode=null;
  for (  ObjectTypeNode otn : rete.getObjectTypeNodes()) {
    if (Integer.class == otn.getObjectType().getValueType().getClassType()) {
      joinNode=(JoinNode)otn.getSinkPropagator().getSinks()[0];
      break;
    }
  }
  assertNotNull(joinNode);
  InternalWorkingMemory wm=(InternalWorkingMemory)ksession;
  BetaMemory memory=(BetaMemory)wm.getNodeMemory(joinNode);
  assertEquals(0,memory.getSegmentMemory().getStreamQueue().size());
  RightTupleSets stagedRightTuples=memory.getStagedRightTuples();
  assertEquals(0,stagedRightTuples.deleteSize());
  assertEquals(4,stagedRightTuples.insertSize());
  ksession.insert(new Long(0));
  ksession.fireAllRules();
  assertEquals(3,list.size());
  assertTrue(list.containsAll(Arrays.asList(1,2,3)));
}
