{
  ClassWriter cw=new ClassWriter(0);
  FieldVisitor fv;
  MethodVisitor mv;
  long mask=traitRegistry.getFieldMask(getTrait().getName(),core.getDefinedClass().getName());
  String name=TraitFactory.getPropertyWrapperName(getTrait(),core);
  String masterName=TraitFactory.getProxyName(getTrait(),core);
  String internalWrapper=BuildUtils.getInternalType(name);
  String internalProxy=BuildUtils.getInternalType(masterName);
  String descrCore=Type.getDescriptor(core.getDefinedClass());
  String internalCore=Type.getInternalName(core.getDefinedClass());
  String internalTrait=Type.getInternalName(getTrait().getDefinedClass());
  Class mixinClass=null;
  String mixin=null;
  Set<Method> mixinMethods=new HashSet<Method>();
  Map<String,Method> mixinGetSet=new HashMap<String,Method>();
  try {
    if (getTrait().getDefinedClass() != null) {
      Trait annTrait=getAnnotation(getTrait().getDefinedClass(),Trait.class);
      if (hasImpl(annTrait)) {
        mixinClass=annTrait.impl();
        mixin=mixinClass.getSimpleName().substring(0,1).toLowerCase() + mixinClass.getSimpleName().substring(1);
        ClassFieldInspector cfi=new ClassFieldInspector(mixinClass);
        for (        Method m : mixinClass.getMethods()) {
          try {
            getTrait().getDefinedClass().getMethod(m.getName(),m.getParameterTypes());
            if (cfi.getGetterMethods().containsValue(m) || cfi.getSetterMethods().containsValue(m)) {
              mixinGetSet.put(m.getName(),m);
            }
 else {
              mixinMethods.add(m);
            }
          }
 catch (          NoSuchMethodException e) {
          }
        }
      }
    }
  }
 catch (  Exception e) {
    e.printStackTrace();
  }
  cw.visit(V1_5,ACC_PUBLIC + ACC_SUPER,internalProxy,null,Type.getInternalName(proxyBaseClass),new String[]{internalTrait,Type.getInternalName(Serializable.class)});
{
    fv=cw.visitField(ACC_PUBLIC + ACC_FINAL,"object",descrCore,null,null);
    fv.visitEnd();
  }
{
    fv=cw.visitField(ACC_PUBLIC + ACC_FINAL,"map",Type.getDescriptor(Map.class),"Ljava/util/Map<Ljava/lang/String;Ljava/lang/Object;>;",null);
    fv.visitEnd();
  }
  if (mixinClass != null) {
{
      fv=cw.visitField(ACC_PRIVATE,mixin,BuildUtils.getTypeDescriptor(mixinClass.getName()),null,null);
      fv.visitEnd();
    }
  }
{
    mv=cw.visitMethod(ACC_PUBLIC,"<init>","()V",null,null);
    mv.visitCode();
    mv.visitVarInsn(ALOAD,0);
    mv.visitMethodInsn(INVOKESPECIAL,Type.getInternalName(proxyBaseClass),"<init>","()V");
    mv.visitInsn(RETURN);
    mv.visitMaxs(1,1);
    mv.visitEnd();
  }
{
    mv=cw.visitMethod(ACC_PUBLIC,"<init>","(" + descrCore + Type.getDescriptor(Map.class)+ ")V","(" + descrCore + "Ljava/util/Map<Ljava/lang/String;Ljava/lang/Object;>;)V",null);
    mv.visitCode();
    mv.visitVarInsn(ALOAD,0);
    mv.visitMethodInsn(INVOKESPECIAL,Type.getInternalName(proxyBaseClass),"<init>","()V");
    mv.visitVarInsn(ALOAD,2);
    Label l0=new Label();
    mv.visitJumpInsn(IFNONNULL,l0);
    mv.visitTypeInsn(NEW,Type.getInternalName(HashMap.class));
    mv.visitInsn(DUP);
    mv.visitMethodInsn(INVOKESPECIAL,Type.getInternalName(HashMap.class),"<init>","()V");
    mv.visitVarInsn(ASTORE,2);
    mv.visitLabel(l0);
    if (mixinClass != null) {
      try {
        Class actualArg=getPossibleConstructor(mixinClass,trait.getDefinedClass());
        mv.visitVarInsn(ALOAD,0);
        mv.visitTypeInsn(NEW,Type.getInternalName(mixinClass));
        mv.visitInsn(DUP);
        mv.visitVarInsn(ALOAD,0);
        mv.visitMethodInsn(INVOKESPECIAL,Type.getInternalName(mixinClass),"<init>","(" + Type.getDescriptor(actualArg) + ")V");
        mv.visitFieldInsn(PUTFIELD,internalProxy,mixin,Type.getDescriptor(mixinClass));
      }
 catch (      NoSuchMethodException nsme) {
        mv.visitVarInsn(ALOAD,0);
        mv.visitTypeInsn(NEW,Type.getInternalName(mixinClass));
        mv.visitInsn(DUP);
        mv.visitMethodInsn(INVOKESPECIAL,Type.getInternalName(mixinClass),"<init>","()V");
        mv.visitFieldInsn(PUTFIELD,internalProxy,mixin,Type.getDescriptor(mixinClass));
      }
    }
    mv.visitVarInsn(ALOAD,0);
    mv.visitVarInsn(ALOAD,1);
    mv.visitFieldInsn(PUTFIELD,internalProxy,"object",descrCore);
    mv.visitVarInsn(ALOAD,0);
    mv.visitVarInsn(ALOAD,2);
    mv.visitFieldInsn(PUTFIELD,internalProxy,"map",Type.getDescriptor(Map.class));
    mv.visitVarInsn(ALOAD,0);
    mv.visitTypeInsn(NEW,internalWrapper);
    mv.visitInsn(DUP);
    mv.visitVarInsn(ALOAD,1);
    mv.visitVarInsn(ALOAD,2);
    mv.visitMethodInsn(INVOKESPECIAL,internalWrapper,"<init>","(" + descrCore + Type.getDescriptor(Map.class)+ ")V");
    mv.visitFieldInsn(PUTFIELD,internalProxy,"fields",Type.getDescriptor(Map.class));
    mv.visitVarInsn(ALOAD,1);
    mv.visitMethodInsn(INVOKEVIRTUAL,internalCore,"getDynamicProperties","()" + Type.getDescriptor(Map.class));
    Label l1=new Label();
    mv.visitJumpInsn(IFNONNULL,l1);
    mv.visitVarInsn(ALOAD,1);
    mv.visitVarInsn(ALOAD,2);
    mv.visitMethodInsn(INVOKEVIRTUAL,internalCore,"setDynamicProperties","(" + Type.getDescriptor(Map.class) + ")V");
    mv.visitLabel(l1);
    mv.visitVarInsn(ALOAD,1);
    mv.visitMethodInsn(INVOKEVIRTUAL,internalCore,"getTraitMap","()" + Type.getDescriptor(Map.class));
    Label l2=new Label();
    mv.visitJumpInsn(IFNONNULL,l2);
    mv.visitVarInsn(ALOAD,1);
    mv.visitTypeInsn(NEW,Type.getInternalName(VetoableTypedMap.class));
    mv.visitInsn(DUP);
    mv.visitTypeInsn(NEW,Type.getInternalName(HashMap.class));
    mv.visitInsn(DUP);
    mv.visitMethodInsn(INVOKESPECIAL,Type.getInternalName(HashMap.class),"<init>","()V");
    mv.visitMethodInsn(INVOKESPECIAL,Type.getInternalName(VetoableTypedMap.class),"<init>","(" + Type.getDescriptor(Map.class) + ")V");
    mv.visitMethodInsn(INVOKEVIRTUAL,internalCore,"setTraitMap","(" + Type.getDescriptor(Map.class) + ")V");
    mv.visitLabel(l2);
    mv.visitInsn(RETURN);
    mv.visitMaxs(5,3);
    mv.visitEnd();
  }
{
    mv=cw.visitMethod(ACC_PUBLIC,"getCore","()" + descrCore + "",null,null);
    mv.visitCode();
    mv.visitVarInsn(ALOAD,0);
    mv.visitFieldInsn(GETFIELD,internalProxy,"object",descrCore);
    mv.visitInsn(ARETURN);
    mv.visitMaxs(1,1);
    mv.visitEnd();
  }
{
    mv=cw.visitMethod(ACC_PUBLIC,"getObject","()" + Type.getDescriptor(Object.class),null,null);
    mv.visitCode();
    mv.visitVarInsn(ALOAD,0);
    mv.visitFieldInsn(GETFIELD,internalProxy,"object",descrCore);
    mv.visitInsn(ARETURN);
    mv.visitMaxs(1,1);
    mv.visitEnd();
  }
{
    mv=cw.visitMethod(ACC_PUBLIC + ACC_BRIDGE + ACC_SYNTHETIC,"getCore","()" + Type.getDescriptor(Object.class),null,null);
    mv.visitCode();
    mv.visitVarInsn(ALOAD,0);
    mv.visitMethodInsn(INVOKEVIRTUAL,internalProxy,"getCore","()" + descrCore);
    mv.visitInsn(ARETURN);
    mv.visitMaxs(1,1);
    mv.visitEnd();
  }
{
    mv=cw.visitMethod(ACC_PUBLIC,"writeExternal","(" + Type.getDescriptor(ObjectOutput.class) + ")V",null,new String[]{Type.getInternalName(IOException.class)});
    mv.visitCode();
    mv.visitVarInsn(ALOAD,1);
    mv.visitVarInsn(ALOAD,0);
    mv.visitMethodInsn(INVOKEVIRTUAL,internalProxy,"getObject","()" + Type.getDescriptor(Object.class));
    mv.visitMethodInsn(INVOKEINTERFACE,Type.getInternalName(ObjectOutput.class),"writeObject","(" + Type.getDescriptor(Object.class) + ")V");
    mv.visitVarInsn(ALOAD,1);
    mv.visitVarInsn(ALOAD,0);
    mv.visitFieldInsn(GETFIELD,internalProxy,"map",Type.getDescriptor(Map.class));
    mv.visitMethodInsn(INVOKEINTERFACE,Type.getInternalName(ObjectOutput.class),"writeObject","(" + Type.getDescriptor(Object.class) + ")V");
    mv.visitVarInsn(ALOAD,0);
    mv.visitVarInsn(ALOAD,1);
    mv.visitMethodInsn(INVOKESPECIAL,Type.getInternalName(proxyBaseClass),"writeExternal","(" + Type.getDescriptor(ObjectOutput.class) + ")V");
    mv.visitInsn(RETURN);
    mv.visitMaxs(2,2);
    mv.visitEnd();
  }
{
    mv=cw.visitMethod(ACC_PUBLIC,"readExternal","(" + Type.getDescriptor(ObjectInput.class) + ")V",null,new String[]{Type.getInternalName(IOException.class),Type.getInternalName(ClassNotFoundException.class)});
    mv.visitCode();
    mv.visitVarInsn(ALOAD,0);
    mv.visitVarInsn(ALOAD,1);
    mv.visitMethodInsn(INVOKEINTERFACE,Type.getInternalName(ObjectInput.class),"readObject","()" + Type.getDescriptor(Object.class));
    mv.visitTypeInsn(CHECKCAST,internalCore);
    mv.visitFieldInsn(PUTFIELD,internalProxy,"object",descrCore);
    mv.visitVarInsn(ALOAD,0);
    mv.visitVarInsn(ALOAD,1);
    mv.visitMethodInsn(INVOKEINTERFACE,Type.getInternalName(ObjectInput.class),"readObject","()" + Type.getDescriptor(Object.class));
    mv.visitTypeInsn(CHECKCAST,Type.getInternalName(Map.class));
    mv.visitFieldInsn(PUTFIELD,internalProxy,"map",Type.getDescriptor(Map.class));
    mv.visitVarInsn(ALOAD,0);
    mv.visitVarInsn(ALOAD,1);
    mv.visitMethodInsn(INVOKESPECIAL,Type.getInternalName(proxyBaseClass),"readExternal","(" + Type.getDescriptor(ObjectInput.class) + ")V");
    mv.visitInsn(RETURN);
    mv.visitMaxs(3,2);
    mv.visitEnd();
  }
  int j=0;
  for (  FieldDefinition field : trait.getFieldsDefinitions()) {
    boolean isSoftField=TraitRegistry.isSoftField(field,j++,mask);
    if (isSoftField) {
      if (!mixinGetSet.containsKey(BuildUtils.getterName(field.getName(),field.getTypeName()))) {
        buildSoftGetter(cw,field.getName(),field.getTypeName(),masterName,core.getName());
        buildSoftSetter(cw,field.getName(),field.getTypeName(),masterName,core.getName());
      }
 else {
      }
    }
 else {
{
        fv=cw.visitField(ACC_PUBLIC + ACC_STATIC,field.getName() + "_reader",Type.getDescriptor(InternalReadAccessor.class),null,null);
        fv.visitEnd();
      }
{
        fv=cw.visitField(ACC_PUBLIC + ACC_STATIC,field.getName() + "_writer",Type.getDescriptor(WriteAccessor.class),null,null);
        fv.visitEnd();
      }
      buildHardGetter(cw,field,masterName,trait,core);
      buildHardSetter(cw,field,masterName,trait,core);
    }
  }
  boolean hasKeys=false;
  for (  FactField ff : trait.getFields()) {
    if (ff.isKey()) {
      hasKeys=true;
      break;
    }
  }
  if (!hasKeys) {
    buildEqualityMethods(cw,masterName,core.getClassName());
  }
 else {
    buildKeyedEqualityMethods(cw,trait,masterName,core.getClassName());
  }
  if (mixinClass != null) {
    buildMixinMethods(cw,masterName,mixin,mixinClass,mixinMethods);
    buildMixinMethods(cw,masterName,mixin,mixinClass,mixinGetSet.values());
  }
  buildCommonMethods(cw,masterName,core.getClassName());
  cw.visitEnd();
  return cw.toByteArray();
}
