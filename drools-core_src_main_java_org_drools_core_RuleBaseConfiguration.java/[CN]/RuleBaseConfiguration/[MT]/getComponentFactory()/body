{
  if (!isPhreakEnabled()) {
    if (!(componentFactory.getNodeFactoryService().getClass().getName().endsWith("ReteNodeFactory"))) {
      if (reteNodeFactory == null) {
        try {
          reteNodeFactory=(NodeFactory)Class.forName("org.drools.core.reteoo.builder.ReteNodeFactory").newInstance();
        }
 catch (        Exception e) {
          throw new RuntimeException(e);
        }
      }
      componentFactory.setNodeFactoryProvider(reteNodeFactory);
    }
    if (!(componentFactory.getAgendaFactory().getClass().getName().endsWith("ReteAgendaFactory"))) {
      if (agendaFactory == null) {
        try {
          agendaFactory=(AgendaFactory)Class.forName("org.drools.core.common.ReteAgendaFactory").newInstance();
        }
 catch (        Exception e) {
          throw new RuntimeException(e);
        }
      }
      componentFactory.setAgendaFactory(agendaFactory);
    }
  }
  return componentFactory;
}
