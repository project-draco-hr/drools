{
  RulesRepository repoInstance=repo.get();
  if (repoInstance == null) {
    log.info("Creating a new Repository Instance..");
    File dir=new File("repository");
    log.info("DELETING test repo: " + dir.getAbsolutePath());
    deleteDir(dir);
    log.info("TEST repo was deleted.");
    try {
      multiThreadedRepository=RulesRepositoryConfigurator.getInstance(null).getJCRRepository();
      session=multiThreadedRepository.login(new SimpleCredentials("alan_parsons","password".toCharArray()));
      RulesRepositoryAdministrator admin=new RulesRepositoryAdministrator(session);
      if (admin.isRepositoryInitialized()) {
        admin.clearRulesRepository();
      }
      RulesRepositoryConfigurator.getInstance(null).setupRepository(session);
      repoInstance=new RulesRepository(session);
      multiThreadedRepository.login(new SimpleCredentials("ADMINISTRATOR","password".toCharArray()));
      repo.set(repoInstance);
    }
 catch (    Exception e) {
      throw new RulesRepositoryException(e);
    }
  }
  return repoInstance;
}
