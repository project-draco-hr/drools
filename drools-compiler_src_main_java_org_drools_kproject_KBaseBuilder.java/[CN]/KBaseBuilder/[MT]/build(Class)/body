{
  String fileStr=null;
  InputStream is=null;
  try {
    is=cls.getResourceAsStream("/" + kBaseQName + ".files.dat");
    fileStr=org.drools.core.util.StringUtils.toString(is);
  }
 catch (  IOException e) {
    throw new RuntimeException("Unable to fine files for KnowledgeBase " + kBaseQName);
  }
 finally {
    if (is != null) {
      try {
        is.close();
      }
 catch (      IOException e) {
        throw new RuntimeException("Unable to fine files for KnowledgeBase " + kBaseQName);
      }
    }
  }
  KnowledgeBuilder kbuilder=KnowledgeBuilderFactory.newKnowledgeBuilder();
  CompositeKnowledgeBuilder ckbuilder=kbuilder.batch();
  String[] files=fileStr.split(",");
  if (files.length > 0) {
    for (    String file : files) {
      if (file.endsWith(".drl")) {
        ckbuilder.add(ResourceFactory.newUrlResource(cls.getResource("/" + file.trim())),ResourceType.DRL);
      }
    }
  }
  ckbuilder.build();
  if (kbuilder.hasErrors()) {
    throw new RuntimeException("Unable to compile " + kBaseQName + ":\n"+ kbuilder.getErrors());
  }
  KnowledgeBaseConfiguration kconf=KnowledgeBaseFactory.newKnowledgeBaseConfiguration();
  kconf.setOption(eventProcessingMode);
  kconf.setOption(equalsBehaviour);
  KnowledgeBase kbase=KnowledgeBaseFactory.newKnowledgeBase(kconf);
  kbase.addKnowledgePackages(kbuilder.getKnowledgePackages());
  return kbase;
}
