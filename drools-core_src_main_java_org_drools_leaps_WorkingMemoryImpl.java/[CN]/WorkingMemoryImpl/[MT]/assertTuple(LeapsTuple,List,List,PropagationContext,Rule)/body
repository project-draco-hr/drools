{
  FactHandleImpl factHandle;
  if (rule.getNoLoop() && rule.equals(context.getRuleOrigin())) {
    return;
  }
  if (blockingFactHandles.size() != 0) {
    PendingTuple pendingTuple=new PendingTuple(tuple,existsEnablingFactHandles,context,rule,(existsEnablingFactHandles != null) && (existsEnablingFactHandles.size() > 0),existsEnablingFactHandles.size(),(blockingFactHandles != null) && (blockingFactHandles.size() > 0),blockingFactHandles.size());
    addPendingTuple(pendingTuple,existsEnablingFactHandles,blockingFactHandles);
    return;
  }
  Duration dur=rule.getDuration();
  Activation agendaItem;
  if (dur != null && dur.getDuration(tuple) > 0) {
    agendaItem=new ScheduledAgendaItem(context.getPropagationNumber(),tuple,this.agenda,context,rule);
    this.agenda.scheduleItem((ScheduledAgendaItem)agendaItem);
    tuple.setActivation(agendaItem);
    agendaItem.setActivated(true);
    this.getAgendaEventSupport().fireActivationCreated(agendaItem);
  }
 else {
    AgendaGroupImpl agendaGroup=null;
    if (rule.getAgendaGroup() == null || rule.getAgendaGroup().equals("") || rule.getAgendaGroup().equals(AgendaGroup.MAIN)) {
      agendaGroup=(AgendaGroupImpl)this.agenda.getAgendaGroup(AgendaGroup.MAIN);
    }
 else {
      agendaGroup=(AgendaGroupImpl)this.agenda.getAgendaGroup(rule.getAgendaGroup());
    }
    if (agendaGroup == null) {
      agendaGroup=new AgendaGroupImpl(rule.getAgendaGroup());
      this.agenda.addAgendaGroup(agendaGroup);
    }
    if (rule.getAutoFocus()) {
      this.agenda.setFocus(agendaGroup);
    }
    ActivationQueue queue=agendaGroup.getActivationQueue(rule.getSalience());
    agendaItem=new AgendaItem(context.getPropagationNumber(),tuple,context,rule,queue);
    queue.add(agendaItem);
    agendaGroup.addToAgenda(queue);
    tuple.setActivation(agendaItem);
    agendaItem.setActivated(true);
    this.getAgendaEventSupport().fireActivationCreated(agendaItem);
    PostedActivation postedActivation=new PostedActivation((AgendaItem)agendaItem,(existsEnablingFactHandles != null) && (existsEnablingFactHandles.size() > 0),(existsEnablingFactHandles != null) ? existsEnablingFactHandles.size() : -1,(blockingFactHandles != null) && (blockingFactHandles.size() > 0),(blockingFactHandles != null) ? blockingFactHandles.size() : -1);
    addPostedActivation(postedActivation,existsEnablingFactHandles,blockingFactHandles);
  }
}
