{
  if (ruleDescr.getResource() == null) {
    ruleDescr.setResource(resource);
  }
  PackageRegistry pkgRegistry=this.pkgRegistryMap.get(ruleDescr.getNamespace());
  Package pkg=pkgRegistry.getPackage();
  DialectCompiletimeRegistry ctr=pkgRegistry.getDialectCompiletimeRegistry();
  RuleBuildContext context=new RuleBuildContext(this,ruleDescr,ctr,pkg,ctr.getDialect(pkgRegistry.getDialect()));
  ruleBuilder.build(context);
  this.results.addAll(context.getErrors());
  context.getRule().setResource(ruleDescr.getResource());
  context.getDialect().addRule(context);
  if (this.ruleBase != null) {
    if (pkg.getRule(ruleDescr.getName()) != null) {
      this.ruleBase.lock();
      try {
        this.ruleBase.removeRule(pkg,pkg.getRule(ruleDescr.getName()));
      }
  finally {
        this.ruleBase.unlock();
      }
    }
  }
  pkg.addRule(context.getRule());
  if (context.needsStreamMode()) {
    pkg.setNeedStreamMode();
  }
}
