{
  String rule="package org.test;\n";
  rule+="import org.drools.Person\n";
  rule+="import org.drools.Cheese\n";
  rule+="global java.util.List list\n";
  rule+="rule \"Rule 1\"\n";
  rule+="when\n";
  rule+="    $c : Cheese( ) \n";
  rule+="    $p : Person( cheese == $c ) \n";
  rule+="then\n";
  rule+="    list.add( $p );\n";
  rule+="end";
  final PackageBuilder builder=new PackageBuilder();
  builder.addPackageFromDrl(new StringReader(rule));
  final Package pkg=builder.getPackage();
  final RuleBase ruleBase=RuleBaseFactory.newRuleBase();
  ruleBase.addPackage(pkg);
  Map<Integer,BaseNode> nodes=RuleBaseNodes.getNodeMap((InternalRuleBase)ruleBase);
  assertEquals(4,nodes.size());
  assertEquals("Cheese",((ClassObjectType)((ObjectTypeNode)nodes.get(3)).getObjectType()).getClassType().getSimpleName());
  assertEquals("Person",((ClassObjectType)((ObjectTypeNode)nodes.get(6)).getObjectType()).getClassType().getSimpleName());
  assertEquals("JoinNode",nodes.get(7).getClass().getSimpleName());
  assertEquals("Rule 1",((RuleTerminalNode)nodes.get(8)).getRule().getName());
  StatefulSession session=ruleBase.newStatefulSession();
  List list=new ArrayList();
  session.setGlobal("list",list);
  Cheese stilton=new Cheese("stilton",25);
  Cheese brie=new Cheese("brie",49);
  Person bobba=new Person("bobba fet",32);
  bobba.setCheese(stilton);
  Person vadar=new Person("darth vadar",32);
  session.insert(stilton);
  session.insert(bobba);
  session.insert(vadar);
  session.insert(brie);
  session=getSerialisedStatefulSession(session);
  session.fireAllRules();
  assertEquals(1,((List)session.getGlobal("list")).size());
  assertEquals(bobba,((List)session.getGlobal("list")).get(0));
  Person c3po=new Person("c3p0",32);
  c3po.setCheese(stilton);
  session.insert(c3po);
  session=getSerialisedStatefulSession(session);
  session.fireAllRules();
  assertEquals(2,((List)session.getGlobal("list")).size());
  assertEquals(c3po,((List)session.getGlobal("list")).get(1));
  Person r2d2=new Person("r2d2",32);
  r2d2.setCheese(brie);
  session.insert(r2d2);
  System.out.println("\n\njointpattern");
  session=getSerialisedStatefulSession(session);
  session.fireAllRules();
  assertEquals(3,((List)session.getGlobal("list")).size());
  assertEquals(r2d2,((List)session.getGlobal("list")).get(2));
}
