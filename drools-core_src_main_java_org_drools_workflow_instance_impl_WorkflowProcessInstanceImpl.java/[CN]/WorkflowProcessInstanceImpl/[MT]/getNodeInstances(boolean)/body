{
  Collection<NodeInstance> result=nodeInstances;
  if (recursive) {
    result=new ArrayList<NodeInstance>(result);
    for (Iterator<NodeInstance> iterator=nodeInstances.iterator(); iterator.hasNext(); ) {
      NodeInstance nodeInstance=iterator.next();
      if (nodeInstance instanceof NodeInstanceContainer) {
        result.addAll(((org.drools.workflow.instance.NodeInstanceContainer)nodeInstance).getNodeInstances(true));
      }
    }
  }
  return Collections.unmodifiableCollection(result);
}
