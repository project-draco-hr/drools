{
  NodeInstanceFactoryRegistry nodeRegistry=((InternalRuleBase)getWorkingMemory().getRuleBase()).getConfiguration().getProcessNodeInstanceFactoryRegistry();
  NodeInstanceFactory conf=nodeRegistry.getProcessNodeInstanceFactory(node);
  if (conf == null) {
    throw new IllegalArgumentException("Illegal node type: " + node.getClass());
  }
  NodeInstanceImpl nodeInstance=(NodeInstanceImpl)conf.getNodeInstance(node,this,this);
  if (nodeInstance == null) {
    throw new IllegalArgumentException("Illegal node type: " + node.getClass());
  }
  if (((NodeInstanceImpl)nodeInstance).isInversionOfControl()) {
    getWorkingMemory().insert(nodeInstance);
  }
  return nodeInstance;
}
