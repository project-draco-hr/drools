{
  NodeInstanceFactoryRegistry nodeRegistry=((InternalRuleBase)this.workingMemory.getRuleBase()).getConfiguration().getProcessNodeInstanceFactoryRegistry();
  NodeInstanceFactory conf=nodeRegistry.getProcessNodeInstanceFactory(node);
  if (conf == null) {
    throw new IllegalArgumentException("Illegal node type: " + node.getClass());
  }
  NodeInstanceImpl nodeInstance=(NodeInstanceImpl)conf.getNodeInstance(node,this,this);
  nodeInstance.setNodeId(node.getId());
  nodeInstance.setNodeInstanceContainer(this);
  nodeInstance.setProcessInstance(this);
  if (nodeInstance == null) {
    throw new IllegalArgumentException("Illegal node type: " + node.getClass());
  }
  return nodeInstance;
}
