{
  super.setState(state);
  if (state == ProcessInstanceImpl.STATE_COMPLETED) {
    InternalWorkingMemory workingMemory=(InternalWorkingMemory)getWorkingMemory();
    ((EventSupport)getWorkingMemory()).getRuleFlowEventSupport().fireBeforeRuleFlowProcessCompleted(this,workingMemory);
    while (!nodeInstances.isEmpty()) {
      NodeInstance nodeInstance=(NodeInstance)nodeInstances.get(0);
      nodeInstance.cancel();
    }
    workingMemory.removeProcessInstance(this);
    ((EventSupport)workingMemory).getRuleFlowEventSupport().fireAfterRuleFlowProcessCompleted(this,workingMemory);
  }
}
