{
  boolean isInternalFact=declr != null && !declr.isInternalFact();
  boolean isPropertySpecific=false;
  TypeDeclaration typeDeclaration=null;
  List<String> settableProperties=null;
  if (isInternalFact) {
    Class<?> typeClass=((ClassObjectType)declr.getPattern().getObjectType()).getClassType();
    typeDeclaration=context.getPackageBuilder().getTypeDeclaration(typeClass);
    if (typeDeclaration != null && typeDeclaration.isPropertySpecific()) {
      isPropertySpecific=true;
      typeDeclaration.setTypeClass(typeClass);
      settableProperties=typeDeclaration.getSettableProperties();
    }
  }
  long modificationMask=isPropertySpecific ? 0 : Long.MAX_VALUE;
  int end=originalBlock.indexOf("{");
  if (end == -1) {
    context.addError(new DescrBuildError(context.getParentDescr(),context.getRuleDescr(),null,"Block missing after modify" + d.getTargetExpression() + " ?\n"));
    return;
  }
  addLineBreaks(consequence,originalBlock.substring(0,end));
  int start=end + 1;
  for (  String exprStr : ((JavaModifyBlockDescr)d).getExpressions()) {
    end=originalBlock.indexOf(exprStr,start);
    addLineBreaks(consequence,originalBlock.substring(start,end));
    consequence.append(obj + ".");
    consequence.append(exprStr);
    consequence.append("; ");
    start=end + exprStr.length();
    if (isPropertySpecific) {
      int endMethodName=exprStr.indexOf('(');
      if (endMethodName >= 0) {
        String methodName=exprStr.substring(0,endMethodName).trim();
        String propertyName=setter2property(methodName);
        if (propertyName != null) {
          int pos=settableProperties.indexOf(propertyName);
          if (pos >= 0)           modificationMask=BitMaskUtil.set(modificationMask,pos);
        }
        String methodParams=exprStr.substring(endMethodName + 1,exprStr.indexOf(')'));
        int argsNr=methodParams.trim().length() == 0 ? 0 : methodParams.split(",").length;
        String methodWithArgsNr=methodName + "_" + argsNr;
        List<String> modifiedProps=typeDeclaration.getTypeClassDef().getModifiedPropsByMethod(methodWithArgsNr);
        if (modifiedProps != null) {
          for (          String modifiedProp : modifiedProps) {
            int pos=settableProperties.indexOf(modifiedProp);
            if (pos >= 0)             modificationMask=BitMaskUtil.set(modificationMask,pos);
          }
        }
      }
 else {
        String propertyName=extractFirstIdentifier(exprStr,0);
        if (propertyName != null) {
          int pos=settableProperties.indexOf(propertyName);
          if (pos >= 0)           modificationMask=BitMaskUtil.set(modificationMask,pos);
        }
      }
    }
  }
  addLineBreaks(consequence,originalBlock.substring(end));
  consequence.append("drools.update( ").append(obj).append(isInternalFact ? "__Handle__, " : "__Handle2__, ").append(modificationMask).append("L ); }");
}
