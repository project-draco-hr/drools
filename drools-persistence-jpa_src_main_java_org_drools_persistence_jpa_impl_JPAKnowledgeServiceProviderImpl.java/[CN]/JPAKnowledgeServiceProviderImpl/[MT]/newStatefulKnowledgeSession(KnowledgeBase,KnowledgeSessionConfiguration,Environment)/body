{
  if (configuration == null) {
    configuration=new SessionConfiguration();
  }
  if (environment == null) {
    throw new IllegalArgumentException("Environment cannot be null");
  }
  Properties props=new Properties();
  props.setProperty("drools.commandService","org.drools.persistence.session.SingleSessionCommandService");
  props.setProperty("drools.processInstanceManagerFactory","org.drools.persistence.processinstance.JPAProcessInstanceManagerFactory");
  props.setProperty("drools.workItemManagerFactory","org.drools.persistence.processinstance.JPAWorkItemManagerFactory");
  props.setProperty("drools.processSignalManagerFactory","org.drools.persistence.processinstance.JPASignalManagerFactory");
  ((SessionConfiguration)configuration).addProperties(props);
  CommandService commandService=new SingleSessionCommandService(kbase,configuration,environment);
  return new CommandBasedStatefulKnowledgeSession(commandService);
}
