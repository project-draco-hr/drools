{
  setUp(JOIN_NODE);
  KieBaseConfiguration kconf=KnowledgeBaseFactory.newKnowledgeBaseConfiguration();
  kconf.setOption(LRUnlinkingOption.ENABLED);
  ReteooWorkingMemory wm=new ReteooWorkingMemory(1,(ReteooRuleBase)RuleBaseFactory.newRuleBase((RuleBaseConfiguration)kconf));
  BetaMemory bm=null;
  List<RuleMemory> list;
  RuleMemory rtn1Rs=(RuleMemory)wm.getNodeMemory(rtn1);
  RuleMemory rtn2Rs=(RuleMemory)wm.getNodeMemory(rtn2);
  RuleMemory rtn3Rs=(RuleMemory)wm.getNodeMemory(rtn3);
  bm=createSegmentMemory(n1,wm);
  assertEquals(2,bm.getNodePosMaskBit());
  assertEquals(15,bm.getSegmentMemory().getAllLinkedMaskTest());
  assertEquals(1,bm.getSegmentMemory().getSegmentPosMaskBit());
  list=bm.getSegmentMemory().getRuleMemories();
  assertEquals(3,list.size());
  assertTrue(list.contains(rtn1Rs));
  assertTrue(list.contains(rtn2Rs));
  assertTrue(list.contains(rtn3Rs));
  bm=createSegmentMemory(n2,wm);
  assertEquals(4,bm.getNodePosMaskBit());
  assertEquals(15,bm.getSegmentMemory().getAllLinkedMaskTest());
  assertEquals(1,bm.getSegmentMemory().getSegmentPosMaskBit());
  list=bm.getSegmentMemory().getRuleMemories();
  assertEquals(3,list.size());
  assertTrue(list.contains(rtn1Rs));
  assertTrue(list.contains(rtn2Rs));
  assertTrue(list.contains(rtn3Rs));
  bm=createSegmentMemory(n3,wm);
  assertEquals(8,bm.getNodePosMaskBit());
  assertEquals(15,bm.getSegmentMemory().getAllLinkedMaskTest());
  assertEquals(1,bm.getSegmentMemory().getSegmentPosMaskBit());
  list=bm.getSegmentMemory().getRuleMemories();
  assertEquals(3,list.size());
  assertTrue(list.contains(rtn1Rs));
  assertTrue(list.contains(rtn2Rs));
  assertTrue(list.contains(rtn3Rs));
  bm=createSegmentMemory(n4,wm);
  assertEquals(1,bm.getNodePosMaskBit());
  assertEquals(3,bm.getSegmentMemory().getAllLinkedMaskTest());
  assertEquals(2,bm.getSegmentMemory().getSegmentPosMaskBit());
  list=bm.getSegmentMemory().getRuleMemories();
  assertEquals(2,list.size());
  assertTrue(list.contains(rtn2Rs));
  assertTrue(list.contains(rtn3Rs));
  bm=createSegmentMemory(n5,wm);
  assertEquals(2,bm.getNodePosMaskBit());
  assertEquals(3,bm.getSegmentMemory().getAllLinkedMaskTest());
  assertEquals(2,bm.getSegmentMemory().getSegmentPosMaskBit());
  list=bm.getSegmentMemory().getRuleMemories();
  assertEquals(2,list.size());
  assertTrue(list.contains(rtn2Rs));
  assertTrue(list.contains(rtn3Rs));
  bm=createSegmentMemory(n6,wm);
  assertEquals(1,bm.getNodePosMaskBit());
  assertEquals(7,bm.getSegmentMemory().getAllLinkedMaskTest());
  assertEquals(4,bm.getSegmentMemory().getSegmentPosMaskBit());
  list=bm.getSegmentMemory().getRuleMemories();
  assertEquals(1,list.size());
  assertTrue(list.contains(rtn3Rs));
  bm=createSegmentMemory(n7,wm);
  assertEquals(2,bm.getNodePosMaskBit());
  assertEquals(7,bm.getSegmentMemory().getAllLinkedMaskTest());
  assertEquals(4,bm.getSegmentMemory().getSegmentPosMaskBit());
  list=bm.getSegmentMemory().getRuleMemories();
  assertEquals(1,list.size());
  assertTrue(list.contains(rtn3Rs));
  bm=createSegmentMemory(n8,wm);
  assertEquals(4,bm.getNodePosMaskBit());
  assertEquals(7,bm.getSegmentMemory().getAllLinkedMaskTest());
  assertEquals(4,bm.getSegmentMemory().getSegmentPosMaskBit());
  list=bm.getSegmentMemory().getRuleMemories();
  assertEquals(1,list.size());
  assertTrue(list.contains(rtn3Rs));
}
