{
  setUp(JOIN_NODE);
  KnowledgeBaseConfiguration kconf=KnowledgeBaseFactory.newKnowledgeBaseConfiguration();
  kconf.setOption(LRUnlinkingOption.ENABLED);
  ReteooWorkingMemory wm=new ReteooWorkingMemory(1,(ReteooRuleBase)RuleBaseFactory.newRuleBase((RuleBaseConfiguration)kconf));
  BetaMemory bm=null;
  List<RuleMemory> list;
  RuleMemory rtn1Rs=(RuleMemory)wm.getNodeMemory(rtn1);
  RuleMemory rtn2Rs=(RuleMemory)wm.getNodeMemory(rtn2);
  RuleMemory rtn3Rs=(RuleMemory)wm.getNodeMemory(rtn3);
  DefaultFactHandle f1=(DefaultFactHandle)wm.insert("test1");
  liaNode.assertObject(f1,context,wm);
  n1.assertObject(f1,context,wm);
  n3.assertObject(f1,context,wm);
  n4.assertObject(f1,context,wm);
  n8.assertObject(f1,context,wm);
  assertFalse(rtn1Rs.isRuleLinked());
  assertFalse(rtn2Rs.isRuleLinked());
  assertFalse(rtn3Rs.isRuleLinked());
  bm=(BetaMemory)wm.getNodeMemory(n2);
  assertFalse(bm.getSegmentMemory().isSegmentLinked());
  DefaultFactHandle f2=(DefaultFactHandle)wm.insert("test2");
  n2.assertObject(f2,context,wm);
  assertTrue(bm.getSegmentMemory().isSegmentLinked());
  assertTrue(rtn1Rs.isRuleLinked());
  assertFalse(rtn2Rs.isRuleLinked());
  assertFalse(rtn3Rs.isRuleLinked());
  bm=(BetaMemory)wm.getNodeMemory(n5);
  assertFalse(bm.getSegmentMemory().isSegmentLinked());
  n5.assertObject(f1,context,wm);
  assertTrue(bm.getSegmentMemory().isSegmentLinked());
  assertTrue(rtn1Rs.isRuleLinked());
  assertTrue(rtn2Rs.isRuleLinked());
  assertFalse(rtn3Rs.isRuleLinked());
  n6.assertObject(f1,context,wm);
  n7.assertObject(f1,context,wm);
  assertTrue(bm.getSegmentMemory().isSegmentLinked());
  assertTrue(rtn1Rs.isRuleLinked());
  assertTrue(rtn2Rs.isRuleLinked());
  assertTrue(rtn3Rs.isRuleLinked());
  n2.retractRightTuple(f2.getFirstRightTuple(),context,wm);
  assertFalse(rtn1Rs.isRuleLinked());
  assertFalse(rtn2Rs.isRuleLinked());
  assertFalse(rtn3Rs.isRuleLinked());
}
