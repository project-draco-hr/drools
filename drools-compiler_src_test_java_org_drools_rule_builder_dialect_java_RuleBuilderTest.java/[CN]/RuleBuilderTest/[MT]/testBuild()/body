{
  final DrlParser parser=new DrlParser();
  final PackageDescr pkgDescr=parser.parse(new InputStreamReader(getClass().getResourceAsStream("nestedConditionalElements.drl")));
  Assert.assertFalse(parser.getErrors().toString(),parser.hasErrors());
  final Package pkg=new Package("org.drools");
  final RuleDescr ruleDescr=(RuleDescr)pkgDescr.getRules().get(0);
  final String ruleClassName="RuleClassName.java";
  ruleDescr.setClassName(ruleClassName);
  final TypeResolver typeResolver=new ClassTypeResolver(new ArrayList(),this.getClass().getClassLoader());
  typeResolver.addImport(pkgDescr.getName() + ".*");
  typeResolver.addImport("java.lang.*");
  final RuleBuilder builder=new RuleBuilder();
  RuleBuildContext context=new RuleBuildContext(pkg,ruleDescr);
  JavaDialect dialect=new JavaDialect(null,new PackageBuilderConfiguration(),typeResolver,new ClassFieldExtractorCache());
  context.setDialect(dialect);
  builder.build(context);
  Assert.assertTrue(context.getErrors().toString(),context.getErrors().isEmpty());
  final Rule rule=context.getRule();
  assertEquals("There should be 2 rule level declarations",2,rule.getDeclarations().length);
  final GroupElement not=(GroupElement)rule.getLhs().getChildren().get(1);
  assertTrue(not.isNot());
  assertTrue(not.getOuterDeclarations().isEmpty());
  assertEquals(1,not.getInnerDeclarations().size());
  assertTrue(not.getInnerDeclarations().keySet().contains("$state"));
  final GroupElement not2=(GroupElement)((GroupElement)not.getChildren().get(0)).getChildren().get(1);
  assertTrue(not2.isNot());
  assertTrue(not2.getOuterDeclarations().isEmpty());
  assertEquals(1,not2.getInnerDeclarations().size());
  assertTrue(not2.getInnerDeclarations().keySet().contains("$likes"));
}
