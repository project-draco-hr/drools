{
  KieBaseConfiguration kconf=(KieBaseConfiguration)KnowledgeBaseFactory.newKnowledgeBaseConfiguration();
  kconf.setOption(RuleEngineOption.PHREAK);
  KnowledgeBase kbase=KnowledgeBaseFactory.newKnowledgeBase(kconf);
  InternalWorkingMemory wm=((InternalWorkingMemory)kbase.newStatefulKnowledgeSession());
  wm.insert(new A(1));
  wm.insert(new A(2));
  wm.insert(new D(1));
  wm.insert(new E(1));
  wm.insert(new C(2));
  wm.fireAllRules();
  kbase.addKnowledgePackages(buildKnowledgePackage("r1","   A() not( B() and C() ) D() E()\n"));
  List list=new ArrayList();
  wm.setGlobal("list",list);
  ObjectTypeNode aotn=getObjectTypeNode(kbase,A.class);
  LeftInputAdapterNode liaNode=(LeftInputAdapterNode)aotn.getSinkPropagator().getSinks()[0];
  LiaNodeMemory lm=(LiaNodeMemory)wm.getNodeMemory(liaNode);
  SegmentMemory sm=lm.getSegmentMemory();
  assertNull(sm.getStagedLeftTuples().getInsertFirst());
  SegmentMemory subSm=sm.getFirst();
  SegmentMemory mainSm=subSm.getNext();
  assertNotNull(subSm.getStagedLeftTuples().getInsertFirst());
  assertNotNull(subSm.getStagedLeftTuples().getInsertFirst().getStagedNext());
  assertNull(subSm.getStagedLeftTuples().getInsertFirst().getStagedNext().getStagedNext());
  assertNotNull(mainSm.getStagedLeftTuples().getInsertFirst());
  assertNotNull(mainSm.getStagedLeftTuples().getInsertFirst().getStagedNext());
  assertNull(mainSm.getStagedLeftTuples().getInsertFirst().getStagedNext().getStagedNext());
  wm.fireAllRules();
  assertNull(subSm.getStagedLeftTuples().getInsertFirst());
  assertNull(mainSm.getStagedLeftTuples().getInsertFirst());
  assertEquals(2,list.size());
  assertEquals("r1",((Match)list.get(0)).getRule().getName());
}
