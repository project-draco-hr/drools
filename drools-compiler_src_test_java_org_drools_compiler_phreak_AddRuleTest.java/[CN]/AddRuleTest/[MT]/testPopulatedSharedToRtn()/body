{
  KnowledgeBase kbase1=buildKnowledgeBase("r1","   A() B() C() D() E()\n");
  InternalWorkingMemory wm=((InternalWorkingMemory)kbase1.newStatefulKnowledgeSession());
  List list=new ArrayList();
  wm.setGlobal("list",list);
  wm.insert(new A(1));
  wm.insert(new A(2));
  wm.insert(new B(1));
  wm.insert(new C(1));
  wm.insert(new D(1));
  wm.insert(new E(1));
  wm.fireAllRules();
  assertEquals(2,list.size());
  kbase1.addKnowledgePackages(buildKnowledgePackage("r2","   A() B() C() D() E()\n"));
  ObjectTypeNode eotn=getObjectTypeNode(kbase1,E.class);
  JoinNode eNode=(JoinNode)eotn.getSinkPropagator().getSinks()[0];
  RuleTerminalNode rtn=(RuleTerminalNode)eNode.getSinkPropagator().getLastLeftTupleSink();
  PathMemory pm=(PathMemory)wm.getNodeMemory(rtn);
  SegmentMemory sm=pm.getSegmentMemory();
  assertNotNull(sm.getStagedLeftTuples().getInsertFirst());
  assertNotNull(sm.getStagedLeftTuples().getInsertFirst().getStagedNext());
  assertNull(sm.getStagedLeftTuples().getInsertFirst().getStagedNext().getStagedNext());
  wm.fireAllRules();
  assertNull(sm.getStagedLeftTuples().getInsertFirst());
  assertEquals(4,list.size());
  System.out.println(list);
  assertEquals("r1",((Match)list.get(0)).getRule().getName());
  assertEquals("r1",((Match)list.get(1)).getRule().getName());
  assertEquals("r2",((Match)list.get(2)).getRule().getName());
  assertEquals("r2",((Match)list.get(3)).getRule().getName());
}
