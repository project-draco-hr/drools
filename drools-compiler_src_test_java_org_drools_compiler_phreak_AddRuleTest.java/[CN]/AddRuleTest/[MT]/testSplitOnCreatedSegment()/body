{
  KnowledgeBase kbase1=buildKnowledgeBase("r1","   A(1;)  A(2;) B(1;) B(2;) C(1;) C(2;) D(1;) D(2;) E(1;) E(2;)\n");
  kbase1.addKnowledgePackages(buildKnowledgePackage("r2","   A(1;)  A(2;) B(1;) B(2;) C(1;) C(2;) D(1;) D(2;) E(1;) E(2;)\n"));
  kbase1.addKnowledgePackages(buildKnowledgePackage("r3","   A(1;)  A(2;) B(1;) B(2;) C(1;) C(2;) D(1;) D(2;)\n"));
  kbase1.addKnowledgePackages(buildKnowledgePackage("r4","   A(1;)  A(2;) B(1;) B(2;) C(1;) C(2;) \n"));
  ReteooWorkingMemoryInterface wm=((StatefulKnowledgeSessionImpl)kbase1.newStatefulKnowledgeSession());
  List list=new ArrayList();
  wm.setGlobal("list",list);
  wm.insert(new D(1));
  wm.insert(new D(2));
  RuleTerminalNode rtn1=getRtn("r1",kbase1);
  PathMemory pm1=(PathMemory)wm.getNodeMemory(rtn1);
  SegmentMemory[] smems=pm1.getSegmentMemories();
  assertEquals(4,smems.length);
  assertNull(smems[0]);
  assertNull(smems[2]);
  assertNull(smems[3]);
  SegmentMemory sm=smems[1];
  assertEquals(1,sm.getPos());
  assertEquals(2,sm.getSegmentPosMaskBit());
  assertEquals(2,pm1.getLinkedSegmentMask());
  kbase1.addKnowledgePackages(buildKnowledgePackage("r5","   A(1;)  A(2;) B(1;) B(2;) C(1;) C(2;) D(1;) D(3;)\n"));
  smems=pm1.getSegmentMemories();
  assertEquals(5,smems.length);
  assertNull(smems[0]);
  assertNull(smems[3]);
  assertNull(smems[4]);
  sm=smems[1];
  assertEquals(1,sm.getPos());
  assertEquals(2,sm.getSegmentPosMaskBit());
  assertEquals(6,pm1.getLinkedSegmentMask());
  sm=smems[2];
  assertEquals(2,sm.getPos());
  assertEquals(4,sm.getSegmentPosMaskBit());
  assertEquals(6,pm1.getLinkedSegmentMask());
  RuleTerminalNode rtn5=getRtn("r5",kbase1);
  PathMemory pm5=(PathMemory)wm.getNodeMemory(rtn5);
  smems=pm5.getSegmentMemories();
  assertEquals(3,smems.length);
  assertNull(smems[0]);
  sm=smems[1];
  assertEquals(1,sm.getPos());
  assertEquals(2,sm.getSegmentPosMaskBit());
  assertEquals(6,pm5.getLinkedSegmentMask());
  sm=smems[2];
  assertEquals(2,sm.getPos());
  assertEquals(4,sm.getSegmentPosMaskBit());
  assertEquals(6,pm5.getLinkedSegmentMask());
}
