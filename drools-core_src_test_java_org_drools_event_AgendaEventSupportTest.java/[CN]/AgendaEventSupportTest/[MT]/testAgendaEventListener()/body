{
  final RuleBase rb=RuleBaseFactory.newRuleBase();
  final Package pkg=new Package("org.drools.test");
  final Rule rule=new Rule("test1");
  rule.setAgendaGroup("test group");
  final ClassObjectType cheeseObjectType=new ClassObjectType(Cheese.class);
  final Pattern pattern=new Pattern(0,cheeseObjectType);
  final ClassFieldExtractor extractor=ClassFieldExtractorCache.getExtractor(Cheese.class,"type");
  final FieldValue field=FieldFactory.getFieldValue("cheddar");
  final Evaluator evaluator=ValueType.STRING_TYPE.getEvaluator(Operator.EQUAL);
  final LiteralConstraint constraint=new LiteralConstraint(extractor,evaluator,field);
  pattern.addConstraint(constraint);
  rule.addPattern(pattern);
  rule.setConsequence(new Consequence(){
    public void evaluate(    final KnowledgeHelper knowledgeHelper,    final WorkingMemory workingMemory) throws Exception {
    }
  }
);
  pkg.addRule(rule);
  rb.addPackage(pkg);
  final WorkingMemory wm=rb.newStatefulSession();
  final List agendaList=new ArrayList();
  final AgendaEventListener agendaEventListener=new AgendaEventListener(){
    public void activationCancelled(    ActivationCancelledEvent event,    WorkingMemory workingMemory){
      agendaList.add(event);
    }
    public void activationCreated(    ActivationCreatedEvent event,    WorkingMemory workingMemory){
      agendaList.add(event);
    }
    public void afterActivationFired(    AfterActivationFiredEvent event,    WorkingMemory workingMemory){
      agendaList.add(event);
    }
    public void agendaGroupPopped(    AgendaGroupPoppedEvent event,    WorkingMemory workingMemory){
      agendaList.add(event);
    }
    public void agendaGroupPushed(    AgendaGroupPushedEvent event,    WorkingMemory workingMemory){
      agendaList.add(event);
    }
    public void beforeActivationFired(    BeforeActivationFiredEvent event,    WorkingMemory workingMemory){
      agendaList.add(event);
    }
  }
;
  wm.addEventListener(agendaEventListener);
  final Cheese cheddar=new Cheese("cheddar",15);
  FactHandle cheddarHandle=wm.insert(cheddar);
  assertEquals(1,agendaList.size());
  ActivationCreatedEvent createdEvent=(ActivationCreatedEvent)agendaList.get(0);
  assertSame(cheddar,unwrapShadow(createdEvent.getActivation().getTuple().get(0).getObject()));
  agendaList.clear();
  cheddar.setPrice(14);
  wm.update(cheddarHandle,cheddar);
  assertEquals(2,agendaList.size());
  ActivationCancelledEvent cancelledEvent=(ActivationCancelledEvent)agendaList.get(0);
  assertSame(cheddar,unwrapShadow(cancelledEvent.getActivation().getTuple().get(0).getObject()));
  createdEvent=(ActivationCreatedEvent)agendaList.get(1);
  assertSame(cheddar,unwrapShadow(createdEvent.getActivation().getTuple().get(0).getObject()));
  agendaList.clear();
  wm.retract(cheddarHandle);
  assertEquals(1,agendaList.size());
  cancelledEvent=(ActivationCancelledEvent)agendaList.get(0);
  assertNull(cancelledEvent.getActivation().getTuple().get(0).getObject());
  cheddarHandle=wm.insert(cheddar);
  agendaList.clear();
  wm.setFocus("test group");
  assertEquals(1,agendaList.size());
  final AgendaGroupPushedEvent pushedEvent=(AgendaGroupPushedEvent)agendaList.get(0);
  assertEquals("test group",pushedEvent.getAgendaGroup().getName());
  agendaList.clear();
  wm.fireAllRules();
  assertEquals(3,agendaList.size());
  final BeforeActivationFiredEvent beforeEvent=(BeforeActivationFiredEvent)agendaList.get(0);
  assertSame(cheddar,unwrapShadow(beforeEvent.getActivation().getTuple().get(0).getObject()));
  final AfterActivationFiredEvent afterEvent=(AfterActivationFiredEvent)agendaList.get(1);
  assertSame(cheddar,unwrapShadow(afterEvent.getActivation().getTuple().get(0).getObject()));
  final AgendaGroupPoppedEvent poppedEvent=(AgendaGroupPoppedEvent)agendaList.get(2);
  assertEquals("test group",poppedEvent.getAgendaGroup().getName());
}
