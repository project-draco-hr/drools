{
  if (str == null) {
    return null;
  }
  final int len=str.length();
  if (len == 0) {
    return EMPTY_STRING_ARRAY;
  }
  if ((separator == null) || ("".equals(separator))) {
    return split(str,null,max);
  }
  final int separatorLength=separator.length();
  final ArrayList substrings=new ArrayList();
  int numberOfSubstrings=0;
  int beg=0;
  int end=0;
  while (end < len) {
    end=str.indexOf(separator,beg);
    if (end > -1) {
      if (end > beg) {
        numberOfSubstrings+=1;
        if (numberOfSubstrings == max) {
          end=len;
          substrings.add(str.substring(beg));
        }
 else {
          substrings.add(str.substring(beg,end));
          beg=end + separatorLength;
        }
      }
 else {
        beg=end + separatorLength;
      }
    }
 else {
      substrings.add(str.substring(beg));
      end=len;
    }
  }
  return (String[])substrings.toArray(new String[substrings.size()]);
}
