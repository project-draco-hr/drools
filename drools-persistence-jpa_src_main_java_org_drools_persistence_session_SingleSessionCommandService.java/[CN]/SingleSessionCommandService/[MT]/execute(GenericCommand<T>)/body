{
  ksession.halt();
  boolean localTransaction=false;
  UserTransaction ut=null;
  try {
    ut=(UserTransaction)new InitialContext().lookup("java:comp/UserTransaction");
    if (ut.getStatus() == Status.STATUS_NO_TRANSACTION) {
      ut.begin();
      localTransaction=true;
    }
    EntityManager localEm=(EntityManager)env.get(EnvironmentName.ENTITY_MANAGER);
    if (localEm == null || !localEm.isOpen()) {
      localEm=this.emf.createEntityManager();
      this.env.set(EnvironmentName.ENTITY_MANAGER,localEm);
    }
    if (this.em == null) {
      this.em=this.emf.createEntityManager();
      this.sessionInfo=this.em.find(SessionInfo.class,this.sessionInfo.getId());
      ((ReteooWorkingMemory)((StatefulKnowledgeSessionImpl)this.ksession).session).setEndOperationListener(new EndOperationListenerImpl(this.sessionInfo));
      this.sessionInfo.setJPASessionMashallingHelper(this.marshallingHelper);
      this.marshallingHelper.loadSnapshot(this.sessionInfo.getData(),this.ksession);
    }
    this.em.joinTransaction();
    registerRollbackSync();
    T result=command.execute(this.kContext);
    if (localTransaction) {
      ut.commit();
      if (localEm.isOpen()) {
        localEm.close();
      }
      this.env.set(EnvironmentName.ENTITY_MANAGER,null);
      ((JPAProcessInstanceManager)((StatefulKnowledgeSessionImpl)ksession).session.getProcessInstanceManager()).clearProcessInstances();
      ((JPAWorkItemManager)((StatefulKnowledgeSessionImpl)ksession).session.getWorkItemManager()).clearWorkItems();
    }
    return result;
  }
 catch (  Throwable t1) {
    t1.printStackTrace();
    if (localTransaction) {
      try {
        if (ut != null) {
          ut.rollback();
        }
        throw new RuntimeException("Could not execute command",t1);
      }
 catch (      Throwable t2) {
        throw new RuntimeException("Could not rollback transaction",t2);
      }
    }
 else {
      throw new RuntimeException("Could not execute command",t1);
    }
  }
}
