{
  if (status != Status.STATUS_COMMITTED) {
    rollback();
  }
  Map map=(Map)env.get("synchronizations");
  map.remove(SingleSessionCommandService.this);
  EntityManager localEm=(EntityManager)env.get(EnvironmentName.ENTITY_MANAGER);
  if (localEm != null && localEm.isOpen()) {
    localEm.close();
  }
  env.set(EnvironmentName.ENTITY_MANAGER,null);
  if (ksession != null) {
    ((JPAProcessInstanceManager)((StatefulKnowledgeSessionImpl)ksession).session.getProcessInstanceManager()).clearProcessInstances();
    ((JPAWorkItemManager)((StatefulKnowledgeSessionImpl)ksession).session.getWorkItemManager()).clearWorkItems();
  }
}
