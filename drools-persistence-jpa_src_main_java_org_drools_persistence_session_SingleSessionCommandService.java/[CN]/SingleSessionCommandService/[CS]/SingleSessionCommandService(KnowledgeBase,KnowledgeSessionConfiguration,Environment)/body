{
  if (conf == null) {
    conf=new SessionConfiguration();
  }
  this.env=env;
  this.sessionInfo=new SessionInfo();
  ReteooStatefulSession session=(ReteooStatefulSession)((KnowledgeBaseImpl)kbase).ruleBase.newStatefulSession((SessionConfiguration)conf,this.env);
  this.ksession=new StatefulKnowledgeSessionImpl(session,kbase);
  this.kContext=new KnowledgeCommandContext(new ContextImpl("ksession",null),null,null,this.ksession,null);
  ((JPASignalManager)((StatefulKnowledgeSessionImpl)ksession).session.getSignalManager()).setCommandService(this);
  this.marshallingHelper=new JPASessionMarshallingHelper(this.ksession,conf);
  this.sessionInfo.setJPASessionMashallingHelper(this.marshallingHelper);
  this.emf=(EntityManagerFactory)env.get(EnvironmentName.ENTITY_MANAGER_FACTORY);
  this.em=emf.createEntityManager();
  boolean localTransaction=false;
  UserTransaction ut=null;
  try {
    InitialContext ctx=new InitialContext();
    ut=(UserTransaction)ctx.lookup("java:comp/UserTransaction");
    if (ut.getStatus() == Status.STATUS_NO_TRANSACTION) {
      ut.begin();
      localTransaction=true;
    }
    registerRollbackSync();
    this.em.joinTransaction();
    this.em.persist(this.sessionInfo);
    if (localTransaction) {
      ut.commit();
    }
  }
 catch (  Throwable t1) {
    try {
      if (ut != null) {
        ut.rollback();
      }
    }
 catch (    Throwable t2) {
      throw new RuntimeException("Could not rollback transaction",t2);
    }
    throw new RuntimeException("Could not commit session",t1);
  }
  ((StatefulKnowledgeSessionImpl)ksession).session.setId(this.sessionInfo.getId());
}
