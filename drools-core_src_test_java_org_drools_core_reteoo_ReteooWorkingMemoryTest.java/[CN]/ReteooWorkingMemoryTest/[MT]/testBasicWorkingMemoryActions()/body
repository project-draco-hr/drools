{
  final AbstractWorkingMemory workingMemory=(AbstractWorkingMemory)RuleBaseFactory.newRuleBase().newStatefulSession();
  final TruthMaintenanceSystem tms=((NamedEntryPoint)workingMemory.getWorkingMemoryEntryPoint(EntryPointId.DEFAULT.getEntryPointId())).getTruthMaintenanceSystem();
  final String string="test";
  workingMemory.insert(string);
  FactHandle fd=workingMemory.insertLogical(string);
  assertEquals(1,tms.getEqualityKeyMap().size());
  EqualityKey key=tms.get(string);
  assertSame(fd,key.getFactHandle());
  assertEquals(1,key.size());
  workingMemory.update(fd,string);
  assertEquals(1,tms.getEqualityKeyMap().size());
  key=tms.get(string);
  assertSame(fd,key.getFactHandle());
  assertEquals(1,key.size());
  workingMemory.retract(fd);
  assertEquals(0,tms.getEqualityKeyMap().size());
  key=tms.get(string);
  assertNull(key);
  fd=workingMemory.insert(string);
  assertEquals(1,tms.getEqualityKeyMap().size());
  assertEquals(1,tms.getEqualityKeyMap().size());
  key=tms.get(string);
  assertSame(fd,key.getFactHandle());
  assertEquals(1,key.size());
}
