{
  if (!org.drools.workflow.core.Node.CONNECTION_DEFAULT_TYPE.equals(type)) {
    throw new IllegalArgumentException("An EndNode only accepts default incoming connections!");
  }
  ((NodeInstanceContainer)getNodeInstanceContainer()).removeNodeInstance(this);
  if (getEndNode().isTerminate()) {
    boolean hidden=false;
    if (getNode().getMetaData("hidden") != null) {
      hidden=true;
    }
    WorkingMemory workingMemory=((ProcessInstance)getProcessInstance()).getWorkingMemory();
    if (!hidden) {
      ((EventSupport)workingMemory).getRuleFlowEventSupport().fireBeforeRuleFlowNodeLeft(this,(InternalWorkingMemory)workingMemory);
    }
    ((ProcessInstance)getProcessInstance()).setState(ProcessInstance.STATE_COMPLETED);
    if (!hidden) {
      ((EventSupport)workingMemory).getRuleFlowEventSupport().fireAfterRuleFlowNodeLeft(this,(InternalWorkingMemory)workingMemory);
    }
  }
}
