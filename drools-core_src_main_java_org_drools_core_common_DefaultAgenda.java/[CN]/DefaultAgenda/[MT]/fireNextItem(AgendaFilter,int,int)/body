{
  boolean tryagain;
  int localFireCount=0;
  try {
    do {
      this.workingMemory.prepareToFireActivation();
      tryagain=false;
      final InternalAgendaGroup group=(InternalAgendaGroup)getNextFocus();
      if (group != null) {
        final AgendaItem item=(AgendaItem)group.getNext();
        if (item != null) {
          InternalRuleFlowGroup ruleFlowGroup=null;
          if (item.getActivationNode() != null) {
            ruleFlowGroup=(InternalRuleFlowGroup)item.getActivationNode().getParentContainer();
            ruleFlowGroup.removeActivation(item);
          }
          if (filter == null || filter.accept(item)) {
            if (this.unlinkingEnabled && item.isRuleNetworkEvaluatorActivation()) {
              item.setActivated(false);
              localFireCount=((RuleNetworkEvaluatorActivation)item).evaluateNetwork(this.workingMemory,fireCount,fireLimit);
              if (localFireCount == 0) {
                tryagain=true;
                this.workingMemory.executeQueuedActions();
              }
            }
 else {
              fireActivation(item);
              localFireCount++;
            }
          }
 else {
            this.workingMemory.executeQueuedActions();
            final EventSupport eventsupport=(EventSupport)this.workingMemory;
            eventsupport.getAgendaEventSupport().fireActivationCancelled(item,this.workingMemory,MatchCancelledCause.FILTER);
            tryagain=true;
          }
          if (ruleFlowGroup != null) {
            ruleFlowGroup.deactivateIfEmpty();
            this.workingMemory.executeQueuedActions();
          }
        }
        if ((AgendaItem)group.peekNext() == null || !((AgendaItem)group.peekNext()).getTerminalNode().isFireDirect()) {
          unstageActivations();
        }
      }
    }
 while (tryagain);
  }
  finally {
    this.workingMemory.activationFired();
  }
  return localFireCount;
}
