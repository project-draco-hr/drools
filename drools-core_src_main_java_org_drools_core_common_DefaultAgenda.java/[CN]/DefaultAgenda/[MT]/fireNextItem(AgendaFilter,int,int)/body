{
  boolean tryagain;
  int localFireCount=0;
  try {
    do {
      while (!eager.isEmpty()) {
        RuleAgendaItem item=eager.removeFirst();
        log.trace("Eager Evaluating rule {}.",item.getRule().getName());
        item.getRuleExecutor().evaluateNetwork(this.workingMemory);
      }
      this.workingMemory.prepareToFireActivation();
      tryagain=false;
      final InternalAgendaGroup group=(InternalAgendaGroup)getNextFocus();
      if (group != null) {
        if (this.unlinkingEnabled) {
          final RuleAgendaItem item=(RuleAgendaItem)group.peekNext();
          localFireCount=item.getRuleExecutor().evaluateNetworkAndFire(this.workingMemory,filter,fireCount,fireLimit);
          if (localFireCount == 0) {
            tryagain=true;
            this.workingMemory.executeQueuedActions();
          }
        }
 else {
          final AgendaItem item=(AgendaItem)group.getNext();
          if (item != null) {
            InternalRuleFlowGroup ruleFlowGroup=null;
            if (item.getActivationNode() != null) {
              ruleFlowGroup=(InternalRuleFlowGroup)item.getActivationNode().getParentContainer();
              ruleFlowGroup.removeActivation(item);
            }
            if (filter == null || filter.accept(item)) {
              fireActivation(item);
              localFireCount++;
            }
 else {
              this.workingMemory.executeQueuedActions();
              final EventSupport eventsupport=(EventSupport)this.workingMemory;
              eventsupport.getAgendaEventSupport().fireActivationCancelled(item,this.workingMemory,MatchCancelledCause.FILTER);
              tryagain=true;
            }
            if (ruleFlowGroup != null) {
              ruleFlowGroup.deactivateIfEmpty();
              this.workingMemory.executeQueuedActions();
            }
          }
        }
        if ((AgendaItem)group.peekNext() == null || !((AgendaItem)group.peekNext()).getTerminalNode().isFireDirect()) {
          unstageActivations();
        }
      }
    }
 while (tryagain);
  }
  finally {
    this.workingMemory.activationFired();
  }
  return localFireCount;
}
