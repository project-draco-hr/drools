{
  unstageActivations();
  this.halt.set(false);
  if (log.isDebugEnabled()) {
    log.trace("Starting fireUntilHalt");
  }
  while (continueFiring(-1)) {
    boolean fired=fireNextItem(agendaFilter,0,-1) >= 0 || !((AbstractWorkingMemory)this.workingMemory).getActionQueue().isEmpty();
    this.workingMemory.executeQueuedActions();
    if (!fired) {
      if (!unlinkingEnabled) {
        try {
synchronized (this.halt) {
            if (!this.halt.get()) {
              this.halt.wait();
            }
          }
        }
 catch (        InterruptedException e) {
          this.halt.set(true);
        }
      }
    }
 else {
      this.workingMemory.executeQueuedActions();
    }
  }
  if (log.isDebugEnabled()) {
    log.trace("Ending fireUntilHalt");
  }
  fireUntilHalt=false;
}
