{
  if (this.halt.compareAndSet(true,false)) {
    fireUntilHalt=true;
    try {
      if (log.isTraceEnabled()) {
        log.trace("Starting fireUntilHalt");
      }
      while (continueFiring(-1)) {
        boolean fired=fireNextItem(agendaFilter,0,-1) > 0 || workingMemory.hasPendingPropagations();
        this.workingMemory.flushPropagations();
        if (!fired) {
synchronized (this.halt) {
            if (!this.halt.get()) {
              InternalAgendaGroup nextFocus=getNextFocus();
              if (nextFocus == null || nextFocus.isEmpty()) {
                try {
                  this.halt.wait();
                }
 catch (                InterruptedException e) {
                }
              }
            }
          }
        }
      }
      if (log.isTraceEnabled()) {
        log.trace("Ending fireUntilHalt");
      }
    }
  finally {
      fireUntilHalt=false;
      this.halt.set(true);
    }
  }
}
