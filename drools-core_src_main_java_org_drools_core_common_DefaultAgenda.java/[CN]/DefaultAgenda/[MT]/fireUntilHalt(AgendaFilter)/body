{
synchronized (this) {
    if (currentState == ExecutionState.FIRING_UNTIL_HALT) {
      return;
    }
    waitAndEnterExecutionState(ExecutionState.FIRING_UNTIL_HALT);
  }
  try {
    if (log.isTraceEnabled()) {
      log.trace("Starting fireUntilHalt");
    }
    this.workingMemory.flushPropagations();
    while (isFiring()) {
      workingMemory.flushPropagationsOnFireUntilHalt(fireNextItem(agendaFilter,0,-1) > 0);
    }
    PropagationEntry head=tryHalt();
    while (head != null) {
      workingMemory.flushPropagationsOnFireUntilHalt(fireNextItem(agendaFilter,0,-1) > 0,head);
      head=workingMemory.takeAllPropagations();
    }
    if (log.isTraceEnabled()) {
      log.trace("Ending fireUntilHalt");
    }
  }
  finally {
    immediateHalt();
  }
}
