{
  if (this.halt.compareAndSet(true,false)) {
    try {
      if (log.isTraceEnabled()) {
        log.trace("Starting fireUntilHalt");
      }
      while (isFiring()) {
        boolean fired=fireNextItem(agendaFilter,0,-1) > 0;
        if (!fired) {
synchronized (this.halt) {
            if (!workingMemory.hasPendingPropagations()) {
              try {
                this.halt.wait();
              }
 catch (              InterruptedException e) {
              }
            }
          }
        }
        this.workingMemory.flushPropagations();
      }
      if (log.isTraceEnabled()) {
        log.trace("Ending fireUntilHalt");
      }
    }
  finally {
      this.halt.set(true);
    }
  }
}
