{
  String str="" + "package org.drools.compiler.integrationtests;\n" + "\n"+ "import org.drools.compiler.Father;\n"+ "import org.drools.compiler.TotalHolder;\n"+ "\n"+ "import org.drools.core.common.AgendaItem;\n"+ "import org.kie.internal.event.rule.ActivationUnMatchListener;\n"+ "import org.kie.api.runtime.rule.Session;\n"+ "import org.kie.api.runtime.rule.Match;\n"+ "\n"+ "global TotalHolder totalHolder;\n"+ "\n"+ "rule \"sumWeightOfFather\"\n"+ "when\n"+ "    $h: Father(father != null, $wf : weightOfFather)\n"+ "then\n"+ "    totalHolder.add($wf);\n"+ "    final TotalHolder finalTotalHolder = totalHolder;\n"+ "    final int finalWf = $wf;\n"+ "    AgendaItem agendaItem = (AgendaItem) kcontext.getMatch();"+ "    if (agendaItem.getActivationUnMatchListener() != null) {\n"+ "        Session session = null; // Should not be used by the undoListener anyway\n"+ "        agendaItem.getActivationUnMatchListener().unMatch(session, agendaItem);\n"+ "    }"+ "    agendaItem.setActivationUnMatchListener(new ActivationUnMatchListener() {"+ "            public void unMatch(Session session, Match match) {"+ "                finalTotalHolder.subtract(finalWf);"+ "            }"+ "    });"+ "end";
  KnowledgeBuilder kbuilder=KnowledgeBuilderFactory.newKnowledgeBuilder();
  kbuilder.add(ResourceFactory.newByteArrayResource(str.getBytes()),ResourceType.DRL);
  assertFalse(kbuilder.getErrors().toString(),kbuilder.hasErrors());
  KnowledgeBase kbase=KnowledgeBaseFactory.newKnowledgeBase();
  kbase.addKnowledgePackages(kbuilder.getKnowledgePackages());
  StatefulKnowledgeSession kSession=createKnowledgeSession(kbase);
  kSession.setGlobal("totalHolder",new TotalHolder());
  Father abraham=new Father("abraham",null,100);
  Father homer=new Father("homer",null,20);
  Father bart=new Father("bart",null,3);
  org.kie.api.runtime.rule.FactHandle abrahamHandle=kSession.insert(abraham);
  org.kie.api.runtime.rule.FactHandle bartHandle=kSession.insert(bart);
  kSession.fireAllRules();
  assertEquals(0,((TotalHolder)kSession.getGlobal("totalHolder")).getTotal());
  bart.setFather(abraham);
  kSession.update(bartHandle,bart);
  kSession.fireAllRules();
  assertEquals(100,((TotalHolder)kSession.getGlobal("totalHolder")).getTotal());
  bart.setFather(null);
  kSession.update(bartHandle,bart);
  kSession.fireAllRules();
  assertEquals(0,((TotalHolder)kSession.getGlobal("totalHolder")).getTotal());
  bart.setFather(abraham);
  kSession.update(bartHandle,bart);
  kSession.fireAllRules();
  assertEquals(100,((TotalHolder)kSession.getGlobal("totalHolder")).getTotal());
  org.kie.api.runtime.rule.FactHandle homerHandle=kSession.insert(homer);
  homer.setFather(abraham);
  kSession.update(homerHandle,homer);
  bart.setFather(homer);
  kSession.update(bartHandle,bart);
  kSession.fireAllRules();
  assertEquals(120,((TotalHolder)kSession.getGlobal("totalHolder")).getTotal());
}
