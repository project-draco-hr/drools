{
  PortableWorkDefinition pwd=null;
  Map<String,List<String>> setStatements=new HashMap<String,List<String>>();
  Map<String,String> factsType=new HashMap<String,String>();
  int lineCounter=-1;
  for (  String line : rhs.split("\n")) {
    lineCounter++;
    if (expandedDRLInfo.hasDsl) {
      String dslLine=expandedDRLInfo.dslStatementsInRhs.get(lineCounter);
      while (dslLine != null) {
        m.addRhsItem(toDSLSentence(expandedDRLInfo.rhsDslPatterns,dslLine));
        dslLine=expandedDRLInfo.dslStatementsInRhs.get(++lineCounter);
      }
    }
    line=line.trim();
    if (line.startsWith("insertLogical")) {
      String fact=unwrapParenthesis(line);
      String type=getStatementType(fact,factsType);
      if (type != null) {
        ActionInsertLogicalFact action=new ActionInsertLogicalFact(type);
        m.addRhsItem(action);
        if (factsType.containsKey(fact)) {
          addSettersToAction(setStatements,fact,action,isJavaDialect);
        }
      }
    }
 else     if (line.startsWith("insert")) {
      String fact=unwrapParenthesis(line);
      String type=getStatementType(fact,factsType);
      if (type != null) {
        ActionInsertFact action=new ActionInsertFact(type);
        m.addRhsItem(action);
        if (factsType.containsKey(fact)) {
          action.setBoundName(fact);
          addSettersToAction(setStatements,fact,action,isJavaDialect);
        }
      }
    }
 else     if (line.startsWith("update")) {
      String variable=unwrapParenthesis(line);
      ActionUpdateField action=new ActionUpdateField();
      action.setVariable(variable);
      m.addRhsItem(action);
      addSettersToAction(setStatements,variable,action,isJavaDialect);
    }
 else     if (line.startsWith("retract")) {
      String variable=unwrapParenthesis(line);
      m.addRhsItem(new ActionRetractFact(variable));
    }
 else     if (line.startsWith("org.drools.core.process.instance.impl.WorkItemImpl wiWorkItem")) {
      ActionExecuteWorkItem awi=new ActionExecuteWorkItem();
      pwd=new PortableWorkDefinition();
      pwd.setName("WorkItem");
      awi.setWorkDefinition(pwd);
      m.addRhsItem(awi);
    }
 else     if (line.startsWith("wiWorkItem.getParameters().put")) {
      String statement=line.substring("wiWorkItem.getParameters().put".length());
      statement=unwrapParenthesis(statement);
      int commaPos=statement.indexOf(',');
      String name=statement.substring(0,commaPos).trim();
      String value=statement.substring(commaPos + 1).trim();
      pwd.addParameter(buildPortableParameterDefinition(name,value,boundParams));
    }
 else     if (line.startsWith("wim.internalExecuteWorkItem") || line.startsWith("wiWorkItem.setName")) {
    }
 else {
      int dotPos=line.indexOf('.');
      int argStart=line.indexOf('(');
      if (dotPos > 0 && argStart > dotPos) {
        String variable=line.substring(0,dotPos).trim();
        String methodName=line.substring(dotPos + 1,argStart).trim();
        if (isJavaIdentifier(methodName)) {
          if (getSettedField(methodName) != null) {
            List<String> setters=setStatements.get(variable);
            if (setters == null) {
              setters=new ArrayList<String>();
              setStatements.put(variable,setters);
            }
            setters.add(line);
          }
 else           if (methodName.equals("add") && expandedDRLInfo.hasGlobal(variable)) {
            String factName=line.substring(argStart + 1,line.lastIndexOf(')')).trim();
            ActionGlobalCollectionAdd actionGlobalCollectionAdd=new ActionGlobalCollectionAdd();
            actionGlobalCollectionAdd.setGlobalName(variable);
            actionGlobalCollectionAdd.setFactName(factName);
            m.addRhsItem(actionGlobalCollectionAdd);
          }
 else {
            ActionCallMethod acm=new ActionCallMethod();
            acm.setMethodName(methodName);
            acm.setVariable(variable);
            acm.setState(1);
            m.addRhsItem(acm);
            String params=unwrapParenthesis(line);
            for (            String param : params.split(",")) {
              param=param.trim();
              if (param.length() == 0) {
                continue;
              }
              String dataType=inferDataType(param,isJavaDialect);
              acm.addFieldValue(new ActionFieldFunction(null,adjustParam(dataType,param,isJavaDialect),dataType));
            }
          }
          continue;
        }
      }
      int eqPos=line.indexOf('=');
      if (eqPos > 0) {
        String field=line.substring(0,eqPos).trim();
        String[] split=field.split(" ");
        if (split.length == 2) {
          factsType.put(split[1],split[0]);
        }
      }
 else       if (line.trim().length() > 0) {
        FreeFormLine ffl=new FreeFormLine();
        ffl.setText(line);
        m.addRhsItem(ffl);
      }
    }
  }
  for (  Map.Entry<String,List<String>> entry : setStatements.entrySet()) {
    ActionSetField action=new ActionSetField(entry.getKey());
    addSettersToAction(entry.getValue(),action,isJavaDialect);
    m.addRhsItem(action);
  }
  if (expandedDRLInfo.hasDsl) {
    String dslLine=expandedDRLInfo.dslStatementsInRhs.get(++lineCounter);
    while (dslLine != null) {
      m.addRhsItem(toDSLSentence(expandedDRLInfo.rhsDslPatterns,dslLine));
      dslLine=expandedDRLInfo.dslStatementsInRhs.get(++lineCounter);
    }
  }
}
