{
  ClassLoader classLoader=Thread.currentThread().getContextClassLoader();
  final Enumeration<URL> e;
  try {
    e=classLoader.getResources("META-INF/kproject.xml");
  }
 catch (  IOException exc) {
    log.error("Unable to find and build index of kproject.xml \n" + exc.getMessage());
    return;
  }
  List<KieModuleModel> kProjects=new ArrayList<KieModuleModel>();
  Map<KieModuleModel,String> urls=new IdentityHashMap<KieModuleModel,String>();
  while (e.hasMoreElements()) {
    URL url=e.nextElement();
    ;
    try {
      KieModuleModel kieProject=KieModuleModelImpl.fromXML(url);
      kProjects.add(kieProject);
      String fixedURL=fixURL(url);
      urls.put(kieProject,fixedURL);
    }
 catch (    Exception exc) {
      log.error("Unable to build and build index of kproject.xml url=" + url.toExternalForm() + "\n"+ exc.getMessage());
    }
  }
  for (  KieModuleModel kieProject : kProjects) {
    String url=urls.get(kieProject);
    String strGAV=getPomProperties(url);
    if (StringUtils.isEmpty(strGAV)) {
      continue;
    }
    GAV gav=null;
    try {
      gav=GAVImpl.fromPropertiesString(strGAV);
    }
 catch (    Exception ex) {
      log.error("Unable to build GAV for path " + url + "\n    {}",ex);
    }
    String rootPath=url;
    if (rootPath.lastIndexOf(':') > 0) {
      rootPath=url.substring(rootPath.lastIndexOf(':') + 1);
    }
    File file=new File(rootPath);
    FileKieModule kieJar=new FileKieModule(gav,kieProject,file);
    for (    KieBaseModel kieBaseModel : kieProject.getKieBaseModels().values()) {
      kBases.put(kieBaseModel.getName(),kieBaseModel);
      ((KieBaseModelImpl)kieBaseModel).setKProject(kieProject);
      kBaseURLs.put(kieBaseModel.getName(),url);
      for (      KieSessionModel kieSessionModel : kieBaseModel.getKieSessionModels().values()) {
        ((KieSessionModelImpl)kieSessionModel).setKBase(kieBaseModel);
        kSessions.put(kieSessionModel.getName(),kieSessionModel);
      }
    }
  }
}
