{
  this.workingMemory.startOperation();
  try {
    increaseDormantActivations();
    final EventSupport eventsupport=(EventSupport)this.workingMemory;
    eventsupport.getAgendaEventSupport().fireBeforeActivationFired(activation,this.workingMemory);
    if (activation.getActivationGroupNode() != null) {
      final ActivationGroup activationGroup=activation.getActivationGroupNode().getActivationGroup();
      activationGroup.removeActivation(activation);
      clearAndCancelActivationGroup(activationGroup);
    }
    activation.setActivated(false);
    if (activation.getActivationNode() != null) {
      final InternalRuleFlowGroup ruleFlowGroup=(InternalRuleFlowGroup)activation.getActivationNode().getParentContainer();
      ruleFlowGroup.removeActivation(activation);
    }
    try {
      this.knowledgeHelper.setActivation(activation);
      activation.getRule().getConsequence().evaluate(this.knowledgeHelper,this.workingMemory);
      this.knowledgeHelper.cancelRemainingPreviousLogicalDependencies();
      this.knowledgeHelper.reset();
    }
 catch (    final Exception e) {
      if (this.legacyConsequenceExceptionHandler != null) {
        this.legacyConsequenceExceptionHandler.handleException(activation,this.workingMemory,e);
      }
 else       if (this.consequenceExceptionHandler != null) {
        this.consequenceExceptionHandler.handleException(activation,new StatefulKnowledgeSessionImpl((ReteooWorkingMemory)this.workingMemory),e);
      }
 else {
        throw new RuntimeException(e);
      }
    }
    for (LeftTuple tuple=(LeftTuple)activation.getTuple(); tuple != null; tuple=tuple.getParent()) {
      if (tuple.getLastHandle().isEvent()) {
        EventFactHandle handle=(EventFactHandle)tuple.getLastHandle();
        if (handle.isExpired()) {
          handle.decreaseActivationsCount();
          if (handle.getActivationsCount() == 0) {
            handle.getEntryPoint().retract(handle);
          }
        }
      }
    }
    eventsupport.getAgendaEventSupport().fireAfterActivationFired(activation,this.workingMemory);
  }
  finally {
    this.workingMemory.endOperation();
  }
}
