{
  boolean tryagain, result;
  try {
    do {
      this.workingMemory.prepareToFireActivation();
      tryagain=result=false;
      final InternalAgendaGroup group=(InternalAgendaGroup)getNextFocus();
      if (group != null) {
        final AgendaItem item=(AgendaItem)group.getNext();
        if (item != null) {
          InternalRuleFlowGroup ruleFlowGroup=null;
          if (item.getActivationNode() != null) {
            ruleFlowGroup=(InternalRuleFlowGroup)item.getActivationNode().getParentContainer();
            ruleFlowGroup.removeActivation(item);
          }
          if (filter == null || filter.accept(item)) {
            fireActivation(item);
            result=true;
          }
 else {
            this.workingMemory.executeQueuedActions();
            final EventSupport eventsupport=(EventSupport)this.workingMemory;
            eventsupport.getAgendaEventSupport().fireActivationCancelled(item,this.workingMemory,ActivationCancelledCause.FILTER);
            tryagain=true;
          }
          if (ruleFlowGroup != null) {
            ruleFlowGroup.deactivateIfEmpty();
            this.workingMemory.executeQueuedActions();
          }
        }
      }
    }
 while (tryagain);
  }
  finally {
    this.workingMemory.activationFired();
  }
  return result;
}
