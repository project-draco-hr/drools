{
  RuleFlowProcess process=new RuleFlowProcess();
  process.setId("org.drools.process.process");
  process.setName("Process");
  StartNode startNode=new StartNode();
  startNode.setName("Start");
  startNode.setId(1);
  process.addNode(startNode);
  EndNode endNode=new EndNode();
  endNode.setName("EndNode");
  endNode.setId(2);
  process.addNode(endNode);
  SubProcessNode subProcessNode=new SubProcessNode();
  subProcessNode.setName("SubProcessNode");
  subProcessNode.setId(3);
  subProcessNode.setProcessId("org.drools.process.subprocess");
  process.addNode(subProcessNode);
  new ConnectionImpl(startNode,Node.CONNECTION_DEFAULT_TYPE,subProcessNode,Node.CONNECTION_DEFAULT_TYPE);
  new ConnectionImpl(subProcessNode,Node.CONNECTION_DEFAULT_TYPE,endNode,Node.CONNECTION_DEFAULT_TYPE);
  AbstractRuleBase ruleBase=(AbstractRuleBase)RuleBaseFactory.newRuleBase();
  ruleBase.addProcess(process);
  process=new RuleFlowProcess();
  process.setId("org.drools.process.subprocess");
  process.setName("SubProcess");
  startNode=new StartNode();
  startNode.setName("Start");
  startNode.setId(1);
  process.addNode(startNode);
  endNode=new EndNode();
  endNode.setName("EndNode");
  endNode.setId(2);
  process.addNode(endNode);
  WorkItemNode workItemNode=new WorkItemNode();
  workItemNode.setName("WorkItem");
  Work work=new WorkImpl();
  work.setName("MyWork");
  workItemNode.setWork(work);
  process.addNode(workItemNode);
  new ConnectionImpl(startNode,Node.CONNECTION_DEFAULT_TYPE,workItemNode,Node.CONNECTION_DEFAULT_TYPE);
  new ConnectionImpl(workItemNode,Node.CONNECTION_DEFAULT_TYPE,endNode,Node.CONNECTION_DEFAULT_TYPE);
  ruleBase.addProcess(process);
  InternalWorkingMemory workingMemory=new ReteooWorkingMemory(1,ruleBase);
  workingMemory.getWorkItemManager().registerWorkItemHandler("MyWork",new WorkItemHandler(){
    public void executeWorkItem(    WorkItem workItem,    WorkItemManager manager){
      System.out.println("Executing work item");
      SubProcessTest.this.workItem=workItem;
    }
    public void abortWorkItem(    WorkItem workItem,    WorkItemManager manager){
    }
  }
);
  workingMemory.startProcess("org.drools.process.process");
  assertNotNull(workItem);
  assertEquals(2,workingMemory.getProcessInstances().size());
  workingMemory.getWorkItemManager().completeWorkItem(workItem.getId(),null);
  assertEquals(0,workingMemory.getProcessInstances().size());
}
