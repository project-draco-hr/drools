{
  if (log.isTraceEnabled()) {
    log.trace("Update {}",handle.toString());
  }
  if (objectTypeConf.isShadowEnabled()) {
    ((ShadowProxy)handle.getObject()).updateProxy();
  }
  ObjectTypeNode[] cachedNodes=objectTypeConf.getObjectTypeNodes();
  ModifyPreviousTuples modifyPreviousTuples=new ModifyPreviousTuples(handle.getFirstLeftTuple(),handle.getFirstRightTuple(),unlinkingEnabled);
  handle.clearLeftTuples();
  handle.clearRightTuples();
  for (int i=0, length=cachedNodes.length; i < length; i++) {
    cachedNodes[i].modifyObject(handle,modifyPreviousTuples,context,wm);
    if (i < cachedNodes.length - 1) {
      RightTuple rightTuple=modifyPreviousTuples.peekRightTuple();
      while (rightTuple != null && ((BetaNode)rightTuple.getRightTupleSink()).getObjectTypeNode() == cachedNodes[i]) {
        modifyPreviousTuples.removeRightTuple();
        if (unlinkingEnabled) {
          BetaMemory bm=BetaNode.getBetaMemory((BetaNode)rightTuple.getRightTupleSink(),wm);
          BetaNode.doDeleteRightTuple(rightTuple,wm,bm);
        }
 else {
          ((BetaNode)rightTuple.getRightTupleSink()).retractRightTuple(rightTuple,context,wm);
        }
        rightTuple=modifyPreviousTuples.peekRightTuple();
      }
      LeftTuple leftTuple;
      ObjectTypeNode otn;
      while (true) {
        leftTuple=modifyPreviousTuples.peekLeftTuple();
        otn=null;
        if (leftTuple != null) {
          LeftTupleSink leftTupleSink=leftTuple.getLeftTupleSink();
          if (leftTupleSink instanceof LeftTupleSource) {
            otn=((LeftTupleSource)leftTupleSink).getLeftTupleSource().getObjectTypeNode();
          }
 else           if (leftTupleSink instanceof RuleTerminalNode) {
            otn=((RuleTerminalNode)leftTupleSink).getObjectTypeNode();
          }
        }
        if (otn == null || otn == cachedNodes[i + 1])         break;
        modifyPreviousTuples.removeLeftTuple();
        if (unlinkingEnabled) {
          LeftInputAdapterNode liaNode=(LeftInputAdapterNode)leftTuple.getLeftTupleSink().getLeftTupleSource();
          LiaNodeMemory lm=(LiaNodeMemory)wm.getNodeMemory(liaNode);
          LeftInputAdapterNode.doDeleteObject(leftTuple,context,lm.getSegmentMemory(),wm,liaNode,true,lm);
        }
 else {
          leftTuple.getLeftTupleSink().retractLeftTuple(leftTuple,context,wm);
        }
      }
    }
  }
  modifyPreviousTuples.retractTuples(context,wm);
}
