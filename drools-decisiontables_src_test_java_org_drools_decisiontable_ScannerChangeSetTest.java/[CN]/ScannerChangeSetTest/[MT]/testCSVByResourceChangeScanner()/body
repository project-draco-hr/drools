{
  String first=fileManager.readInputStreamReaderAsString(new InputStreamReader(getClass().getResourceAsStream("changeSetTestCSV.csv")));
  String second=fileManager.readInputStreamReaderAsString(new InputStreamReader(getClass().getResourceAsStream("changeSetTestCSV2.csv")));
  File file=new File(TMP_DIR + "scannerChangeSetTestCSV.csv");
  file.delete();
  fileManager.write(file,first);
  Thread.sleep(1100);
  ResourceChangeScannerConfiguration config=ResourceFactory.getResourceChangeScannerService().newResourceChangeScannerConfiguration();
  config.setProperty("drools.resource.scanner.interval","1");
  ResourceFactory.getResourceChangeScannerService().configure(config);
  ResourceFactory.getResourceChangeNotifierService().start();
  ResourceFactory.getResourceChangeScannerService().start();
  KnowledgeAgent kagent=KnowledgeAgentFactory.newKnowledgeAgent("csv agent");
  kagent.applyChangeSet(ResourceFactory.newClassPathResource("scannerChangeSetTestCSV.xml",getClass()));
  KnowledgeBase kbase=kagent.getKnowledgeBase();
  assertEquals(1,kbase.getKnowledgePackages().size());
  assertEquals(3,kbase.getKnowledgePackages().iterator().next().getRules().size());
  Thread.sleep(1100);
  file.delete();
  fileManager.write(file,second);
  Thread.sleep(1100);
  try {
    kbase=kagent.getKnowledgeBase();
    assertEquals(1,kbase.getKnowledgePackages().size());
    assertEquals(2,kbase.getKnowledgePackages().iterator().next().getRules().size());
  }
  finally {
    ResourceFactory.getResourceChangeNotifierService().stop();
    ResourceFactory.getResourceChangeScannerService().stop();
    file.delete();
    kagent.dispose();
  }
}
