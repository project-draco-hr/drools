{
  Marshaller marshaller=new DefaultMarshaller();
  ByteArrayOutputStream baos=new ByteArrayOutputStream();
  ruleBase.writeStatefulSession(session,baos,marshaller);
  byte[] b1=baos.toByteArray();
  ByteArrayInputStream bais=new ByteArrayInputStream(b1);
  StatefulSession session2=ruleBase.readStatefulSession(bais,true,marshaller,((InternalWorkingMemory)session).getSessionConfiguration(),session.getEnvironment());
  marshaller=new DefaultMarshaller();
  baos=new ByteArrayOutputStream();
  ruleBase.writeStatefulSession(session2,baos,marshaller);
  byte[] b2=baos.toByteArray();
  if (!areByteArraysEqual(b1,b2)) {
    throw new IllegalArgumentException("byte streams for serialisation test are not equal");
  }
  session2.setGlobalResolver(session.getGlobalResolver());
  if (dispose) {
    session.dispose();
  }
  return session2;
}
