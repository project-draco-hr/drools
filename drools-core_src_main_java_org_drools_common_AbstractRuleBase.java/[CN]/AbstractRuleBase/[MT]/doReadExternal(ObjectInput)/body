{
  this.pkgs=(Map)stream.readObject();
  if (stream instanceof DroolsObjectInputStream) {
    final DroolsObjectInputStream parentStream=(DroolsObjectInputStream)stream;
    parentStream.setRuleBase(this);
    this.packageClassLoader=new CompositePackageClassLoader(parentStream.getClassLoader());
    this.classLoader=new MapBackedClassLoader(parentStream.getClassLoader());
  }
 else {
    this.packageClassLoader=new CompositePackageClassLoader(Thread.currentThread().getContextClassLoader());
    this.classLoader=new MapBackedClassLoader(Thread.currentThread().getContextClassLoader());
  }
  this.packageClassLoader.addClassLoader(this.classLoader);
  for (final Iterator it=this.pkgs.values().iterator(); it.hasNext(); ) {
    this.packageClassLoader.addClassLoader(((Package)it.next()).getPackageCompilationData().getClassLoader());
  }
  final byte[] bytes=(byte[])stream.readObject();
  final DroolsObjectInputStream childStream=new DroolsObjectInputStream(new ByteArrayInputStream(bytes),this.packageClassLoader);
  childStream.setRuleBase(this);
  this.id=(String)childStream.readObject();
  this.processes=(Map)childStream.readObject();
  this.agendaGroupRuleTotals=(Map)childStream.readObject();
  this.factHandleFactory=(FactHandleFactory)childStream.readObject();
  this.globals=(Map)childStream.readObject();
  this.config=(RuleBaseConfiguration)childStream.readObject();
  this.config.setClassLoader(childStream.getClassLoader());
  this.eventSupport=(RuleBaseEventSupport)childStream.readObject();
  this.eventSupport.setRuleBase(this);
  this.statefulSessions=new ObjectHashSet();
}
