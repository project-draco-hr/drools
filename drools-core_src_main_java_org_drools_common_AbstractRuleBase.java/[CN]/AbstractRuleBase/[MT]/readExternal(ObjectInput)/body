{
  DroolsObjectInput droolsStream;
  boolean isDrools=in instanceof DroolsObjectInputStream;
  ByteArrayInputStream bytes=null;
  if (isDrools) {
    droolsStream=(DroolsObjectInput)in;
  }
 else {
    bytes=new ByteArrayInputStream((byte[])in.readObject());
    droolsStream=new DroolsObjectInputStream(bytes);
  }
  boolean classLoaderCacheEnabled=droolsStream.readBoolean();
  this.rootClassLoader=ClassLoaderUtil.getClassLoader(new ClassLoader[]{droolsStream.getParentClassLoader()},getClass(),classLoaderCacheEnabled);
  droolsStream.setClassLoader(this.rootClassLoader);
  droolsStream.setRuleBase(this);
  JavaDialectRuntimeData typeStore=(JavaDialectRuntimeData)droolsStream.readObject();
  this.declarationClassLoader=new JavaDialectRuntimeData.TypeDeclarationClassLoader(typeStore,this.rootClassLoader);
  this.rootClassLoader.addClassLoader(this.declarationClassLoader);
  this.classFieldAccessorCache=new ClassFieldAccessorCache(this.rootClassLoader);
  this.config=(RuleBaseConfiguration)droolsStream.readObject();
  this.config.setClassLoader(droolsStream.getParentClassLoader());
  this.pkgs=(Map<String,Package>)droolsStream.readObject();
  for (  final Object object : this.pkgs.values()) {
    ((Package)object).getDialectRuntimeRegistry().onAdd(this.rootClassLoader);
  }
  this.id=(String)droolsStream.readObject();
  this.workingMemoryCounter.set(droolsStream.readInt());
  this.processes=(Map)droolsStream.readObject();
  this.agendaGroupRuleTotals=(Map)droolsStream.readObject();
  Class cls=null;
  try {
    cls=droolsStream.getParentClassLoader().loadClass(droolsStream.readUTF());
    this.factHandleFactory=(FactHandleFactory)cls.newInstance();
  }
 catch (  InstantiationException e) {
    DroolsObjectInputStream.newInvalidClassException(cls,e);
  }
catch (  IllegalAccessException e) {
    DroolsObjectInputStream.newInvalidClassException(cls,e);
  }
  for (  final Object object : this.pkgs.values()) {
    ((Package)object).getDialectRuntimeRegistry().onBeforeExecute();
    ((Package)object).getClassFieldAccessorStore().setClassFieldAccessorCache(this.classFieldAccessorCache);
    ((Package)object).getClassFieldAccessorStore().wire();
  }
  this.populateTypeDeclarationMaps();
  Map<String,String> globs=(Map<String,String>)droolsStream.readObject();
  populateGlobalsMap(globs);
  this.partitionIDs=(List<RuleBasePartitionId>)droolsStream.readObject();
  this.eventSupport=(RuleBaseEventSupport)droolsStream.readObject();
  this.eventSupport.setRuleBase(this);
  this.statefulSessions=new ObjectHashSet();
  if (!isDrools) {
    droolsStream.close();
  }
  this.getConfiguration().getComponentFactory().getTraitFactory().setRuleBase(this);
}
