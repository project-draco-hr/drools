{
  KnowledgeBuilder kbuilder=KnowledgeBuilderFactory.newKnowledgeBuilder();
  kbuilder.add(ResourceFactory.newClassPathResource("test_SmooksDirectRoot.drl",DroolsSmookStatefulSessionTest.class),ResourceType.DRL);
  assertFalse(kbuilder.hasErrors());
  KnowledgeBase kbase=KnowledgeBaseFactory.newKnowledgeBase();
  kbase.addKnowledgePackages(kbuilder.getKnowledgePackages());
  StatefulKnowledgeSession ksession=kbase.newStatefulKnowledgeSession();
  List list=new ArrayList();
  ksession.setGlobal("list",list);
  Smooks smooks=new Smooks(getClass().getResourceAsStream("smooks-config.xml"));
  Transformer transformer=PipelineFactory.newSmooksTransformer(smooks,"orderItem");
  transformer.addReceiver(PipelineFactory.newStatefulKnowledgeSessionReceiverAdapter());
  StatefulKnowledgeSessionDataLoader dataLoader=DataLoaderFactory.newStatefulKnowledgeSessionDataLoader(ksession,transformer);
  Map<FactHandle,Object> handles=dataLoader.insert(new StreamSource(getClass().getResourceAsStream("SmooksDirectRoot.xml")));
  ksession.fireAllRules();
  assertEquals(1,handles.size());
  assertEquals(1,list.size());
  assertEquals("example.OrderItem",list.get(0).getClass().getName());
}
