{
  while (SegmentUtilities.parentInSameSegment(tupleSource)) {
    tupleSource=tupleSource.getLeftTupleSource();
  }
  LeftTupleSource segmentRoot=tupleSource;
  SegmentMemory smem=new SegmentMemory(segmentRoot);
  long nodePosMask=1;
  long allLinkedTestMask=0;
  while (true) {
    if (NodeTypeEnums.isBetaNode(tupleSource)) {
      BetaMemory betaMemory;
      BetaNode betaNode=(BetaNode)tupleSource;
      if (NodeTypeEnums.AccumulateNode == tupleSource.getType()) {
        betaMemory=((AccumulateMemory)smem.createNodeMemory((AccumulateNode)tupleSource,wm)).getBetaMemory();
      }
 else {
        betaMemory=(BetaMemory)smem.createNodeMemory(betaNode,wm);
      }
      if (betaNode.isRightInputIsRiaNode()) {
        LeftTupleSinkNode sinkNode=betaNode.getLeftTupleSource().getSinkPropagator().getFirstLeftTupleSink();
        while (sinkNode.getNextLeftTupleSinkNode() != betaNode) {
          sinkNode=sinkNode.getNextLeftTupleSinkNode();
        }
        Memory mem=wm.getNodeMemory((MemoryFactory)sinkNode);
        SegmentMemory subNetworkSegmentMemory=mem.getSegmentMemory();
        if (subNetworkSegmentMemory == null) {
          subNetworkSegmentMemory=createSegmentMemory((LeftTupleSource)sinkNode,wm);
        }
        betaMemory.setSubnetworkSegmentMemory(subNetworkSegmentMemory);
      }
      betaMemory.setSegmentMemory(smem);
      betaMemory.setNodePosMaskBit(nodePosMask);
      allLinkedTestMask=allLinkedTestMask | nodePosMask;
      if (NodeTypeEnums.NotNode == tupleSource.getType() || NodeTypeEnums.AccumulateNode == tupleSource.getType()) {
        smem.linkNode(nodePosMask,wm);
      }
      nodePosMask=nodePosMask << 1;
    }
 else     if (tupleSource.getType() == NodeTypeEnums.LeftInputAdapterNode) {
      LiaNodeMemory liaMemory=(LiaNodeMemory)smem.createNodeMemory((LeftInputAdapterNode)tupleSource,wm);
      liaMemory.setSegmentMemory(smem);
      liaMemory.setNodePosMaskBit(nodePosMask);
      allLinkedTestMask=allLinkedTestMask | nodePosMask;
      nodePosMask=nodePosMask << 1;
    }
 else     if (tupleSource.getType() == NodeTypeEnums.EvalConditionNode) {
      EvalMemory evalMemory=(EvalMemory)smem.createNodeMemory((EvalConditionNode)tupleSource,wm);
      evalMemory.setSegmentMemory(smem);
    }
 else     if (tupleSource.getType() == NodeTypeEnums.FromNode) {
      FromMemory fromMemory=(FromMemory)smem.createNodeMemory((FromNode)tupleSource,wm);
      fromMemory.getBetaMemory().setSegmentMemory(smem);
    }
    LeftTupleSinkPropagator sink=tupleSource.getSinkPropagator();
    LeftTupleSinkNode firstSink=(LeftTupleSinkNode)sink.getFirstLeftTupleSink();
    LeftTupleSinkNode secondSink=firstSink.getNextLeftTupleSinkNode();
    if (secondSink == null) {
      if (NodeTypeEnums.isLeftTupleSource(firstSink)) {
        tupleSource=(LeftTupleSource)firstSink;
      }
 else {
        if (firstSink.getType() == NodeTypeEnums.RightInputAdaterNode) {
          RiaNodeMemory memory=(RiaNodeMemory)wm.getNodeMemory((MemoryFactory)firstSink);
          smem.getNodeMemories().add(memory.getRiaRuleMemory());
          memory.getRiaRuleMemory().setSegmentMemory(smem);
        }
 else         if (NodeTypeEnums.isTerminalNode(firstSink)) {
          RuleMemory rmem=(RuleMemory)wm.getNodeMemory((MemoryFactory)firstSink);
          smem.getNodeMemories().add(rmem);
          rmem.setSegmentMemory(smem);
        }
        smem.setTipNode(firstSink);
        break;
      }
    }
 else     if (sink.size() == 2 && NodeTypeEnums.isBetaNode(secondSink) && ((BetaNode)secondSink).isRightInputIsRiaNode()) {
      tupleSource=(LeftTupleSource)secondSink;
    }
 else {
      smem.setTipNode(tupleSource);
      break;
    }
  }
  smem.setAllLinkedMaskTest(allLinkedTestMask);
  LeftTupleSource parent=segmentRoot;
  int ruleSegmentPosMask=1;
  int counter=0;
  while (parent.getLeftTupleSource() != null) {
    if (!SegmentUtilities.parentInSameSegment(parent)) {
      ruleSegmentPosMask=ruleSegmentPosMask << 1;
      counter++;
    }
    parent=parent.getLeftTupleSource();
  }
  smem.setSegmentPosMaskBit(ruleSegmentPosMask);
  smem.setPos(counter);
  SegmentUtilities.updateRiaAndTerminalMemory(0,tupleSource,tupleSource,smem,wm);
  return smem;
}
