{
  while (SegmentUtilities.parentInSameSegment(tupleSource)) {
    tupleSource=tupleSource.getLeftTupleSource();
  }
  LeftTupleSource segmentRoot=tupleSource;
  SegmentMemory smem=new SegmentMemory(segmentRoot);
  long nodePosMask=1;
  long allLinkedTestMask=0;
  while (true) {
    if (NodeTypeEnums.isBetaNode(tupleSource)) {
      BetaMemory betaMemory;
      BetaNode betaNode=(BetaNode)tupleSource;
      if (NodeTypeEnums.AccumulateNode == tupleSource.getType()) {
        betaMemory=((AccumulateMemory)smem.createNodeMemory((AccumulateNode)tupleSource,wm)).getBetaMemory();
      }
 else {
        betaMemory=(BetaMemory)smem.createNodeMemory(betaNode,wm);
      }
      if (betaNode.isRightInputIsRiaNode()) {
        RightInputAdapterNode riaNode=(RightInputAdapterNode)betaNode.getRightInput();
        LeftTupleSource subnetworkLts=riaNode.getLeftTupleSource();
        while (subnetworkLts.getLeftTupleSource() != riaNode.getStartTupleSource()) {
          subnetworkLts=subnetworkLts.getLeftTupleSource();
        }
        Memory rootSubNetwokrMem=wm.getNodeMemory((MemoryFactory)subnetworkLts);
        SegmentMemory subNetworkSegmentMemory=rootSubNetwokrMem.getSegmentMemory();
        if (subNetworkSegmentMemory == null) {
          subNetworkSegmentMemory=createSegmentMemory((LeftTupleSource)subnetworkLts,wm);
        }
        RiaNodeMemory riaMem=(RiaNodeMemory)wm.getNodeMemory((MemoryFactory)riaNode);
        betaMemory.setRiaRuleMemory(riaMem.getRiaPathMemory());
      }
      betaMemory.setSegmentMemory(smem);
      betaMemory.setNodePosMaskBit(nodePosMask);
      allLinkedTestMask=allLinkedTestMask | nodePosMask;
      if (NodeTypeEnums.NotNode == tupleSource.getType() || NodeTypeEnums.AccumulateNode == tupleSource.getType()) {
        smem.linkNode(nodePosMask,wm);
      }
      nodePosMask=nodePosMask << 1;
    }
 else     if (tupleSource.getType() == NodeTypeEnums.LeftInputAdapterNode) {
      LiaNodeMemory liaMemory=(LiaNodeMemory)smem.createNodeMemory((LeftInputAdapterNode)tupleSource,wm);
      liaMemory.setSegmentMemory(smem);
      liaMemory.setNodePosMaskBit(nodePosMask);
      allLinkedTestMask=allLinkedTestMask | nodePosMask;
      nodePosMask=nodePosMask << 1;
    }
 else     if (tupleSource.getType() == NodeTypeEnums.EvalConditionNode) {
      EvalMemory evalMemory=(EvalMemory)smem.createNodeMemory((EvalConditionNode)tupleSource,wm);
      evalMemory.setSegmentMemory(smem);
    }
 else     if (tupleSource.getType() == NodeTypeEnums.ConditionalBranchNode) {
      ConditionalBranchMemory evalMemory=(ConditionalBranchMemory)smem.createNodeMemory((ConditionalBranchNode)tupleSource,wm);
      evalMemory.setSegmentMemory(smem);
    }
 else     if (tupleSource.getType() == NodeTypeEnums.FromNode) {
      FromMemory fromMemory=(FromMemory)smem.createNodeMemory((FromNode)tupleSource,wm);
      fromMemory.getBetaMemory().setSegmentMemory(smem);
    }
 else     if (tupleSource.getType() == NodeTypeEnums.QueryElementNode) {
      QueryElementNode queryNode=(QueryElementNode)tupleSource;
      LeftInputAdapterNode liaNode=getQueryLiaNode(queryNode.getQueryElement().getQueryName(),getQueryOtn(segmentRoot));
      LiaNodeMemory liam=(LiaNodeMemory)wm.getNodeMemory((MemoryFactory)liaNode);
      SegmentMemory querySmem=liam.getSegmentMemory();
      if (querySmem == null) {
        querySmem=createSegmentMemory(liaNode,wm);
      }
      QueryElementNodeMemory queryNodeMem=(QueryElementNodeMemory)smem.createNodeMemory(queryNode,wm);
      queryNodeMem.setQuerySegmentMemory(querySmem);
      queryNodeMem.setSegmentMemory(smem);
    }
    LeftTupleSinkPropagator sink=tupleSource.getSinkPropagator();
    LeftTupleSinkNode firstSink=(LeftTupleSinkNode)sink.getFirstLeftTupleSink();
    LeftTupleSinkNode secondSink=firstSink.getNextLeftTupleSinkNode();
    if (secondSink == null) {
      if (NodeTypeEnums.isLeftTupleSource(firstSink)) {
        tupleSource=(LeftTupleSource)firstSink;
      }
 else {
        if (firstSink.getType() == NodeTypeEnums.RightInputAdaterNode) {
          RiaNodeMemory memory=(RiaNodeMemory)wm.getNodeMemory((MemoryFactory)firstSink);
          smem.getNodeMemories().add(memory.getRiaPathMemory());
          memory.getRiaPathMemory().setSegmentMemory(smem);
        }
 else         if (NodeTypeEnums.isTerminalNode(firstSink)) {
          PathMemory rmem=(PathMemory)wm.getNodeMemory((MemoryFactory)firstSink);
          smem.getNodeMemories().add(rmem);
          rmem.setSegmentMemory(smem);
        }
        smem.setTipNode(firstSink);
        break;
      }
    }
 else     if (sink.size() == 2 && NodeTypeEnums.isBetaNode(secondSink) && ((BetaNode)secondSink).isRightInputIsRiaNode()) {
      tupleSource=(LeftTupleSource)secondSink;
    }
 else {
      smem.setTipNode(tupleSource);
      break;
    }
  }
  smem.setAllLinkedMaskTest(allLinkedTestMask);
  LeftTupleSource parent=segmentRoot;
  int ruleSegmentPosMask=1;
  int counter=0;
  while (parent.getLeftTupleSource() != null) {
    if (!SegmentUtilities.parentInSameSegment(parent)) {
      ruleSegmentPosMask=ruleSegmentPosMask << 1;
      counter++;
    }
    parent=parent.getLeftTupleSource();
  }
  smem.setSegmentPosMaskBit(ruleSegmentPosMask);
  smem.setPos(counter);
  SegmentUtilities.updateRiaAndTerminalMemory(0,tupleSource,tupleSource,smem,wm);
  return smem;
}
