{
  String str="package org.drools\n" + "rule R1 dialect 'mvel'\n" + "    when\n"+ "        $n : Number() from accumulate( \n"+ "                 StockTick() from entry-point ep1,\n"+ "                 count(1))"+ "    then\n"+ "end\n";
  KnowledgeBase kbase=loadKnowledgeBaseFromString((KieBaseConfiguration)null,str);
  StatefulKnowledgeSession ksession=createKnowledgeSession(kbase);
  org.kie.event.rule.AgendaEventListener ael=mock(org.kie.event.rule.AgendaEventListener.class);
  ksession.addEventListener(ael);
  WorkingMemoryEntryPoint ep1=ksession.getWorkingMemoryEntryPoint("ep1");
  ep1.insert(new StockTick(1,"RHT",10,1000));
  int rulesFired=ksession.fireAllRules();
  assertEquals(1,rulesFired);
  ArgumentCaptor<org.kie.event.rule.AfterMatchFiredEvent> captor=ArgumentCaptor.forClass(org.kie.event.rule.AfterMatchFiredEvent.class);
  verify(ael,times(1)).afterMatchFired(captor.capture());
  List<org.kie.event.rule.AfterMatchFiredEvent> aafe=captor.getAllValues();
  Assert.assertThat(aafe.get(0).getMatch().getRule().getName(),is("R1"));
}
