{
  KnowledgeBase kbase=KnowledgeBaseFactory.newKnowledgeBase();
  final Package pkg=new Package("org.drools.test");
  final Rule rule=new Rule("test1");
  rule.setAgendaGroup("test group");
  final ClassObjectType cheeseObjectType=new ClassObjectType(Cheese.class);
  final Pattern pattern=new Pattern(0,cheeseObjectType);
  pkg.setClassFieldAccessorCache(new ClassFieldAccessorCache(Thread.currentThread().getContextClassLoader()));
  pkg.getClassFieldAccessorStore().setEagerWire(true);
  final ClassFieldReader extractor=pkg.getClassFieldAccessorStore().getReader(Cheese.class,"type",getClass().getClassLoader());
  final FieldValue field=FieldFactory.getFieldValue("cheddar");
  final Evaluator evaluator=registry.getEvaluator(ValueType.STRING_TYPE,Operator.EQUAL,null);
  final LiteralConstraint constraint=new LiteralConstraint(extractor,evaluator,field);
  pattern.addConstraint(constraint);
  rule.addPattern(pattern);
  rule.setConsequence(new Consequence(){
    public void evaluate(    final KnowledgeHelper knowledgeHelper,    final org.drools.WorkingMemory workingMemory) throws Exception {
    }
    public void readExternal(    ObjectInput in) throws IOException, ClassNotFoundException {
    }
    public void writeExternal(    ObjectOutput out) throws IOException {
    }
  }
);
  pkg.addRule(rule);
  List<KnowledgePackage> pkgs=new ArrayList<KnowledgePackage>();
  pkgs.add(new KnowledgePackageImp(pkg));
  kbase.addKnowledgePackages(pkgs);
  StatefulKnowledgeSession session=kbase.newStatefulKnowledgeSession();
  final List agendaList=new ArrayList();
  final AgendaEventListener agendaEventListener=new AgendaEventListener(){
    public void activationCancelled(    ActivationCancelledEvent event){
      agendaList.add(event);
    }
    public void activationCreated(    ActivationCreatedEvent event){
      agendaList.add(event);
    }
    public void afterActivationFired(    AfterActivationFiredEvent event){
      agendaList.add(event);
    }
    public void agendaGroupPopped(    AgendaGroupPoppedEvent event){
      agendaList.add(event);
    }
    public void agendaGroupPushed(    AgendaGroupPushedEvent event){
      agendaList.add(event);
    }
    public void beforeActivationFired(    BeforeActivationFiredEvent event){
      agendaList.add(event);
    }
  }
;
  session.addEventListener(agendaEventListener);
  final Cheese cheddar=new Cheese("cheddar",15);
  FactHandle cheddarHandle=session.insert(cheddar);
  assertEquals(1,agendaList.size());
  ActivationCreatedEvent createdEvent=(ActivationCreatedEvent)agendaList.get(0);
  assertSame(cheddarHandle,createdEvent.getActivation().getFactHandles().toArray()[0]);
  agendaList.clear();
  cheddar.setPrice(14);
  session.update(cheddarHandle,cheddar);
  assertEquals(2,agendaList.size());
  ActivationCancelledEvent cancelledEvent=(ActivationCancelledEvent)agendaList.get(0);
  assertSame(cheddarHandle,cancelledEvent.getActivation().getFactHandles().toArray()[0]);
  createdEvent=(ActivationCreatedEvent)agendaList.get(1);
  assertSame(cheddarHandle,createdEvent.getActivation().getFactHandles().toArray()[0]);
  agendaList.clear();
  session.retract(cheddarHandle);
  assertEquals(1,agendaList.size());
  cancelledEvent=(ActivationCancelledEvent)agendaList.get(0);
  assertNull(((InternalFactHandle)cancelledEvent.getActivation().getFactHandles().toArray()[0]).getObject());
  cheddarHandle=session.insert(cheddar);
  agendaList.clear();
  session.setFocus("test group");
  assertEquals(1,agendaList.size());
  final AgendaGroupPushedEvent pushedEvent=(AgendaGroupPushedEvent)agendaList.get(0);
  assertEquals("test group",pushedEvent.getAgendaGroup().getName());
  agendaList.clear();
  session.fireAllRules();
  assertEquals(3,agendaList.size());
  final BeforeActivationFiredEvent beforeEvent=(BeforeActivationFiredEvent)agendaList.get(0);
  assertSame(cheddarHandle,beforeEvent.getActivation().getFactHandles().toArray()[0]);
  final AfterActivationFiredEvent afterEvent=(AfterActivationFiredEvent)agendaList.get(1);
  assertSame(cheddarHandle,afterEvent.getActivation().getFactHandles().toArray()[0]);
  final AgendaGroupPoppedEvent poppedEvent=(AgendaGroupPoppedEvent)agendaList.get(2);
  assertEquals("test group",poppedEvent.getAgendaGroup().getName());
}
