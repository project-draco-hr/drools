{
  if (config == null) {
    config=KnowledgeBaseFactory.newKnowledgeSessionConfiguration();
  }
  if (environment == null) {
    environment=KnowledgeBaseFactory.newEnvironment();
  }
  MarshallerReaderContext context=new MarshallerReaderContext(stream,(InternalRuleBase)((KnowledgeBaseImpl)kbase).ruleBase,RuleBaseNodes.getNodeMap((InternalRuleBase)((KnowledgeBaseImpl)kbase).ruleBase),this.strategyStore,TIMER_READERS,this.marshallingConfig.isMarshallProcessInstances(),this.marshallingConfig.isMarshallWorkItems(),environment);
  int id=((ReteooRuleBase)((KnowledgeBaseImpl)this.kbase).ruleBase).nextWorkingMemoryCounter();
  RuleBaseConfiguration conf=((ReteooRuleBase)((KnowledgeBaseImpl)this.kbase).ruleBase).getConfiguration();
  ReteooStatefulSession session=ProtobufInputMarshaller.readSession(context,id,environment,(SessionConfiguration)config);
  context.close();
  if (((SessionConfiguration)config).isKeepReference()) {
    ((ReteooRuleBase)((KnowledgeBaseImpl)this.kbase).ruleBase).addStatefulSession(session);
  }
  return (StatefulKnowledgeSession)session.getKnowledgeRuntime();
}
