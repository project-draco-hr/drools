{
  if (!(NodeTypeEnums.isTerminalNode(sink) || sink.getType() == NodeTypeEnums.RightInputAdaterNode)) {
    if (memory.getSegmentMemory() == null) {
      SegmentUtilities.createSegmentMemory((LeftTupleSource)sink,wm);
    }
  }
 else {
    if (memory.getSegmentMemory() == null) {
      SegmentMemory childSmem=new SegmentMemory(sink);
      if (sink.getLeftTupleSource().getType() == NodeTypeEnums.LeftInputAdapterNode) {
        childSmem.setStagedTuples(new SynchronizedLeftTupleSets());
      }
      PathMemory pmem;
      if (NodeTypeEnums.isTerminalNode(sink)) {
        pmem=(PathMemory)memory;
      }
 else {
        pmem=((RiaNodeMemory)memory).getRiaPathMemory();
      }
      pmem.getSegmentMemories()[pmem.getSegmentMemories().length - 1]=childSmem;
      pmem.setSegmentMemory(childSmem);
      childSmem.getPathMemories().add(pmem);
      childSmem.setTipNode(sink);
      childSmem.setSinkFactory(sink);
    }
  }
  return memory.getSegmentMemory();
}
