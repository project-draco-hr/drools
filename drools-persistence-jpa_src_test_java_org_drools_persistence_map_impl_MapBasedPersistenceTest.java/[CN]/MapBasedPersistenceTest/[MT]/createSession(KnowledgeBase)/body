{
  EnvironmentBuilder envBuilder=new KnowledgeSessionStorageEnvironmentBuilder(storage);
  Environment env=KnowledgeBaseFactory.newEnvironment();
  env.set(EnvironmentName.TRANSACTION_MANAGER,envBuilder.getTransactionManager());
  env.set(EnvironmentName.PERSISTENCE_CONTEXT_MANAGER,envBuilder.getPersistenceContextManager());
  return JPAKnowledgeService.newStatefulKnowledgeSession(kbase,null,env);
}
