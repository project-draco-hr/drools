{
  String str="" + "package org.drools.test;\n" + "\n"+ "import org.drools.Father;\n"+ "import org.drools.TotalHolder;\n"+ "\n"+ "global TotalHolder totalHolder;\n"+ "\n"+ "rule \"sumWeightOfFather\"\n"+ "when\n"+ "    $h: Father(father != null, $wf : weightOfFather)\n"+ "then\n"+ "    totalHolder.add($wf);\n"+ "    System.out.println(\"match \" + totalHolder.getTotal());\n"+ "    final TotalHolder finalTotalHolder = totalHolder;\n"+ "    final int finalWf = $wf;\n"+ "     org.drools.common.AgendaItem agendaItem = (org.drools.common.AgendaItem) kcontext.getActivation();"+ "     agendaItem.setActivationUnMatchListener(new org.drools.event.rule.ActivationUnMatchListener() {"+ "            public void unMatch(org.drools.runtime.rule.WorkingMemory workingMemory, org.drools.runtime.rule.Activation activation) {"+ "                finalTotalHolder.subtract(finalWf);"+ "                System.out.println(\"unmatch \" + finalTotalHolder.getTotal());\n"+ "            }"+ "     });"+ "end";
  KnowledgeBuilder kbuilder=KnowledgeBuilderFactory.newKnowledgeBuilder();
  kbuilder.add(ResourceFactory.newByteArrayResource(str.getBytes()),ResourceType.DRL);
  assertFalse(kbuilder.getErrors().toString(),kbuilder.hasErrors());
  KnowledgeBase kbase=KnowledgeBaseFactory.newKnowledgeBase();
  kbase.addKnowledgePackages(kbuilder.getKnowledgePackages());
  StatefulKnowledgeSession kSession=createKnowledgeSession(kbase);
  kSession.setGlobal("totalHolder",new TotalHolder());
  Father abraham=new Father("abraham",null,100);
  Father homer=new Father("homer",null,20);
  Father bart=new Father("bart",null,3);
  org.drools.runtime.rule.FactHandle abrahamHandle=kSession.insert(abraham);
  org.drools.runtime.rule.FactHandle bartHandle=kSession.insert(bart);
  kSession.fireAllRules();
  assertEquals(0,((TotalHolder)kSession.getGlobal("totalHolder")).getTotal());
  bart.setFather(abraham);
  kSession.update(bartHandle,bart);
  kSession.fireAllRules();
  assertEquals(100,((TotalHolder)kSession.getGlobal("totalHolder")).getTotal());
  bart.setFather(null);
  kSession.update(bartHandle,bart);
  kSession.fireAllRules();
  assertEquals(0,((TotalHolder)kSession.getGlobal("totalHolder")).getTotal());
  bart.setFather(abraham);
  kSession.update(bartHandle,bart);
  kSession.fireAllRules();
  assertEquals(100,((TotalHolder)kSession.getGlobal("totalHolder")).getTotal());
  org.drools.runtime.rule.FactHandle homerHandle=kSession.insert(homer);
  homer.setFather(abraham);
  kSession.update(homerHandle,homer);
  bart.setFather(homer);
  kSession.update(bartHandle,bart);
  kSession.fireAllRules();
  assertEquals(120,((TotalHolder)kSession.getGlobal("totalHolder")).getTotal());
}
