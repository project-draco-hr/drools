{
  MVEL.COMPILER_OPT_ALLOW_NAKED_METH_CALL=true;
  scenario.lastRunResult=new Date();
  HashSet<String> ruleList=new HashSet<String>();
  ruleList.addAll(scenario.rules);
  TestingEventListener listener=null;
  List<Populate> toPopulate=new ArrayList<Populate>();
  for (Iterator iterator=scenario.globals.iterator(); iterator.hasNext(); ) {
    final FactData fact=(FactData)iterator.next();
    final Object f=eval("new " + getTypeName(resolver,fact) + "()");
    toPopulate.add(new Populate(){
      public void go(){
        populateFields(fact,globalData,f);
      }
    }
);
    globalData.put(fact.name,f);
    wm.setGlobal(fact.name,f);
  }
  doPopulate(toPopulate);
  for (Iterator<Fixture> iterator=scenario.fixtures.iterator(); iterator.hasNext(); ) {
    Fixture fx=iterator.next();
    if (fx instanceof FactData) {
      final FactData fact=(FactData)fx;
      final Object f=(fact.isModify) ? this.populatedData.get(fact.name) : eval("new " + getTypeName(resolver,fact) + "()");
      if (fact.isModify) {
        if (!this.factHandles.containsKey(fact.name)) {
          throw new IllegalArgumentException("Was not a previously inserted fact. [" + fact.name + "]");
        }
        toPopulate.add(new Populate(){
          public void go(){
            populateFields(fact,populatedData,f);
            workingMemory.update(factHandles.get(fact.name),f);
          }
        }
);
      }
 else {
        populatedData.put(fact.name,f);
        toPopulate.add(new Populate(){
          public void go(){
            populateFields(fact,populatedData,f);
            factHandles.put(fact.name,wm.insert(f));
          }
        }
);
      }
    }
 else     if (fx instanceof RetractFact) {
      RetractFact f=(RetractFact)fx;
      this.workingMemory.retract(this.factHandles.get(f.name));
      this.populatedData.remove(f.name);
    }
 else     if (fx instanceof ExecutionTrace) {
      doPopulate(toPopulate);
      ExecutionTrace executionTrace=(ExecutionTrace)fx;
      if (listener != null)       wm.removeEventListener(listener);
      listener=new TestingEventListener();
      wm.addEventListener(listener);
      applyTimeMachine(wm,executionTrace);
      long time=System.currentTimeMillis();
      wm.fireAllRules(listener.getAgendaFilter(ruleList,scenario.inclusive),scenario.maxRuleFirings);
      executionTrace.executionTimeResult=System.currentTimeMillis() - time;
      executionTrace.numberOfRulesFired=listener.totalFires;
      executionTrace.rulesFired=listener.getRulesFiredSummary();
    }
 else     if (fx instanceof Expectation) {
      doPopulate(toPopulate);
      Expectation assertion=(Expectation)fx;
      if (assertion instanceof VerifyFact) {
        verify((VerifyFact)assertion);
      }
 else       if (assertion instanceof VerifyRuleFired) {
        verify((VerifyRuleFired)assertion,(listener.firingCounts != null) ? listener.firingCounts : new HashMap<String,Integer>());
      }
    }
 else {
      throw new IllegalArgumentException("Not sure what to do with " + fx);
    }
  }
  doPopulate(toPopulate);
}
