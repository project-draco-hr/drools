{
  this.scenario=scenario;
  this.workingMemory=wm;
  scenario.executionTrace.lastRunResult=new Date();
  for (int i=0; i < scenario.facts.length; i++) {
    FactData fact=scenario.facts[i];
    Object f=eval("new " + resolver.getFullTypeName(fact.type) + "()");
    if (fact.isGlobal) {
      populateFields(fact,globalData,f);
      globalData.put(fact.name,f);
    }
 else {
      populateFields(fact,populatedData,f);
      populatedData.put(fact.name,f);
    }
  }
  HashSet<String> ruleList=new HashSet<String>();
  ruleList.addAll(Arrays.asList(scenario.executionTrace.rules));
  TestingEventListener listener=new TestingEventListener(ruleList,wm.getRuleBase(),scenario.executionTrace.inclusive);
  wm.addEventListener(listener);
  if (scenario.scenarioSimulatedDate != null) {
    final Calendar now=Calendar.getInstance();
    now.setTimeInMillis(scenario.scenarioSimulatedDate.getTime());
    wm.setTimeMachine(new TimeMachine(){
      @Override public Calendar getNow(){
        return now;
      }
    }
);
  }
  applyData(wm,this.populatedData,this.globalData);
  long time=System.currentTimeMillis();
  wm.fireAllRules(scenario.maxRuleFirings);
  scenario.executionTrace.executionTimeResult=System.currentTimeMillis() - time;
  scenario.executionTrace.firingCounts=listener.firingCounts;
  for (int i=0; i < scenario.assertions.length; i++) {
    Assertion assertion=scenario.assertions[i];
    if (assertion instanceof VerifyFact) {
      verify((VerifyFact)assertion);
    }
 else     if (assertion instanceof VerifyRuleFired) {
      verify((VerifyRuleFired)assertion,listener.firingCounts);
    }
  }
}
