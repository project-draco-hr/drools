{
  final Package pkg=new Package("pkg1");
  final RuleDescr ruleDescr=new RuleDescr("rule 1");
  ruleDescr.setConsequence("modify (cheese) {price = 5 };\nretract (cheese)");
  PackageBuilder pkgBuilder=new PackageBuilder(pkg);
  final PackageBuilderConfiguration conf=pkgBuilder.getPackageBuilderConfiguration();
  MVELDialect mvelDialect=(MVELDialect)pkgBuilder.getDialectRegistry().getDialect("mvel");
  final InstrumentedBuildContent context=new InstrumentedBuildContent(conf,pkg,ruleDescr,pkgBuilder.getDialectRegistry(),mvelDialect);
  final InstrumentedDeclarationScopeResolver declarationResolver=new InstrumentedDeclarationScopeResolver();
  final ObjectType cheeseObjeectType=new ClassObjectType(Cheese.class);
  final Pattern pattern=new Pattern(0,cheeseObjeectType);
  final PatternExtractor extractor=new PatternExtractor(cheeseObjeectType);
  final Declaration declaration=new Declaration("cheese",extractor,pattern);
  final Map map=new HashMap();
  map.put("cheese",declaration);
  declarationResolver.setDeclarations(map);
  context.setDeclarationResolver(declarationResolver);
  final MVELConsequenceBuilder builder=new MVELConsequenceBuilder();
  builder.build(context);
  final RuleBase ruleBase=RuleBaseFactory.newRuleBase();
  final WorkingMemory wm=ruleBase.newStatefulSession();
  MockLeftTupleSink sink=new MockLeftTupleSink();
  final Cheese cheddar=new Cheese("cheddar",10);
  final InternalFactHandle f0=(InternalFactHandle)wm.insert(cheddar);
  final LeftTuple tuple=new LeftTuple(f0,sink,true);
  final AgendaItem item=new AgendaItem(0,tuple,10,new PropagationContextImpl(1,1,null,null,null),context.getRule(),null);
  final DefaultKnowledgeHelper kbHelper=new DefaultKnowledgeHelper(wm);
  kbHelper.setActivation(item);
  context.getRule().getConsequence().evaluate(kbHelper,wm);
  assertEquals(5,cheddar.getPrice());
}
