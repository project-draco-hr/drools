{
  final Package pkg=new Package("pkg1");
  final RuleDescr ruleDescr=new RuleDescr("rule 1");
  ruleDescr.setConsequence("modify (cheese) {price = 5 }; retract (cheese)");
  MVELDialect mvelDialect=new MVELDialect(new PackageBuilder(pkg));
  DialectRegistry registry=new DialectRegistry();
  registry.addDialect("default",mvelDialect);
  final InstrumentedBuildContent context=new InstrumentedBuildContent(pkg,ruleDescr,registry,mvelDialect);
  final InstrumentedDeclarationScopeResolver declarationResolver=new InstrumentedDeclarationScopeResolver();
  final ObjectType cheeseObjeectType=new ClassObjectType(Cheese.class);
  final Pattern pattern=new Pattern(0,cheeseObjeectType);
  final PatternExtractor extractor=new PatternExtractor(cheeseObjeectType);
  final Declaration declaration=new Declaration("cheese",extractor,pattern);
  final Map map=new HashMap();
  map.put("cheese",declaration);
  declarationResolver.setDeclarations(map);
  context.setDeclarationResolver(declarationResolver);
  final MVELConsequenceBuilder builder=new MVELConsequenceBuilder();
  builder.build(context);
  final RuleBase ruleBase=RuleBaseFactory.newRuleBase();
  final WorkingMemory wm=ruleBase.newStatefulSession();
  final Cheese cheddar=new Cheese("cheddar",10);
  final InternalFactHandle f0=(InternalFactHandle)wm.insert(cheddar);
  final ReteTuple tuple=new ReteTuple(f0);
  final AgendaItem item=new AgendaItem(0,tuple,10,null,context.getRule(),null);
  final DefaultKnowledgeHelper kbHelper=new DefaultKnowledgeHelper(wm);
  kbHelper.setActivation(item);
  context.getRule().getConsequence().evaluate(kbHelper,wm);
  assertEquals(5,cheddar.getPrice());
}
