{
  NodeContainer nodeContainer=nodeInstanceContainer.getNodeContainer();
  for (  NodeInstance nodeInstance : nodeInstanceContainer.getNodeInstances()) {
    String oldNodeId=((NodeImpl)((org.drools.workflow.instance.NodeInstance)nodeInstance).getNode()).getUniqueId();
    Long newNodeId=nodeMapping.get(oldNodeId);
    if (newNodeId == null) {
      newNodeId=nodeInstance.getNodeId();
    }
    ((NodeInstanceImpl)nodeInstance).setNodeId(newNodeId);
    if (nodeInstance instanceof NodeInstanceContainer) {
      updateNodeInstances((NodeInstanceContainer)nodeInstance,nodeMapping);
    }
  }
}
