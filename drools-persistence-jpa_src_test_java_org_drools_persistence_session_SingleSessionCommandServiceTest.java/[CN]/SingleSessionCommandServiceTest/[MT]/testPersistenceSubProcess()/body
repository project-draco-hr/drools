{
  Environment env=KnowledgeBaseFactory.newEnvironment();
  env.set(EnvironmentName.ENTITY_MANAGER_FACTORY,emf);
  env.set(EnvironmentName.TRANSACTION_MANAGER,TransactionManagerServices.getTransactionManager());
  Properties properties=new Properties();
  properties.setProperty("drools.commandService","org.drools.persistence.session.SingleSessionCommandService");
  properties.setProperty("drools.processInstanceManagerFactory","org.drools.persistence.processinstance.JPAProcessInstanceManagerFactory");
  properties.setProperty("drools.workItemManagerFactory","org.drools.persistence.processinstance.JPAWorkItemManagerFactory");
  properties.setProperty("drools.processSignalManagerFactory","org.drools.persistence.processinstance.JPASignalManagerFactory");
  properties.setProperty("drools.timerService","org.drools.persistence.session.JpaJDKTimerService");
  SessionConfiguration config=new SessionConfiguration(properties);
  RuleBase ruleBase=RuleBaseFactory.newRuleBase();
  Package pkg=getProcessSubProcess();
  ruleBase.addPackage(pkg);
  SingleSessionCommandService service=new SingleSessionCommandService(ruleBase,config,env);
  int sessionId=service.getSessionId();
  StartProcessCommand startProcessCommand=new StartProcessCommand();
  startProcessCommand.setProcessId("org.drools.test.TestProcess");
  RuleFlowProcessInstance processInstance=(RuleFlowProcessInstance)service.execute(startProcessCommand);
  System.out.println("Started process instance " + processInstance.getId());
  long processInstanceId=processInstance.getId();
  TestWorkItemHandler handler=TestWorkItemHandler.getInstance();
  WorkItem workItem=handler.getWorkItem();
  assertNotNull(workItem);
  service.dispose();
  service=new SingleSessionCommandService(sessionId,ruleBase,config,env);
  GetProcessInstanceCommand getProcessInstanceCommand=new GetProcessInstanceCommand();
  getProcessInstanceCommand.setProcessInstanceId(processInstanceId);
  processInstance=(RuleFlowProcessInstance)service.execute(getProcessInstanceCommand);
  assertNotNull(processInstance);
  Collection<NodeInstance> nodeInstances=processInstance.getNodeInstances();
  assertEquals(1,nodeInstances.size());
  SubProcessNodeInstance subProcessNodeInstance=(SubProcessNodeInstance)nodeInstances.iterator().next();
  long subProcessInstanceId=subProcessNodeInstance.getProcessInstanceId();
  getProcessInstanceCommand=new GetProcessInstanceCommand();
  getProcessInstanceCommand.setProcessInstanceId(subProcessInstanceId);
  RuleFlowProcessInstance subProcessInstance=(RuleFlowProcessInstance)service.execute(getProcessInstanceCommand);
  assertNotNull(subProcessInstance);
  service.dispose();
  service=new SingleSessionCommandService(sessionId,ruleBase,config,env);
  CompleteWorkItemCommand completeWorkItemCommand=new CompleteWorkItemCommand();
  completeWorkItemCommand.setWorkItemId(workItem.getId());
  service.execute(completeWorkItemCommand);
  service.dispose();
  service=new SingleSessionCommandService(sessionId,ruleBase,config,env);
  getProcessInstanceCommand=new GetProcessInstanceCommand();
  getProcessInstanceCommand.setProcessInstanceId(subProcessInstanceId);
  subProcessInstance=(RuleFlowProcessInstance)service.execute(getProcessInstanceCommand);
  assertNull(subProcessInstance);
  getProcessInstanceCommand=new GetProcessInstanceCommand();
  getProcessInstanceCommand.setProcessInstanceId(processInstanceId);
  processInstance=(RuleFlowProcessInstance)service.execute(getProcessInstanceCommand);
  assertNull(processInstance);
  service.dispose();
}
