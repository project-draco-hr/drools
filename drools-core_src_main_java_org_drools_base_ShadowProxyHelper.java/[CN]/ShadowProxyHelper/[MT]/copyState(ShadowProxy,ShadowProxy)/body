{
  final Field[] fields=from.getClass().getDeclaredFields();
  for (int i=0; i < fields.length; i++) {
    if (fields[i].getName().endsWith(ShadowProxyFactory.FIELD_SET_FLAG)) {
      fields[i].setAccessible(true);
      try {
        if (fields[i].getBoolean(from)) {
          final String fieldName=fields[i].getName().substring(0,fields[i].getName().length() - ShadowProxyFactory.FIELD_SET_FLAG.length());
          final Field flag=to.getClass().getDeclaredField(fields[i].getName());
          final Field fieldFrom=from.getClass().getDeclaredField(fieldName);
          final Field fieldTo=to.getClass().getDeclaredField(fieldName);
          flag.setAccessible(true);
          fieldFrom.setAccessible(true);
          fieldTo.setAccessible(true);
          flag.setBoolean(to,true);
          fieldTo.set(to,fieldFrom.get(from));
        }
      }
 catch (      final Exception e) {
        throw new RuntimeDroolsException("Unable to copy state from one shadow proxy to another");
      }
    }
  }
}
