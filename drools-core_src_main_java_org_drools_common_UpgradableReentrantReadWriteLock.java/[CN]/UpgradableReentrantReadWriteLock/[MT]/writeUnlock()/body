{
  if (lock.getWriteHoldCount() == 1) {
    long threadId=Thread.currentThread().getId();
    Integer upgradedReadCount=upgradedReadCounters.get(threadId);
    if (upgradedReadCount != null) {
      for (int i=upgradedReadCount; i > 0; i--)       lock.readLock().lock();
      upgradedReadCounters.remove(threadId);
    }
  }
  lock.writeLock().unlock();
  notifyUpgradingThread();
}
