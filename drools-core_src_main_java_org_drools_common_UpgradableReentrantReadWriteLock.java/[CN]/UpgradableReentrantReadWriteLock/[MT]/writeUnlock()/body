{
  if (lock.getWriteHoldCount() == 1) {
    IntegerRef upgradedReadCount=upgradedReadCounters.get(Thread.currentThread().getId());
    if (upgradedReadCount != null) {
      for (int i=upgradedReadCount.get(); i > 0; i--)       lock.readLock().lock();
      upgradedReadCounters.remove(Thread.currentThread().getId());
    }
  }
  lock.writeLock().unlock();
  notifyUpgradingThread();
}
