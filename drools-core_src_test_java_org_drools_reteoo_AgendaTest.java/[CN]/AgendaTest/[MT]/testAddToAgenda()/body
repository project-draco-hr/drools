{
  RuleBase ruleBase=new RuleBaseImpl();
  WorkingMemoryImpl workingMemory=(WorkingMemoryImpl)ruleBase.newWorkingMemory();
  final Agenda agenda=workingMemory.getAgenda();
  final Rule rule1=new Rule("test-rule1");
  final Rule rule2=new Rule("test-rule2");
  final Map results=new HashMap();
  final ReteTuple tuple=new ReteTuple(0,new FactHandleImpl(1),workingMemory);
  final PropagationContext context1=new PropagationContextImpl(PropagationContext.ASSERTION,rule1,new AgendaItem(tuple,this.initContext,rule1));
  final PropagationContext context2=new PropagationContextImpl(PropagationContext.ASSERTION,rule2,new AgendaItem(tuple,this.initContext,rule2));
  rule1.setConsequence(new org.drools.spi.Consequence(){
    public void invoke(    Activation activation){
      agenda.addToAgenda((ReteTuple)tuple,context1,rule1);
      results.put("fired",new Boolean(true));
    }
  }
);
  assertEquals(0,agenda.focusSize());
  rule1.setNoLoop(true);
  agenda.addToAgenda(tuple,context2,rule1);
  assertEquals(1,agenda.focusSize());
  agenda.fireNextItem(null);
  assertEquals(new Boolean(true),results.get("fired"));
  assertEquals(0,agenda.focusSize());
  agenda.clearAgenda();
  results.clear();
  rule1.setNoLoop(false);
  agenda.addToAgenda(tuple,context2,rule1);
  assertEquals(1,agenda.focusSize());
  agenda.fireNextItem(null);
  assertEquals(new Boolean(true),results.get("fired"));
  assertEquals(1,agenda.focusSize());
}
