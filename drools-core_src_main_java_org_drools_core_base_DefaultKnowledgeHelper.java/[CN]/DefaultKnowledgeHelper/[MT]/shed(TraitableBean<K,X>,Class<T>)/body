{
  if (trait.isAssignableFrom(core.getClass())) {
    Collection removedTraits=core.removeTrait(trait.getName());
    if (!removedTraits.isEmpty()) {
      update(core,Long.MIN_VALUE,core.getClass());
    }
    return (Thing<K>)core;
  }
 else {
    Collection<Thing<K>> removedTypes;
    Thing<K> thing=core.getTrait(Thing.class.getName());
    if (trait == Thing.class) {
      removedTypes=new ArrayList<Thing<K>>(core._getTraitMap().values());
      for (      Thing t : removedTypes) {
        if (!((TraitType)t).isVirtual()) {
          retract(t);
        }
      }
      core._getTraitMap().clear();
      core._setTraitMap(null);
      return thing;
    }
 else     if (core.hasTrait(trait.getName())) {
      removedTypes=core.removeTrait(trait.getName());
    }
 else {
      HierarchyEncoder hier=this.workingMemory.getKnowledgeBase().getConfiguration().getComponentFactory().getTraitRegistry().getHierarchy();
      BitSet code=hier.getCode(trait.getName());
      removedTypes=core.removeTrait(code);
    }
    removedTypes=new ArrayList<Thing<K>>(removedTypes);
    for (    Thing t : removedTypes) {
      if (!((TraitType)t).isVirtual()) {
        retract(t);
      }
    }
    if (!core.hasTraits()) {
      don(core,Thing.class);
    }
 else     if (!removedTypes.isEmpty()) {
      update(core,Long.MIN_VALUE,core.getClass());
    }
    return thing;
  }
}
