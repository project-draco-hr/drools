{
  final PackageBuilder builder=new PackageBuilder();
  final PackageDescr packageDescr=new PackageDescr("p1");
  final RuleDescr ruleDescr=new RuleDescr("rule-1");
  packageDescr.addRule(ruleDescr);
  final AndDescr lhs=new AndDescr();
  ruleDescr.setLhs(lhs);
  packageDescr.addGlobal(new GlobalDescr("map","java.util.Map"));
  ruleDescr.setConsequence("map.put(\"value\", new Integer(1) );");
  final PackageDescr back=(PackageDescr)SerializationHelper.serializeObject(packageDescr);
  assertNotNull(back);
  assertEquals("p1",back.getName());
  builder.addPackage(packageDescr);
  final Package pkg=builder.getPackage();
  final Rule rule=pkg.getRule("rule-1");
  assertLength(0,builder.getErrors().getErrors());
  final Package newPkg=SerializationHelper.serializeObject(pkg);
  final Rule newRule=newPkg.getRule("rule-1");
  final ReteooRuleBase ruleBase=(ReteooRuleBase)RuleBaseFactory.newRuleBase();
  newPkg.getDialectRuntimeRegistry().onAdd(ruleBase.getRootClassLoader());
  newPkg.getDialectRuntimeRegistry().onBeforeExecute();
  ruleBase.getGlobals().put("map",Map.class);
  final WorkingMemory workingMemory=ruleBase.newStatefulSession();
  final HashMap map=new HashMap();
  workingMemory.setGlobal("map",map);
  final LeftTuple tuple=new MockTuple(new HashMap());
  tuple.setLeftTupleSink(new RuleTerminalNode(1,null,newRule,newRule.getLhs(),new BuildContext(ruleBase,null)));
  final Activation activation=new MockActivation(newRule,0,newRule.getLhs(),tuple);
  final DefaultKnowledgeHelper knowledgeHelper=new org.drools.base.DefaultKnowledgeHelper(workingMemory);
  knowledgeHelper.setActivation(activation);
  newRule.getConsequence().evaluate(knowledgeHelper,workingMemory);
  assertEquals(new Integer(1),map.get("value"));
}
