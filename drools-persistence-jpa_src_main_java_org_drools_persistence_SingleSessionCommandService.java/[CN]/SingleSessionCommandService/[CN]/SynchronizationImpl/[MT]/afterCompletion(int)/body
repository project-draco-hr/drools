{
  if (status != TransactionManager.STATUS_COMMITTED) {
    this.service.rollback();
  }
  SingleSessionCommandService.synchronizations.remove(this.service);
  this.service.jpm.clearPersistenceContext();
  this.service.jpm.endCommandScopedEntityManager();
  KieSession ksession=this.service.ksession;
  if (ksession != null) {
    InternalProcessRuntime internalProcessRuntime=((InternalKnowledgeRuntime)ksession).getProcessRuntime();
    if (internalProcessRuntime != null) {
      if (this.service.doRollback) {
        internalProcessRuntime.clearProcessInstancesState();
      }
      internalProcessRuntime.clearProcessInstances();
    }
    ((JPAWorkItemManager)ksession.getWorkItemManager()).clearWorkItems();
  }
  while (this.service.lock.isLocked()) {
    this.service.lock.unlock();
  }
}
