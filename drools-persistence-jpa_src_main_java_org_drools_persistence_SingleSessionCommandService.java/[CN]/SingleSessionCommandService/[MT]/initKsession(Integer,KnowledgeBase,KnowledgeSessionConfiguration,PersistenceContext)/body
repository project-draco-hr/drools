{
  if (!doRollback && this.ksession != null) {
    return;
  }
  this.doRollback=false;
  try {
    this.sessionInfo=persistenceContext.findSessionInfo(sessionId);
  }
 catch (  Exception e) {
    throw new RuntimeException("Could not find session data for id " + sessionId,e);
  }
  if (sessionInfo == null) {
    throw new RuntimeException("Could not find session data for id " + sessionId);
  }
  if (this.marshallingHelper == null) {
    this.marshallingHelper=new SessionMarshallingHelper(kbase,conf,env);
    MarshallingConfigurationImpl config=(MarshallingConfigurationImpl)((DefaultMarshaller)this.marshallingHelper.getMarshaller()).getMarshallingConfiguration();
    config.setMarshallProcessInstances(false);
    config.setMarshallWorkItems(false);
  }
  this.sessionInfo.setJPASessionMashallingHelper(this.marshallingHelper);
  this.ksession=this.marshallingHelper.loadSnapshot(this.sessionInfo.getData(),this.ksession);
  ((InternalKnowledgeRuntime)ksession).setId(this.sessionInfo.getId());
  ((InternalKnowledgeRuntime)this.ksession).setEndOperationListener(new EndOperationListenerImpl(this.sessionInfo));
  if (this.kContext == null) {
    this.kContext=new FixedKnowledgeCommandContext(null,null,null,this.ksession,null);
  }
  this.commandService=new DefaultCommandService(kContext);
  ((AcceptsTimerJobFactoryManager)((InternalKnowledgeRuntime)ksession).getTimerService()).getTimerJobFactoryManager().setCommandService(this);
}
