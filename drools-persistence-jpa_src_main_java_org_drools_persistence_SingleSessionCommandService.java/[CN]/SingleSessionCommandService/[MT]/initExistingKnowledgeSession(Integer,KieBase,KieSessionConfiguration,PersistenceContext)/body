{
  if (!doRollback && this.ksession != null) {
    return;
  }
  this.doRollback=false;
  try {
    this.sessionInfo=persistenceContext.findSessionInfo(sessionId);
  }
 catch (  Exception e) {
    throw new SessionNotFoundException("Could not find session data for id " + sessionId,e);
  }
  if (sessionInfo == null) {
    throw new SessionNotFoundException("Could not find session data for id " + sessionId);
  }
  if (this.marshallingHelper == null) {
    this.marshallingHelper=new SessionMarshallingHelper(kbase,conf,env);
    MarshallingConfigurationImpl config=(MarshallingConfigurationImpl)this.marshallingHelper.getMarshaller().getMarshallingConfiguration();
    config.setMarshallProcessInstances(false);
    config.setMarshallWorkItems(false);
  }
  this.sessionInfo.setJPASessionMashallingHelper(this.marshallingHelper);
  ((SessionConfiguration)conf).getTimerJobFactoryManager().setCommandService(this);
  this.ksession=(StatefulKnowledgeSession)this.marshallingHelper.loadSnapshot(this.sessionInfo.getData(),this.ksession);
  ((InternalKnowledgeRuntime)ksession).setId(this.sessionInfo.getId());
  ((InternalKnowledgeRuntime)this.ksession).setEndOperationListener(new EndOperationListenerImpl(this.txm,this.sessionInfo));
  if (this.kContext == null) {
    this.kContext=new FixedKnowledgeCommandContext(new ContextImpl("ksession",null),null,null,this.ksession,null);
  }
  this.commandService=new TransactionInterceptor(kContext);
}
