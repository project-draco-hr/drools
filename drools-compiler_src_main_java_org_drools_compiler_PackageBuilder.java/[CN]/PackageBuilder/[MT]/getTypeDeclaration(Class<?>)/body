{
  if (cls.isPrimitive() || cls.isArray()) {
    return null;
  }
  TypeDeclaration tdecl=null;
  PackageRegistry pkgReg=null;
  if (this.cacheTypes == null) {
    this.cacheTypes=new HashMap<String,TypeDeclaration>();
  }
 else {
    tdecl=cacheTypes.get(cls.getName());
    if (tdecl != null) {
      return tdecl;
    }
  }
  tdecl=this.builtinTypes.get((cls.getName()));
  if (tdecl == null) {
    pkgReg=this.pkgRegistryMap.get(ClassUtils.getPackage(cls));
    if (pkgReg != null) {
      tdecl=pkgReg.getPackage().getTypeDeclaration(cls.getSimpleName());
    }
  }
  if (tdecl == null) {
    tdecl=new TypeDeclaration(cls.getSimpleName());
    ClassDefinition clsDef=tdecl.getTypeClassDef();
    if (clsDef == null) {
      clsDef=new ClassDefinition();
      Collection<Field> fields=new LinkedList<Field>();
      Class<?> tempKlass=cls;
      while (tempKlass != null && tempKlass != Object.class) {
        for (        Field f : tempKlass.getDeclaredFields()) {
          fields.add(f);
        }
        tempKlass=tempKlass.getSuperclass();
      }
      List<FieldDefinition> orderedFields=new ArrayList<FieldDefinition>(fields.size());
      for (int i=0; i < fields.size(); i++) {
        orderedFields.add(null);
      }
      for (      Field fld : fields) {
        Position pos=fld.getAnnotation(Position.class);
        if (pos != null) {
          FieldDefinition fldDef=new FieldDefinition(fld.getName(),fld.getType().getName());
          fldDef.setIndex(pos.value());
          orderedFields.set(pos.value(),fldDef);
        }
      }
      for (      FieldDefinition fld : orderedFields) {
        if (fld != null) {
          clsDef.addField(fld);
        }
      }
      tdecl.setTypeClassDef(clsDef);
    }
  }
  Set<TypeDeclaration> tdecls=new LinkedHashSet<TypeDeclaration>();
  tdecls.add(tdecl);
  buildTypeDeclarations(cls,tdecls);
  TypeDeclaration[] tarray=tdecls.toArray(new TypeDeclaration[tdecls.size()]);
  for (int i=tarray.length - 1; i >= 0; i--) {
    TypeDeclaration currentTDecl=tarray[i];
    if ((tdecl.getSetMask() & TypeDeclaration.ROLE_BIT) != TypeDeclaration.ROLE_BIT) {
      tdecl.setRole(currentTDecl.getRole());
    }
    if ((tdecl.getSetMask() & TypeDeclaration.FORMAT_BIT) != TypeDeclaration.FORMAT_BIT) {
      tdecl.setFormat(currentTDecl.getFormat());
    }
    if ((tdecl.getSetMask() & TypeDeclaration.TYPESAFE_BIT) != TypeDeclaration.TYPESAFE_BIT) {
      tdecl.setTypesafe(currentTDecl.isTypesafe());
    }
  }
  this.cacheTypes.put(cls.getName(),tdecl);
  return tdecl;
}
