{
  PriorityQueue<FieldDefinition> queue=new PriorityQueue<FieldDefinition>();
  int last=0;
  for (  TypeFieldDescr field : flds.values()) {
    last=Math.max(last,field.getIndex());
  }
  for (  TypeFieldDescr field : flds.values()) {
    if (field.getIndex() < 0) {
      field.setIndex(++last);
    }
    String fullFieldType;
    try {
      String typeName=field.getPattern().getObjectType();
      fullFieldType=generatedTypes.contains(typeName) ? typeName : pkgRegistry.getTypeResolver().resolveType(typeName).getName();
      FieldDefinition fieldDef=new FieldDefinition(field.getFieldName(),fullFieldType);
      boolean isKey=field.getAnnotation(TypeDeclaration.ATTR_KEY) != null;
      fieldDef.setKey(isKey);
      fieldDef.setIndex(field.getIndex());
      fieldDef.setInherited(field.isInherited());
      fieldDef.setInitExpr(field.getInitExpr());
      for (      String annotationName : field.getAnnotationNames()) {
        Class annotation=resolveAnnotation(annotationName,pkgRegistry.getTypeResolver());
        if (annotation != null) {
          try {
            AnnotationDefinition annotationDefinition=AnnotationDefinition.build(annotation,field.getAnnotations().get(annotationName).getValueMap(),pkgRegistry.getTypeResolver());
            fieldDef.addAnnotation(annotationDefinition);
          }
 catch (          NoSuchMethodException nsme) {
            this.results.add(new TypeDeclarationError("Annotated field " + field.getFieldName() + "  - undefined property in @annotation "+ annotationName+ ": "+ nsme.getMessage()+ ";",field.getLine()));
          }
        }
      }
      queue.add(fieldDef);
    }
 catch (    ClassNotFoundException cnfe) {
      this.results.add(new TypeDeclarationError(cnfe.getMessage(),field.getLine()));
    }
  }
  return queue;
}
