{
  if (lock.isWriteLockedByCurrentThread()) {
    lock.writeLock().lock();
    return;
  }
  LockRequestCounter lockCounter=lockCounters.get();
  if (lockCounter.readCounter > 0) {
    lockCounter.upgradedReadCounter=lockCounter.readCounter;
    if (shouldTryAtomicUpgrade && tryingLockUpgrade.compareAndSet(false,true)) {
      atomicLockUpgrade(lockCounter.readCounter);
    }
 else {
      for (int i=lockCounter.readCounter; i > 0; i--)       lock.readLock().unlock();
      notifyUpgradingThread();
      lowPriorityWriteLock();
    }
  }
 else {
    lowPriorityWriteLock();
  }
}
