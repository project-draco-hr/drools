{
  if (lock.isWriteLockedByCurrentThread()) {
    lock.writeLock().lock();
    return;
  }
  IntegerRef readHoldCount=readCounters.get(Thread.currentThread().getId());
  if (readHoldCount != null) {
    upgradedReadCounters.put(Thread.currentThread().getId(),new IntegerRef(readHoldCount.get()));
    if (shouldTryAtomicUpgrade && tryingLockUpgrade.compareAndSet(false,true)) {
      atomicLockUpgrade(readHoldCount.get());
    }
 else {
      for (int i=readHoldCount.get(); i > 0; i--)       lock.readLock().unlock();
      notifyUpgradingThread();
      lowPriorityWriteLock();
    }
  }
 else {
    lowPriorityWriteLock();
  }
}
