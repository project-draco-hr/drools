{
  Persister<StatefulSession> persister=new MemoryPersister<StatefulSession>(new StatefulSessionSnapshotter(session));
  persister.save();
  Transaction transaction=persister.getTransaction();
  try {
    transaction.start();
    T result=command.execute(session);
    transaction.commit();
    return result;
  }
 catch (  Throwable t) {
    try {
      transaction.rollback();
      throw new RuntimeException("Could not execute command",t);
    }
 catch (    XAException e) {
      throw new RuntimeException("Could not rollback transaction",e);
    }
  }
}
