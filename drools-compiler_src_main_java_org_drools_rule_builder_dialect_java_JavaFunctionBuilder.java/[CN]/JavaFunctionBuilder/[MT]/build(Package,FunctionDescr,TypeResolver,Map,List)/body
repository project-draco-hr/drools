{
  final Map vars=new HashMap();
  vars.put("package",pkg.getName());
  vars.put("imports",pkg.getImports().keySet());
  final List staticImports=new LinkedList();
  for (Iterator it=pkg.getStaticImports().iterator(); it.hasNext(); ) {
    final String staticImport=(String)it.next();
    if (!staticImport.endsWith(functionDescr.getName())) {
      staticImports.add(staticImport);
    }
  }
  vars.put("staticImports",staticImports);
  vars.put("className",StringUtils.ucFirst(functionDescr.getName()));
  vars.put("methodName",functionDescr.getName());
  vars.put("returnType",functionDescr.getReturnType());
  vars.put("parameterTypes",functionDescr.getParameterTypes());
  vars.put("parameterNames",functionDescr.getParameterNames());
  final Map params=new HashMap();
  final List names=functionDescr.getParameterNames();
  final List types=functionDescr.getParameterTypes();
  try {
    for (int i=0, size=names.size(); i < size; i++) {
      params.put(names.get(i),typeResolver.resolveType((String)types.get(i)));
    }
  }
 catch (  final ClassNotFoundException e) {
    errors.add(new FunctionError(functionDescr,e,"unable to resolve type while building function"));
  }
  vars.put("text",functionDescr.getText());
  final String text=String.valueOf(TemplateRuntime.eval(template,null,new MapVariableResolverFactory(vars)));
  final BufferedReader reader=new BufferedReader(new StringReader(text));
  String line=null;
  final String lineStartsWith="    public static " + functionDescr.getReturnType() + " "+ functionDescr.getName();
  int offset=0;
  try {
    while ((line=reader.readLine()) != null) {
      offset++;
      if (line.startsWith(lineStartsWith)) {
        break;
      }
    }
    functionDescr.setOffset(offset);
  }
 catch (  final IOException e) {
    throw new RuntimeDroolsException("Error determining start offset with function");
  }
  final String name=pkg.getName() + "." + StringUtils.ucFirst(functionDescr.getName());
  final LineMappings mapping=new LineMappings(name);
  mapping.setStartLine(functionDescr.getLine());
  mapping.setOffset(functionDescr.getOffset());
  lineMappings.put(name,mapping);
  return text;
}
