{
  ResourceMapEntry rsrcMapping=this.resourceMappings.get(resource);
  if (rsrcMapping == null) {
    addResourceMapping(resource,true);
    rsrcMapping=this.resourceMappings.get(resource);
  }
  if (rsrcMapping.knowledgeDefinitions.add(kd)) {
    this.agent.listener.debug("KnowledgeAgent mapping resource=" + resource + " to KnowledgeDefinition="+ kd);
    Resource oldRsrc=this.knowledgeDefinitionMappings.put(kd,resource);
    ResourceMapEntry oldRsrcMapping=this.resourceMappings.get(oldRsrc);
    if (oldRsrcMapping != null) {
      this.agent.listener.debug("KnowledgeAgent removing reference from resource=" + oldRsrc + " to KnowledgeDefinition="+ kd);
      oldRsrcMapping.getKnowledgeDefinitions().remove(kd);
    }
    return oldRsrc;
  }
  return null;
}
