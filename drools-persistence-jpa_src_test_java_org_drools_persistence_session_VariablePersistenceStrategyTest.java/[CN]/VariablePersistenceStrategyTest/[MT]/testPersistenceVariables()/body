{
  KnowledgeBuilder kbuilder=KnowledgeBuilderFactory.newKnowledgeBuilder();
  kbuilder.add(new ClassPathResource("VariablePersistenceStrategyProcess.rf"),ResourceType.DRF);
  for (  KnowledgeBuilderError error : kbuilder.getErrors()) {
    System.out.println(error);
  }
  KnowledgeBase kbase=KnowledgeBaseFactory.newKnowledgeBase();
  kbase.addKnowledgePackages(kbuilder.getKnowledgePackages());
  EntityManagerFactory emf=Persistence.createEntityManagerFactory("org.drools.persistence.jpa");
  Environment env=KnowledgeBaseFactory.newEnvironment();
  env.set(EnvironmentName.ENTITY_MANAGER_FACTORY,emf);
  env.set(EnvironmentName.GLOBALS,new MapGlobalResolver());
  StatefulKnowledgeSession ksession=JPAKnowledgeService.newStatefulKnowledgeSession(kbase,null,env);
  int id=ksession.getId();
  System.out.println("### Starting process ###");
  Map<String,Object> parameters=new HashMap<String,Object>();
  parameters.put("x","SomeString");
  parameters.put("y",new MyEntity("This is a test Entity"));
  parameters.put("z",new MyVariableSerializable("This is a test SerializableObject"));
  WorkflowProcessInstance processInstance=(WorkflowProcessInstance)ksession.startProcess("com.sample.ruleflow",parameters);
  TestWorkItemHandler handler=TestWorkItemHandler.getInstance();
  WorkItem workItem=handler.getWorkItem();
  assertNotNull(workItem);
  List<?> result=emf.createEntityManager().createQuery("select i from VariableInstanceInfo i").getResultList();
  assertEquals(3,result.size());
  System.out.println("### Retrieving process instance ###");
  ksession=JPAKnowledgeService.loadStatefulKnowledgeSession(id,kbase,null,env);
  processInstance=(WorkflowProcessInstance)ksession.getProcessInstance(processInstance.getId());
  assertNotNull(processInstance);
  assertEquals("SomeString",processInstance.getVariable("x"));
  assertEquals("This is a test Entity",((MyEntity)processInstance.getVariable("y")).getTest());
  assertEquals("This is a test SerializableObject",((MyVariableSerializable)processInstance.getVariable("z")).getText());
  assertNull(processInstance.getVariable("a"));
  assertNull(processInstance.getVariable("b"));
  assertNull(processInstance.getVariable("c"));
  System.out.println("### Completing first work item ###");
  ksession.getWorkItemManager().completeWorkItem(workItem.getId(),null);
  workItem=handler.getWorkItem();
  assertNotNull(workItem);
  System.out.println("### Retrieving variable instance infos ###");
  result=emf.createEntityManager().createQuery("select i from VariableInstanceInfo i").getResultList();
  assertEquals(6,result.size());
  for (  Object o : result) {
    System.out.println(((VariableInstanceInfo)o));
  }
  System.out.println("### Retrieving process instance ###");
  ksession=JPAKnowledgeService.loadStatefulKnowledgeSession(id,kbase,null,env);
  processInstance=(WorkflowProcessInstance)ksession.getProcessInstance(processInstance.getId());
  assertNotNull(processInstance);
  assertEquals("SomeString",processInstance.getVariable("x"));
  assertEquals("This is a test Entity",((MyEntity)processInstance.getVariable("y")).getTest());
  assertEquals("This is a test SerializableObject",((MyVariableSerializable)processInstance.getVariable("z")).getText());
  assertEquals("Some new String",processInstance.getVariable("a"));
  assertEquals("This is a new test Entity",((MyEntity)processInstance.getVariable("b")).getTest());
  assertEquals("This is a new test SerializableObject",((MyVariableSerializable)processInstance.getVariable("c")).getText());
  System.out.println("### Completing second work item ###");
  ksession.getWorkItemManager().completeWorkItem(workItem.getId(),null);
  workItem=handler.getWorkItem();
  assertNotNull(workItem);
  result=emf.createEntityManager().createQuery("select i from VariableInstanceInfo i").getResultList();
  assertEquals(6,result.size());
  System.out.println("### Retrieving process instance ###");
  ksession=JPAKnowledgeService.loadStatefulKnowledgeSession(id,kbase,null,env);
  processInstance=(WorkflowProcessInstance)ksession.getProcessInstance(processInstance.getId());
  assertNotNull(processInstance);
  assertEquals("SomeString",processInstance.getVariable("x"));
  assertEquals("This is a test Entity",((MyEntity)processInstance.getVariable("y")).getTest());
  assertEquals("This is a test SerializableObject",((MyVariableSerializable)processInstance.getVariable("z")).getText());
  assertEquals("Some changed String",processInstance.getVariable("a"));
  assertEquals("This is a changed test Entity",((MyEntity)processInstance.getVariable("b")).getTest());
  assertEquals("This is a changed test SerializableObject",((MyVariableSerializable)processInstance.getVariable("c")).getText());
  System.out.println("### Completing third work item ###");
  ksession.getWorkItemManager().completeWorkItem(workItem.getId(),null);
  workItem=handler.getWorkItem();
  assertNull(workItem);
  result=emf.createEntityManager().createQuery("select i from VariableInstanceInfo i").getResultList();
  assertEquals(0,result.size());
  ksession=JPAKnowledgeService.loadStatefulKnowledgeSession(id,kbase,null,env);
  processInstance=(WorkflowProcessInstance)ksession.getProcessInstance(processInstance.getId());
  assertNull(processInstance);
}
