{
  this.state=workItem.getState();
  ByteArrayOutputStream baos=new ByteArrayOutputStream();
  boolean variablesChanged=false;
  try {
    MarshallerWriteContext context=new MarshallerWriteContext(baos,null,null,null,null);
    externalVariables=VariablePersistenceStrategyFactory.getVariablePersistenceStrategy().isEnabled();
    ProcessMarshallerImpl.writeWorkItem(context,workItem,!externalVariables);
    if (externalVariables) {
      variablesChanged=persistVariables();
    }
    context.close();
    this.workItemByteArray=baos.toByteArray();
  }
 catch (  IOException e) {
    throw new IllegalArgumentException("IOException while storing workItem " + workItem.getId() + ": "+ e.getMessage());
  }
}
