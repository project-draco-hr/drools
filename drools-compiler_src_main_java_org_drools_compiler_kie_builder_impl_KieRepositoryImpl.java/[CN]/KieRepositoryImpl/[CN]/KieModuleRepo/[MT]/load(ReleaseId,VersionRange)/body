{
  String ga=releaseId.getGroupId() + ":" + releaseId.getArtifactId();
  TreeMap<ComparableVersion,KieModule> artifactMap=kieModules.get(ga);
  if (artifactMap == null) {
    return null;
  }
  if (versionRange.fixed) {
    KieModule kieModule=artifactMap.get(new ComparableVersion(releaseId.getVersion()));
    if (kieModule != null && releaseId.isSnapshot()) {
      String oldSnapshotVersion=((ReleaseIdImpl)kieModule.getReleaseId()).getSnapshotVersion();
      String currentSnapshotVersion=kieScanner.getArtifactVersion(releaseId);
      if (oldSnapshotVersion != null && currentSnapshotVersion != null && new ComparableVersion(currentSnapshotVersion).compareTo(new ComparableVersion(oldSnapshotVersion)) > 0) {
        return null;
      }
    }
    return kieModule;
  }
  if (versionRange.upperBound == null) {
    return artifactMap.lastEntry().getValue();
  }
  Map.Entry<ComparableVersion,KieModule> entry=versionRange.upperInclusive ? artifactMap.ceilingEntry(new ComparableVersion(versionRange.upperBound)) : artifactMap.lowerEntry(new ComparableVersion(versionRange.upperBound));
  if (entry == null) {
    return null;
  }
  if (versionRange.lowerBound == null) {
    return entry.getValue();
  }
  int versionComparison=entry.getKey().compareTo(new ComparableVersion(versionRange.lowerBound));
  return versionComparison > 0 || (versionComparison == 0 && versionRange.lowerInclusive) ? entry.getValue() : null;
}
