{
  String header="package org.drools.test;\n";
  header+="import java.util.List;\n";
  header+="import org.drools.compiler.Person\n";
  header+="import org.drools.compiler.Cheese\n";
  header+="global Cheese cheese;\n";
  header+="global Person person;\n";
  header+="global java.util.List list;\n";
  String rule1="rule \"not person then cheese\"\n";
  rule1+="when \n";
  rule1+="    not Person() \n";
  rule1+="then \n";
  rule1+="    if (list.size() < 3) { \n";
  rule1+="        list.add(new Integer(0)); \n";
  rule1+="        insertLogical( cheese ); \n" + "    }\n";
  rule1+="    drools.halt();\n" + "end\n";
  String rule2="rule \"if cheese then person\"\n";
  rule2+="when\n";
  rule2+="    Cheese()\n";
  rule2+="then\n";
  rule2+="    if (list.size() < 3) {\n";
  rule2+="        list.add(new Integer(0));\n";
  rule2+="        insertLogical( person );\n";
  rule2+="    }\n" + "    drools.halt();\n";
  rule2+="end\n";
  final PackageBuilder builder=new PackageBuilder();
  builder.addPackageFromDrl(new StringReader(header + rule1));
  builder.addPackageFromDrl(new StringReader(header + rule2));
  final Package pkg=builder.getPackage();
  final RuleBase ruleBase=RuleBaseFactory.newRuleBase();
  ruleBase.addPackage(pkg);
  StatefulSession session=ruleBase.newStatefulSession();
  final List list=new ArrayList();
  final Person person=new Person("person");
  final Cheese cheese=new Cheese("cheese",0);
  session.setGlobal("cheese",cheese);
  session.setGlobal("person",person);
  session.setGlobal("list",list);
  session.fireAllRules();
  assertEquals(1,list.size());
  session=getSerialisedStatefulSession(session);
  session.fireAllRules();
  assertEquals(2,list.size());
  session=getSerialisedStatefulSession(session);
  session.fireAllRules();
  assertEquals(3,list.size());
  session=getSerialisedStatefulSession(session);
  session.fireAllRules();
  assertEquals(3,list.size());
}
