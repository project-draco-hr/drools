{
  boolean multithread=context.readBoolean();
  long time=context.readLong();
  FactHandleFactory handleFactory=context.ruleBase.newFactHandleFactory(context.readInt(),context.readLong());
  InternalFactHandle initialFactHandle=new DefaultFactHandle(context.readInt(),InitialFactImpl.getInstance(),context.readLong(),null);
  context.handles.put(initialFactHandle.getId(),initialFactHandle);
  long propagationCounter=context.readLong();
  DefaultAgenda agenda=new DefaultAgenda(context.ruleBase,false);
  readAgenda(context,agenda);
  ReteooStatefulSession session=new ReteooStatefulSession(id,context.ruleBase,executor,handleFactory,initialFactHandle,propagationCounter,config,agenda,environment);
  session.setKnowledgeRuntime(new StatefulKnowledgeSessionImpl(session));
  initialFactHandle.setEntryPoint(session.getEntryPoints().get(EntryPoint.DEFAULT.getEntryPointId()));
  if (session.getTimerService() instanceof PseudoClockScheduler) {
    PseudoClockScheduler clock=(PseudoClockScheduler)session.getTimerService();
    clock.advanceTime(time,TimeUnit.MILLISECONDS);
  }
  for (  RuleFlowGroup group : agenda.getRuleFlowGroupsMap().values()) {
    ((RuleFlowGroupImpl)group).setWorkingMemory(session);
  }
  context.wm=session;
  readFactHandles(context);
  readActionQueue(context);
  readTruthMaintenanceSystem(context);
  if (context.marshalProcessInstances && processMarshaller != null) {
    processMarshaller.readProcessInstances(context);
  }
  if (context.marshalWorkItems && processMarshaller != null) {
    processMarshaller.readWorkItems(context);
  }
  if (processMarshaller != null) {
    processMarshaller.readProcessTimers(context);
  }
 else {
    int token;
    while ((token=context.readShort()) == PersisterEnums.DEFAULT_TIMER) {
      InputMarshaller.readTimer(context);
    }
  }
  if (multithread) {
    session.startPartitionManagers();
  }
  return session;
}
