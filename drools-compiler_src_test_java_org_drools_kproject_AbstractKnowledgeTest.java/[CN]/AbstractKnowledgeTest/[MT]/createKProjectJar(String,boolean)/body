{
  KProject kproj=new KProjectImpl();
  kproj.setGroupArtifactVersion(new GroupArtifactVersion("org.test",namespace,"0.1"));
  kproj.setKProjectPath("src/main/resources/");
  kproj.setKBasesPath("src/kbases");
  List<String> files=asList(namespace + "/test1/rule1.drl",namespace + "/test1/rule2.drl");
  KBase kBase1=kproj.newKBase(namespace + ".test1","KBase1").setFiles(files).setAnnotations(asList("@ApplicationScoped; @Inject")).setEqualsBehavior(AssertBehaviorOption.EQUALITY).setEventProcessingMode(EventProcessingOption.STREAM);
  KSession ksession1=kBase1.newKSession(namespace + ".test1","KSession1").setType("stateless").setAnnotations(asList("@ApplicationScoped; @Inject")).setClockType(ClockTypeOption.get("realtime"));
  KSession ksession2=kBase1.newKSession(namespace + ".test1","KSession2").setType("stateful").setAnnotations(asList("@ApplicationScoped; @Inject")).setClockType(ClockTypeOption.get("pseudo"));
  files=asList(namespace + "/test2/rule1.drl",namespace + "/test2/rule2.drl");
  KBase kBase2=kproj.newKBase(namespace + ".test2","KBase2").setFiles(files).setAnnotations(asList("@ApplicationScoped")).setEqualsBehavior(AssertBehaviorOption.IDENTITY).setEventProcessingMode(EventProcessingOption.CLOUD);
  KSession ksession3=kBase2.newKSession(namespace + ".test2","KSession3").setType("stateful").setAnnotations(asList("@ApplicationScoped")).setClockType(ClockTypeOption.get("pseudo"));
  KBase kBase3=kproj.newKBase(namespace + ".test3","KBase3").setFiles(asList(new String[]{})).addInclude(kBase1.getQName()).addInclude(kBase2.getQName()).setAnnotations(asList("@ApplicationScoped")).setEqualsBehavior(AssertBehaviorOption.IDENTITY).setEventProcessingMode(EventProcessingOption.CLOUD);
  KSession ksession4=kBase3.newKSession(namespace + ".test3","KSession4").setType("stateless").setAnnotations(asList("@ApplicationScoped")).setClockType(ClockTypeOption.get("pseudo"));
  MemoryFileSystem mfs=new MemoryFileSystem();
  KProjectChangeLogCommiter.commit(kproj,mfs);
  Folder fld2=mfs.getFolder("META-INF");
  fld2.create();
  File fle2=fld2.getFile("beans.xml");
  fle2.create(new ByteArrayInputStream(generateBeansXML(kproj).getBytes()));
  XStream xstream=new XStream();
  fle2=fld2.getFile("kproject.xml");
  fle2.create(new ByteArrayInputStream(xstream.toXML(kproj).getBytes()));
  String kBase1R1=getRule(namespace + ".test1","rule1");
  String kBase1R2=getRule(namespace + ".test1","rule2");
  String kbase2R1=getRule(namespace + ".test2","rule1");
  String kbase2R2=getRule(namespace + ".test2","rule2");
  String fldKB1=kproj.getKBasesPath() + "/" + kBase1.getQName()+ "/"+ kBase1.getNamespace().replace('.','/');
  String fldKB2=kproj.getKBasesPath() + "/" + kBase2.getQName()+ "/"+ kBase2.getNamespace().replace('.','/');
  mfs.getFolder(fldKB1).create();
  mfs.getFolder(fldKB2).create();
  mfs.getFile(fldKB1 + "/rule1.drl").create(new ByteArrayInputStream(kBase1R1.getBytes()));
  mfs.getFile(fldKB1 + "/rule2.drl").create(new ByteArrayInputStream(kBase1R2.getBytes()));
  mfs.getFile(fldKB2 + "/rule1.drl").create(new ByteArrayInputStream(kbase2R1.getBytes()));
  mfs.getFile(fldKB2 + "/rule2.drl").create(new ByteArrayInputStream(kbase2R2.getBytes()));
  MemoryFileSystem trgMfs=new MemoryFileSystem();
  MemoryFileSystem srcMfs=mfs;
  Folder fld1=trgMfs.getFolder("org/drools/cdi/test");
  fld1.create();
  File fle1=fld1.getFile("KProjectTestClass" + namespace + ".java");
  fle1.create(new ByteArrayInputStream(generateKProjectTestClass(kproj,namespace).getBytes()));
  List<String> inputClasses=new ArrayList<String>();
  inputClasses.add("org/drools/cdi/test/KProjectTestClass" + namespace + ".java");
  final List<String> classes=compile(kproj,srcMfs,trgMfs,inputClasses);
  if (createJar) {
    trgMfs.writeAsJar(fileManager.getRootDirectory(),namespace);
  }
 else {
    writeFs(namespace,trgMfs);
  }
}
