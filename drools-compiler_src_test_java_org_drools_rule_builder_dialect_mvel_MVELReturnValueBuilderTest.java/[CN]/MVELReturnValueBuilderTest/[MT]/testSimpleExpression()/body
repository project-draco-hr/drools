{
  final Package pkg=new Package("pkg1");
  final RuleDescr ruleDescr=new RuleDescr("rule 1");
  PackageBuilder pkgBuilder=new PackageBuilder(pkg);
  final PackageBuilderConfiguration conf=pkgBuilder.getPackageBuilderConfiguration();
  DialectCompiletimeRegistry dialectRegistry=pkgBuilder.getPackageRegistry(pkg.getName()).getDialectCompiletimeRegistry();
  MVELDialect mvelDialect=(MVELDialect)dialectRegistry.getDialect("mvel");
  final InstrumentedBuildContent context=new InstrumentedBuildContent(pkgBuilder,ruleDescr,dialectRegistry,pkg,mvelDialect);
  final InstrumentedDeclarationScopeResolver declarationResolver=new InstrumentedDeclarationScopeResolver();
  final InternalReadAccessor extractor=store.getReader(Cheese.class,"price",getClass().getClassLoader());
  final Pattern patternA=new Pattern(0,new ClassObjectType(int.class));
  final Pattern patternB=new Pattern(1,new ClassObjectType(int.class));
  final Declaration a=new Declaration("a",extractor,patternA);
  final Declaration b=new Declaration("b",extractor,patternB);
  final Map map=new HashMap();
  map.put("a",a);
  map.put("b",b);
  declarationResolver.setDeclarations(map);
  context.setDeclarationResolver(declarationResolver);
  final ReturnValueRestrictionDescr returnValueDescr=new ReturnValueRestrictionDescr("=");
  returnValueDescr.setContent("a + b");
  final MVELReturnValueBuilder builder=new MVELReturnValueBuilder();
  final Declaration[] previousDeclarations=new Declaration[]{a,b};
  final Declaration[] localDeclarations=new Declaration[]{};
  final String[] requiredGlobals=new String[]{};
  final ReturnValueRestriction returnValue=new ReturnValueRestriction(extractor,previousDeclarations,localDeclarations,requiredGlobals,context.getConfiguration().getEvaluatorRegistry().getEvaluator(ValueType.PINTEGER_TYPE,Operator.EQUAL));
  AnalysisResult analysis=context.getDialect().analyzeExpression(context,returnValueDescr,returnValueDescr.getContent(),new BoundIdentifiers(declarationResolver.getDeclarationClasses((Rule)null),new HashMap(),null,Cheese.class));
  context.getBuildStack().push(patternB);
  builder.build(context,analysis.getBoundIdentifiers(),previousDeclarations,localDeclarations,returnValue,returnValueDescr,analysis);
  ((MVELReturnValueExpression)returnValue.getExpression()).compile((MVELDialectRuntimeData)pkgBuilder.getPackageRegistry(pkg.getName()).getDialectRuntimeRegistry().getDialectData("mvel"));
  ContextEntry retValContext=returnValue.createContextEntry();
  final RuleBase ruleBase=RuleBaseFactory.newRuleBase();
  final InternalWorkingMemory wm=(InternalWorkingMemory)ruleBase.newStatefulSession();
  final Cheese stilton=new Cheese("stilton",10);
  final Cheese cheddar=new Cheese("cheddar",10);
  final InternalFactHandle f0=(InternalFactHandle)wm.insert(cheddar);
  LeftTupleImpl tuple=new LeftTupleImpl(f0,null,true);
  final InternalFactHandle f1=(InternalFactHandle)wm.insert(stilton);
  tuple=new LeftTupleImpl(tuple,new RightTuple(f1,null),null,true);
  final Cheese brie=new Cheese("brie",20);
  final InternalFactHandle f2=(InternalFactHandle)wm.insert(brie);
  assertTrue(returnValue.isAllowed(extractor,f2,tuple,wm,retValContext));
  brie.setPrice(18);
  wm.update(f2,brie);
  assertFalse(returnValue.isAllowed(extractor,f2,tuple,wm,retValContext));
}
