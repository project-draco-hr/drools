{
  KieBaseModelImpl kBaseModel=(KieBaseModelImpl)kProject.getKieBaseModel(kBaseName);
  if (kBaseModel == null) {
    throw new RuntimeException("The requested KieBase \"" + kBaseName + "\" does not exist");
  }
  ClassLoader cl=kieProject.getClassLoader();
  InternalKieModule kModule=kieProject.getKieModuleForKBase(kBaseModel.getName());
  Collection<KnowledgePackage> pkgs=kModule.getKnowledgePackagesForKieBase(kBaseModel.getName());
  if (pkgs == null) {
    KnowledgeBuilder kbuilder=buildKnowledgePackages(kBaseModel,kieProject,messages);
    if (kbuilder.hasErrors()) {
      return null;
    }
  }
  pkgs=kModule.getKnowledgePackagesForKieBase(kBaseModel.getName());
  if (kBaseModel.getEventProcessingMode() == EventProcessingOption.CLOUD) {
    for (    KnowledgePackage kpkg : pkgs) {
      if (((KnowledgePackageImp)kpkg).pkg.needsStreamMode()) {
        throw new RuntimeException("The requested KieBase \"" + kBaseName + "\" has been set to run in CLOUD mode but requires features only available in STREAM mode");
      }
    }
  }
  InternalKnowledgeBase kBase=(InternalKnowledgeBase)KnowledgeBaseFactory.newKnowledgeBase(conf != null ? conf : getKnowledgeBaseConfiguration(kBaseModel,cl));
  kBase.addKnowledgePackages(pkgs);
  return kBase;
}
