{
  URLScanner scan=new URLScanner();
  scan.listener=new MockListener();
  File dir=RuleBaseAssemblerTest.getTempDirectory();
  Properties config=new Properties();
  config.setProperty(RuleAgent.LOCAL_URL_CACHE,dir.getPath());
  config.setProperty(RuleAgent.URLS,"http://goo.ber http://wee.waa");
  scan.configure(config);
  scan.httpClient=new IHttpClient(){
    public LastUpdatedPing checkLastUpdated(    URL url) throws IOException {
      LastUpdatedPing ping=new LastUpdatedPing();
      ping.lastUpdated=123;
      ping.responseMessage="200 OK";
      return ping;
    }
    public Package fetchPackage(    URL url) throws IOException {
      if (url.toExternalForm().equals("http://goo.ber")) {
        return new Package("goo.ber");
      }
 else {
        return new Package("wee.waa");
      }
    }
  }
;
  assertNotNull(scan.localCacheFileScanner);
  assertNotNull(scan.localCacheDir);
  RuleBase rb=RuleBaseFactory.newRuleBase();
  PackageProvider.applyChanges(rb,false,scan.loadPackageChanges(),getNilListener());
  assertEquals(2,rb.getPackages().length);
  assertTrue("goo.ber".equals(rb.getPackages()[0].getName()) || "goo.ber".equals(rb.getPackages()[1].getName()));
  assertTrue("wee.waa".equals(rb.getPackages()[0].getName()) || "wee.waa".equals(rb.getPackages()[1].getName()));
  scan.httpClient=new IHttpClient(){
    public LastUpdatedPing checkLastUpdated(    URL url) throws IOException {
      LastUpdatedPing ping=new LastUpdatedPing();
      if (url.toExternalForm().equals("http://wee.waa")) {
        ping.lastUpdated=-1;
        ping.responseMessage="XXX";
      }
 else {
        ping.lastUpdated=123;
        ping.responseMessage="200 OK";
      }
      return ping;
    }
    public Package fetchPackage(    URL url) throws IOException {
      throw new IOException("poo");
    }
  }
;
  rb=RuleBaseFactory.newRuleBase();
  assertEquals(0,rb.getPackages().length);
  PackageProvider.applyChanges(rb,true,scan.loadPackageChanges(),getNilListener());
  assertEquals(2,rb.getPackages().length);
  final boolean[] fetchCalled=new boolean[1];
  fetchCalled[0]=false;
  scan.httpClient=new IHttpClient(){
    public LastUpdatedPing checkLastUpdated(    URL url) throws IOException {
      LastUpdatedPing ping=new LastUpdatedPing();
      ping.lastUpdated=1234;
      ping.responseMessage="200 OK";
      return ping;
    }
    public Package fetchPackage(    URL url) throws IOException {
      fetchCalled[0]=true;
      throw new IOException("poo");
    }
  }
;
  Package[] changes=scan.loadPackageChanges();
  assertEquals(0,changes.length);
  assertEquals(true,fetchCalled[0]);
  assertEquals(2,((MockListener)scan.listener).exceptions.size());
}
