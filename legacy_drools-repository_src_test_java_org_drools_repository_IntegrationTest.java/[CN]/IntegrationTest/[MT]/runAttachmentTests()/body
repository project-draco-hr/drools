{
  RepositoryManager repo=RepositoryFactory.getStatefulRepository();
  byte[] data=new byte[4096];
  Random rand=new Random(System.currentTimeMillis());
  rand.nextBytes(data);
  RuleSetAttachment attachment=new RuleSetAttachment("spreadsheet","something",data,"something.xls");
  attachment.addTag("BLAH");
  repo.save(attachment);
  repo.close();
  repo=RepositoryFactory.getStatefulRepository();
  RuleSetDef ruleSet=new RuleSetDef("Integration attachments 1",null);
  ruleSet.addAttachment(attachment);
  ruleSet.addAttachment(new RuleSetAttachment("nothing","boo",data,"nothing.txt"));
  ruleSet.getVersionInfoWorking().setStatus("draft");
  repo.save(ruleSet);
  repo.close();
  repo=RepositoryFactory.getStatefulRepository();
  ruleSet=repo.loadRuleSet("Integration attachments 1",1);
  assertEquals(2,ruleSet.getAttachments().size());
  ruleSet.createNewVersion("going to remove");
  ruleSet.getVersionInfoWorking().setStatus("latest");
  repo.save(ruleSet);
  assertEquals(2,ruleSet.getVersionInfoWorking().getVersionNumber());
  assertEquals("going to remove",ruleSet.getVersionInfoWorking().getVersionComment());
  assertEquals("latest",ruleSet.getVersionInfoWorking().getStatus());
  ruleSet=repo.loadRuleSet("Integration attachments 1",1);
  assertEquals("draft",ruleSet.getVersionInfoWorking().getStatus());
  RuleSetAttachment at=(RuleSetAttachment)ruleSet.getAttachments().iterator().next();
  ruleSet.removeAttachment(at);
  repo.save(ruleSet);
  ruleSet=repo.loadRuleSet("Integration attachments 1",1);
  assertEquals(1,ruleSet.getAttachments().size());
  ruleSet=repo.loadRuleSet("Integration attachments 1",2);
  assertEquals(2,ruleSet.getAttachments().size());
  repo.close();
  repo=RepositoryFactory.getRepository(new MockUser("Michael"),false);
  ruleSet=repo.loadRuleSet("Integration attachments 1",2);
  assertEquals(2,ruleSet.getAttachments().size());
  ruleSet.addAttachment(new RuleSetAttachment("fdsfds","blah2",data,"nothing.xyz"));
  repo.save(ruleSet);
  ruleSet=repo.loadRuleSet("Integration attachments 1",1);
  assertEquals(1,ruleSet.getAttachments().size());
  ruleSet=repo.loadRuleSet("Integration attachments 1",2);
  assertEquals(3,ruleSet.getAttachments().size());
  RuleSetAttachment att=(RuleSetAttachment)ruleSet.getAttachments().iterator().next();
  repo.checkOutAttachment(att);
  assertEquals(true,att.isCheckedOut());
  repo.checkInAttachment(att);
  assertEquals(false,att.isCheckedOut());
  repo.close();
}
