{
  String xml="";
  xml+="<change-set xmlns='http://anonsvn.jboss.org/repos/labs/labs/jbossrules/trunk/drools-api/src/main/resources/change-set-1.0.0.xsd'>";
  xml+="    <add> ";
  xml+="        <resource source='classpath:pkg/mortgages.pkg' type='PKG' />";
  xml+="    </add> ";
  xml+="</change-set>";
  KnowledgeBase kbase=KnowledgeBaseFactory.newKnowledgeBase();
  KnowledgeAgent kagent=this.createKAgent(kbase,true);
  kagent.applyChangeSet(ResourceFactory.newByteArrayResource(xml.getBytes()));
  this.kbaseUpdated=false;
  assertEquals(1,kagent.getKnowledgeBase().getKnowledgePackages().size());
  Thread.sleep(2000);
  ClassPathResource cpResource=(ClassPathResource)ResourceFactory.newClassPathResource("pkg/mortgages.pkg");
  File f=new File(cpResource.getURL().getFile());
  assertTrue(f.exists());
  long t=System.currentTimeMillis();
  int count=0;
  boolean success=false;
  while (!(success=f.setLastModified(t)) && count < 10) {
    count++;
    System.gc();
    Thread.sleep(100);
  }
  if (!success) {
    fail("Unable to setLastModified");
  }
  this.waitUntilKBaseUpdate();
  assertEquals(1,kagent.getKnowledgeBase().getKnowledgePackages().size());
  kagent.dispose();
}
