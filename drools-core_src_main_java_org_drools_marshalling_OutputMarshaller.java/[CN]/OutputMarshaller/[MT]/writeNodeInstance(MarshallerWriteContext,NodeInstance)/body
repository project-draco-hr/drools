{
  ObjectOutputStream stream=context.stream;
  stream.writeLong(nodeInstance.getId());
  stream.writeLong(nodeInstance.getNodeId());
  if (nodeInstance instanceof RuleSetNodeInstance) {
    stream.writeShort(PersisterEnums.RULE_SET_NODE_INSTANCE);
  }
 else   if (nodeInstance instanceof WorkItemNodeInstance) {
    stream.writeShort(PersisterEnums.WORK_ITEM_NODE_INSTANCE);
    stream.writeLong(((WorkItemNodeInstance)nodeInstance).getWorkItem().getId());
  }
 else   if (nodeInstance instanceof SubProcessNodeInstance) {
    stream.writeShort(PersisterEnums.SUB_PROCESS_NODE_INSTANCE);
    stream.writeLong(((SubProcessNodeInstance)nodeInstance).getProcessInstanceId());
  }
 else   if (nodeInstance instanceof MilestoneNodeInstance) {
    stream.writeShort(PersisterEnums.MILESTONE_NODE_INSTANCE);
  }
 else   if (nodeInstance instanceof TimerNodeInstance) {
    stream.writeShort(PersisterEnums.TIMER_NODE_INSTANCE);
    stream.writeLong(((TimerNodeInstance)nodeInstance).getTimerId());
  }
 else   if (nodeInstance instanceof JoinInstance) {
    stream.writeShort(PersisterEnums.JOIN_NODE_INSTANCE);
    Map<Long,Integer> triggers=((JoinInstance)nodeInstance).getTriggers();
    stream.writeInt(triggers.size());
    for (    Map.Entry<Long,Integer> entry : triggers.entrySet()) {
      stream.writeLong(entry.getKey());
      stream.writeInt(entry.getValue());
    }
  }
 else {
    throw new IllegalArgumentException("Unknown node instance type: " + nodeInstance);
  }
}
