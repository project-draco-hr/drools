{
  RuleBase ruleBase=RuleBaseFactory.newRuleBase();
  Package pkg=new Package("org.drools.test");
  pkg.addProcess(getProcess());
  ruleBase.addPackage(pkg);
  StatefulSession session=ruleBase.newStatefulSession();
  session.getWorkItemManager().registerWorkItemHandler("MyWork",new WorkItemHandler(){
    public void executeWorkItem(    WorkItem workItem,    WorkItemManager manager){
      MemoryPersisterProcessTest.this.workItem=workItem;
    }
    public void abortWorkItem(    WorkItem workItem,    WorkItemManager manager){
    }
  }
);
  InternalProcessInstance processInstance=(InternalProcessInstance)session.startProcess("org.drools.test.TestProcess");
  assertNotNull(workItem);
  MemoryPersister pm=new MemoryPersister(new StatefulSessionSnapshotter(session));
  pm.save();
  session.getWorkItemManager().completeWorkItem(workItem.getId(),null);
  assertEquals(InternalProcessInstance.STATE_COMPLETED,processInstance.getState());
  pm.load();
  processInstance=(InternalProcessInstance)session.getProcessInstance(processInstance.getId());
  assertNotNull(processInstance);
  assertEquals(InternalProcessInstance.STATE_ACTIVE,processInstance.getState());
  session.getWorkItemManager().completeWorkItem(workItem.getId(),null);
  assertEquals(InternalProcessInstance.STATE_COMPLETED,processInstance.getState());
}
