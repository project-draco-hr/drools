{
  KnowledgeBaseConfiguration conf=KnowledgeBaseFactory.newKnowledgeBaseConfiguration();
  conf.setOption(EventProcessingOption.STREAM);
  final KnowledgeBase kbase=loadKnowledgeBase(conf,"test_CEP_SimpleTimeWindow.drl");
  KnowledgeSessionConfiguration sconf=KnowledgeBaseFactory.newKnowledgeSessionConfiguration();
  sconf.setOption(ClockTypeOption.get(ClockType.PSEUDO_CLOCK.getId()));
  StatefulKnowledgeSession wm=createKnowledgeSession(kbase,sconf);
  List results=new ArrayList();
  wm.setGlobal("results",results);
  SessionPseudoClock clock=(SessionPseudoClock)wm.getSessionClock();
  clock.advanceTime(5,TimeUnit.SECONDS);
  EventFactHandle handle1=(EventFactHandle)wm.insert(new OrderEvent("1","customer A",70));
  assertEquals(5000,handle1.getStartTimestamp());
  assertEquals(0,handle1.getDuration());
  wm.fireAllRules();
  assertEquals(1,results.size());
  assertEquals(70,((Number)results.get(0)).intValue());
  clock.advanceTime(10,TimeUnit.SECONDS);
  EventFactHandle handle2=(EventFactHandle)wm.insert(new OrderEvent("2","customer A",60));
  assertEquals(15000,handle2.getStartTimestamp());
  assertEquals(0,handle2.getDuration());
  wm.fireAllRules();
  assertEquals(2,results.size());
  assertEquals(65,((Number)results.get(1)).intValue());
  clock.advanceTime(10,TimeUnit.SECONDS);
  EventFactHandle handle3=(EventFactHandle)wm.insert(new OrderEvent("3","customer A",50));
  assertEquals(25000,handle3.getStartTimestamp());
  assertEquals(0,handle3.getDuration());
  wm.fireAllRules();
  assertEquals(3,results.size());
  assertEquals(60,((Number)results.get(2)).intValue());
  clock.advanceTime(10,TimeUnit.SECONDS);
  EventFactHandle handle4=(EventFactHandle)wm.insert(new OrderEvent("4","customer A",25));
  assertEquals(35000,handle4.getStartTimestamp());
  assertEquals(0,handle4.getDuration());
  wm.fireAllRules();
  assertEquals(3,results.size());
  clock.advanceTime(10,TimeUnit.SECONDS);
  EventFactHandle handle5=(EventFactHandle)wm.insert(new OrderEvent("5","customer A",70));
  assertEquals(45000,handle5.getStartTimestamp());
  assertEquals(0,handle5.getDuration());
  wm.fireAllRules();
  assertEquals(3,results.size());
  clock.advanceTime(10,TimeUnit.SECONDS);
  EventFactHandle handle6=(EventFactHandle)wm.insert(new OrderEvent("6","customer A",115));
  assertEquals(55000,handle6.getStartTimestamp());
  assertEquals(0,handle6.getDuration());
  wm.fireAllRules();
  assertEquals(4,results.size());
  assertEquals(70,((Number)results.get(3)).intValue());
}
