{
  StatefulKnowledgeSession ksession=newWorkingMemory();
  KnowledgeCommandContext context=new KnowledgeCommandContext(new ContextImpl("ksession",null),null,null,ksession,null);
  try {
    ((StatefulKnowledgeSessionImpl)ksession).session.startBatchExecution(new ExecutionResultImpl());
    Object o=((GenericCommand)command).execute(context);
    boolean autoFireAllRules=true;
    if (command instanceof FireAllRulesCommand) {
      autoFireAllRules=false;
    }
 else     if (command instanceof BatchExecutionCommand) {
      for (      Command nestedCmd : ((BatchExecutionCommand)command).getCommands()) {
        if (nestedCmd instanceof FireAllRulesCommand) {
          autoFireAllRules=false;
          break;
        }
      }
    }
    if (autoFireAllRules) {
      ksession.fireAllRules();
    }
    if (command instanceof BatchExecutionCommand) {
      ExecutionResults result=((StatefulKnowledgeSessionImpl)ksession).session.getExecutionResult();
      return (T)result;
    }
 else {
      return (T)o;
    }
  }
  finally {
    ((StatefulKnowledgeSessionImpl)ksession).session.endBatchExecution();
  }
}
