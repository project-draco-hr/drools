{
  StatefulKnowledgeSession ksession=newWorkingMemory();
  KnowledgeCommandContext context=new KnowledgeCommandContext(new ContextImpl("ksession",null),null,null,ksession,null);
  try {
    ((StatefulKnowledgeSessionImpl)ksession).session.startBatchExecution(new ExecutionResultImpl());
    ((GenericCommand)command).execute(context);
    boolean autoFireAllRules=true;
    if (command instanceof FireAllRulesCommand) {
      autoFireAllRules=false;
    }
 else     if (command instanceof BatchExecutionImpl) {
      for (      Command nestedCmd : ((BatchExecutionImpl)command).getCommands()) {
        if (nestedCmd instanceof FireAllRulesCommand) {
          autoFireAllRules=false;
          break;
        }
      }
    }
    if (autoFireAllRules) {
      ksession.fireAllRules();
    }
    ExecutionResults result=((StatefulKnowledgeSessionImpl)ksession).session.getExecutionResult();
    return result;
  }
  finally {
    ((StatefulKnowledgeSessionImpl)ksession).session.endBatchExecution();
  }
}
