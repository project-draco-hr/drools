{
  final KnowledgeBuilder kbuilder=KnowledgeBuilderFactory.newKnowledgeBuilder();
  kbuilder.addPackageFromDrl(getClass().getResource("test_LogicalInsertionsBacking.drl"));
  Collection<KnowledgePackage> kpkgs=kbuilder.getKnowledgePackages();
  KnowledgeBase kbase=KnowledgeBaseFactory.newKnowledgeBase();
  kbase.addKnowledgePackages(kpkgs);
  kbase=SerializationHelper.serializeObject(kbase);
  final StatefulKnowledgeSession session=kbase.newStatefulKnowledgeSession();
  final Cheese cheese1=new Cheese("c",1);
  final Cheese cheese2=new Cheese(cheese1.getType(),1);
  final FactHandle h1=session.insert(cheese1);
  session.fireAllRules();
  Collection<?> list=session.getObjects(new ClassObjectFilter(cheese1.getType().getClass()));
  assertEquals(1,list.size());
  assertEquals(cheese1.getType(),list.iterator().next());
  final FactHandle h2=session.insert(cheese2);
  session.fireAllRules();
  list=session.getObjects(new ClassObjectFilter(cheese1.getType().getClass()));
  assertEquals(1,list.size());
  assertEquals(cheese1.getType(),list.iterator().next());
  assertEquals(3,session.getObjects().size());
  session.retract(h1);
  session.fireAllRules();
  list=session.getObjects(new ClassObjectFilter(cheese1.getType().getClass()));
  assertEquals("cheese-type " + cheese1.getType() + " was retracted, but should not. Backed by cheese2 => type.",1,list.size());
  assertEquals("cheese-type " + cheese1.getType() + " was retracted, but should not. Backed by cheese2 => type.",cheese1.getType(),list.iterator().next());
  session.retract(h2);
  session.fireAllRules();
  list=session.getObjects(new ClassObjectFilter(cheese1.getType().getClass()));
  assertEquals("cheese-type " + cheese1.getType() + " was not retracted, but should have. Neither  cheese1 => type nor cheese2 => type is true.",0,list.size());
}
