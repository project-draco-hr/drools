{
  newPkg.checkValidity();
  Package pkg=(Package)this.pkgs.get(newPkg.getName());
  for (Iterator it=this.workingMemories.keySet().iterator(); it.hasNext(); ) {
    WorkingMemoryImpl workingMemory=(WorkingMemoryImpl)it.next();
    workingMemory.getLock().lock();
  }
  if (pkg != null) {
    mergePackage(pkg,newPkg);
  }
 else {
    this.pkgs.put(newPkg.getName(),newPkg);
  }
  Map newGlobals=newPkg.getGlobals();
  for (Iterator it=newGlobals.keySet().iterator(); it.hasNext(); ) {
    String identifier=(String)it.next();
    Class type=(Class)newGlobals.get(identifier);
    if (this.globals.containsKey(identifier) && !this.globals.get(identifier).equals(type)) {
      throw new PackageIntegrationException(pkg);
    }
  }
  this.globals.putAll(newGlobals);
  Rule[] rules=newPkg.getRules();
  for (int i=0; i < rules.length; ++i) {
    addRule(rules[i]);
  }
  this.packageClassLoader.addClassLoader(newPkg.getPackageCompilationData().getClassLoader());
  for (Iterator it=this.workingMemories.keySet().iterator(); it.hasNext(); ) {
    WorkingMemoryImpl workingMemory=(WorkingMemoryImpl)it.next();
    workingMemory.fireAllRules();
    workingMemory.getLock().unlock();
  }
}
