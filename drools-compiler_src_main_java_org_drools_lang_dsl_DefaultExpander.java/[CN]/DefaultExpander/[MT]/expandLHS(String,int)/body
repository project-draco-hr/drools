{
  final StringBuffer buf=new StringBuffer();
  final String[] lines=lhs.split("\n");
  final String[] expanded=new String[lines.length];
  int lastExpanded=-1;
  int lastPattern=-1;
  for (int i=0; i < lines.length; i++) {
    final String trimmed=lines[i].trim();
    expanded[++lastExpanded]=lines[i];
    if (trimmed.length() == 0 || trimmed.startsWith("#") || trimmed.startsWith("//")) {
    }
 else     if (trimmed.startsWith(">")) {
      expanded[lastExpanded]=lines[i].replaceFirst(">"," ");
    }
 else {
      for (final Iterator it=this.condition.iterator(); it.hasNext(); ) {
        final DSLMappingEntry entry=(DSLMappingEntry)it.next();
        expanded[lastExpanded]=entry.getKeyPattern().matcher(expanded[lastExpanded]).replaceAll(entry.getValuePattern());
      }
      if (lines[i].equals(expanded[lastExpanded])) {
        this.addError(new ExpanderException("Unable to expand: " + lines[i].replaceAll("[\n\r]","").trim(),i + lineOffset));
      }
      if (trimmed.startsWith("-") && (!lines[i].equals(expanded[lastExpanded]))) {
        int lastMatchStart=-1;
        int lastMatchEnd=-1;
        String constraints="";
        if (lastPattern >= 0) {
          final Matcher m2=patternFinder.matcher(expanded[lastPattern]);
          while (m2.find()) {
            lastMatchStart=m2.start();
            lastMatchEnd=m2.end();
            constraints=m2.group(1).trim();
          }
        }
        if (lastMatchStart > -1) {
          expanded[lastPattern]=expanded[lastPattern].substring(0,lastMatchStart) + "( " + constraints+ ((constraints.length() == 0) ? "" : ", ")+ expanded[lastExpanded].trim()+ " )"+ expanded[lastPattern].substring(lastMatchEnd);
        }
 else {
          this.addError(new ExpanderException("No pattern was found to add the constraint to: " + lines[i].trim(),i + lineOffset));
        }
        lastExpanded--;
      }
 else {
        lastPattern=lastExpanded;
      }
    }
  }
  for (int i=0; i <= lastExpanded; i++) {
    buf.append(expanded[i]);
    buf.append("\n");
  }
  return buf.toString();
}
