{
  final Matcher m=finder.matcher(drl);
  final StringBuffer buf=new StringBuffer();
  while (m.find()) {
    final StringBuffer expanded=new StringBuffer();
    final String constr=m.group(1).trim();
    if (constr.startsWith("rule")) {
      String headerFragment=m.group(2);
      expanded.append(headerFragment);
      String lhsFragment=m.group(3);
      expanded.append(this.expandLHS(lhsFragment,countNewlines(headerFragment) + 1));
      String thenFragment=m.group(4);
      expanded.append(thenFragment);
      expanded.append(this.expandRHS(m.group(5),countNewlines(headerFragment + lhsFragment + thenFragment) + 2));
      expanded.append(m.group(6));
      expanded.append("\n");
    }
 else     if (constr.startsWith("query")) {
      String fragment=m.group(7);
      expanded.append(fragment);
      expanded.append(this.expandLHS(m.group(8),countNewlines(fragment) + 1));
      expanded.append(m.group(9));
      expanded.append("\n");
    }
 else {
      this.addError(new ExpanderException("Unable to expand statement: " + constr,0));
    }
    m.appendReplacement(buf,expanded.toString().replaceAll("\\$","\\\\\\$"));
  }
  m.appendTail(buf);
  return buf;
}
