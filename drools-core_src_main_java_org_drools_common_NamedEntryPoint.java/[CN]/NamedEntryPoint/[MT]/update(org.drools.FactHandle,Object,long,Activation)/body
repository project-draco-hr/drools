{
  try {
    this.lock.lock();
    this.ruleBase.readLock();
    this.wm.startOperation();
    this.ruleBase.executeQueuedActions();
    InternalFactHandle handle=(InternalFactHandle)factHandle;
    if (handle.isDisconnected()) {
      handle=this.objectStore.reconnect(factHandle);
    }
    final Object originalObject=handle.getObject();
    if (handle.getEntryPoint() != this) {
      throw new IllegalArgumentException("Invalid Entry Point. You updated the FactHandle on entry point '" + handle.getEntryPoint().getEntryPointId() + "' instead of '"+ getEntryPointId()+ "'");
    }
    final ObjectTypeConf typeConf=this.typeConfReg.getObjectTypeConf(this.entryPoint,object);
    int status=-1;
    if (typeConf.isTMSEnabled()) {
      status=handle.getEqualityKey().getStatus();
    }
    if (handle.getId() == -1 || object == null || (handle.isEvent() && ((EventFactHandle)handle).isExpired())) {
      return;
    }
    if (activation != null) {
      activation.getPropagationContext().releaseResources();
    }
    if (originalObject != object || !AssertBehaviour.IDENTITY.equals(this.ruleBase.getConfiguration().getAssertBehaviour())) {
      this.objectStore.removeHandle(handle);
      handle.setObject(object);
      this.objectStore.addHandle(handle,object);
    }
    if (typeConf.isTMSEnabled()) {
      EqualityKey key=handle.getEqualityKey();
      key.removeFactHandle(handle);
      TruthMaintenanceSystem tms=wm.getTruthMaintenanceSystem();
      if (key.isEmpty()) {
        tms.remove(key);
      }
      key=tms.get(object);
      if (key == null) {
        key=new EqualityKey(handle,status);
        tms.put(key);
      }
 else {
        key.addFactHandle(handle);
      }
      handle.setEqualityKey(key);
    }
    this.handleFactory.increaseFactHandleRecency(handle);
    Rule rule=activation == null ? null : activation.getRule();
    final PropagationContext propagationContext=new PropagationContextImpl(this.wm.getNextPropagationIdCounter(),PropagationContext.MODIFICATION,rule,(activation == null) ? null : activation.getTuple(),handle,this.wm.agenda.getActiveActivations(),this.wm.agenda.getDormantActivations(),entryPoint,mask);
    this.entryPointNode.modifyObject(handle,propagationContext,typeConf,this.wm);
    propagationContext.evaluateActionQueue(this.wm);
    this.wm.workingMemoryEventSupport.fireObjectUpdated(propagationContext,factHandle,originalObject,object,this.wm);
    this.wm.executeQueuedActions();
    if (rule == null) {
      this.wm.getAgenda().unstageActivations();
    }
  }
  finally {
    this.wm.endOperation();
    this.ruleBase.readUnlock();
    this.lock.unlock();
  }
}
