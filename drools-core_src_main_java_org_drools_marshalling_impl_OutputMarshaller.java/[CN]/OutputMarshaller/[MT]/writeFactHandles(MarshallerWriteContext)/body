{
  ObjectOutputStream stream=context.stream;
  InternalWorkingMemory wm=context.wm;
  ObjectMarshallingStrategyStore objectMarshallingStrategyStore=context.objectMarshallingStrategyStore;
  writeInitialFactHandleRightTuples(context);
  ActivationIterator it=ActivationIterator.iterator(wm);
  List<InternalFactHandle> matchFactHandles=new ArrayList<InternalFactHandle>(100);
  for (Activation item=(Activation)it.next(); item != null; item=(Activation)it.next()) {
    matchFactHandles.add(item.getFactHandle());
  }
  context.matchFactHandles=matchFactHandles;
  stream.writeInt(wm.getObjectStore().size() + matchFactHandles.size());
  for (  InternalFactHandle handle : orderFacts(wm.getObjectStore())) {
    writeFactHandle(context,stream,objectMarshallingStrategyStore,handle);
    writeRightTuples(handle,context);
  }
  for (  InternalFactHandle handle : orderFacts(matchFactHandles)) {
    Object object=handle.getObject();
    handle.setObject(null);
    writeFactHandle(context,stream,objectMarshallingStrategyStore,handle);
    handle.setObject(object);
    writeRightTuples(handle,context);
  }
  writeInitialFactHandleLeftTuples(context);
  writeLeftTuples(context);
  writePropagationContexts(context);
  writeActivations(context);
}
