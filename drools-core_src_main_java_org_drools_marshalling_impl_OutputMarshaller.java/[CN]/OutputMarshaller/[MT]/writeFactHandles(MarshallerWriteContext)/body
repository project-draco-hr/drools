{
  ObjectOutputStream stream=context.stream;
  InternalWorkingMemory wm=context.wm;
  ObjectMarshallingStrategyStore objectMarshallingStrategyStore=context.objectMarshallingStrategyStore;
  writeInitialFactHandleRightTuples(context);
  List<InternalFactHandle> matchFactHandles=null;
  if (((InternalAgenda)wm.getAgenda()).isDeclarativeAgenda()) {
    ActivationIterator it=ActivationIterator.iterator(wm);
    matchFactHandles=new ArrayList<InternalFactHandle>(100);
    for (Activation item=(Activation)it.next(); item != null; item=(Activation)it.next()) {
      matchFactHandles.add(item.getFactHandle());
    }
  }
  stream.writeInt(wm.getObjectStore().size() + ((matchFactHandles == null) ? 0 : matchFactHandles.size()));
  for (  InternalFactHandle handle : orderFacts(wm.getObjectStore())) {
    writeFactHandle(context,stream,objectMarshallingStrategyStore,handle);
    writeRightTuples(handle,context);
  }
  if (matchFactHandles != null) {
    for (    InternalFactHandle handle : orderFacts(matchFactHandles)) {
      Object object=handle.getObject();
      handle.setObject(null);
      writeFactHandle(context,stream,objectMarshallingStrategyStore,handle);
      handle.setObject(object);
      writeRightTuples(handle,context);
    }
  }
  writeInitialFactHandleLeftTuples(context);
  writeLeftTuples(context,orderFacts(wm.getObjectStore()));
  if (matchFactHandles != null) {
    stream.writeBoolean(true);
    writeLeftTuples(context,orderFacts(matchFactHandles));
  }
 else {
    stream.writeBoolean(false);
  }
  writePropagationContexts(context);
  writeActivations(context);
}
