{
  newPackage.checkValidity();
  Package pkg=(Package)this.rulesPackages.get(newPackage.getName());
  if (pkg != null) {
    mergePackage(pkg,newPackage);
  }
 else {
    this.rulesPackages.put(newPackage.getName(),newPackage);
  }
  Map newGlobals=newPackage.getGlobals();
  for (Iterator it=newGlobals.keySet().iterator(); it.hasNext(); ) {
    String identifier=(String)it.next();
    Class type=(Class)newGlobals.get(identifier);
    if (this.globalDeclarations.containsKey(identifier) && !this.globalDeclarations.get(identifier).equals(type)) {
      throw new PackageIntegrationException(pkg);
    }
  }
  this.globalDeclarations.putAll(newGlobals);
  Rule[] rules=newPackage.getRules();
  for (int i=0; i < rules.length; ++i) {
    addRule(rules[i]);
  }
}
